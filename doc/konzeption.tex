\documentclass{article}
\usepackage{german}
\usepackage[paper=a4paper,margin=1in]{geometry}
\usepackage[utf8]{inputenc}

\usepackage{textcomp}

\title{trEPR--Messungen: Konzeption der Auswertungsroutinen}
\author{Till Biskup}
\date{\today, $ $Revision$ $}


\def\matlab{\textsf{MATLAB}$^\mbox{\tiny\textregistered}$}
\def\octave{\textsf{GNU Octave}}
\def\robodoc{\textsf{ROBODoc}}
\def\fscii{\texttt{fsc2}}

\newcommand{\func}[1]{\texttt{#1}}

\begin{document}
\maketitle\thispagestyle{empty}

\begin{abstract}
  Die folgenden Ausführungen sind eine kurze Zusammenfassung der Konzeption
  eines Auswertungsprogramms für die Daten aus transienten EPR--Messungen.
  Zunächst werden die grundlegenden Ideen für die Umsetzung kurz aufgeführt,
  anschließend die einzelnen Programmblöcke detaillierter erklärt. Ausgehend von
  dieser Dokumentation sollte es möglich sein, ein entsprechendes Programm in
  \matlab\ zu erstellen. 
\end{abstract}

\begin{small}
\tableofcontents 
\end{small}

\section{Grundsätzliches}

\begin{itemize}
  \item Aufteilung der einzelnen Programmblöcke in einzelne \matlab--Funktionen
  \item Dokumentation jeder einzelnen Funktion (am besten mit \robodoc) \emph{in Englisch}
  \item Interaktive Abfrage von Parametern nicht in den Kernfunktionen, sondern
  in eigenen ``Treiber--Funktionen'' bzw. in einem ```Meta--Skript'', das die 
  einzelnen Funktionen in der richtigen Reihenfolge aufruft
  \item Logging aller Einzelschritte und wichtigen Werte in einer Log--Datei
  (ähnlich einer \textsf{gaussian}--Aus\-gabedatei)\\
  Kann in einem ersten Schritt mit der Funktion \texttt{diary} von
  \matlab/\octave\ realisiert werden (vorausgesetzt im ``Meta--Skript'' sind
  entsprechende zusätzliche Ausgaben programmiert).
  \item Versionsverwaltung (CVS bzw. Subversion) der einzelnen Skripte\\
  Die jeweils aktuelle Fassung aller Dateien (inkl. Dokumentation) liegt auf
  einer Homepage im Internet. Die eigentliche Entwicklungsarbeit an den
  Kernfunktionen (und damit gleichzeitig mit der Versionsverwaltung) beschränkt
  sich auf einen kleinen Benutzerkreis.
  \item ``Meta--Skript'', das auf die einzelnen Funktionen zurückgreift und
  einen Datensatz komplett analysiert (später durch --- in \matlab\
  programmierte --- GUI ersetzbar)
  \item Nach Möglichkeit für die nichtgrafischen Teile (alle Kernfunktionen) Kompatibilität zu
  \octave
\end{itemize}


\section{Kernfunktionen}

Die Funktionalität wird nicht wie bisher durch ein Gesamtprogramm
bereitgestellt, sondern durch mehrere kleine Funktionen (``Kernfunktionen''), die jeweils eine
einzige Aufgabe erfüllen. Diese Kernfunktionen erhalten alle notwendigen
Parameter durch ihren Aufruf, sie enthalten keine Strukturen, die selbst
interaktiv nach solchen Parametern fragen.


\subsection{Rohdaten einlesen}

\begin{description}
  \item[Funktion] Liest die vom Spektrometer kommenden Rohdaten (1D) ein und wandelt
  sie in ein 2D--Array um.
  \item[Übergabe-Parameter] Dateiname, $t$--Dimension, $B_0$--Dimension
  \item[Rückgabewert] 2D--Array
\end{description}

Die Spektrometer--Software (\fscii) schreibt an den Beginn der Daten--Datei
zunächst das Skript, mit dem die Daten aufgenommen wurden (durch ``\%''--Zeichen
auskommentiert für \matlab) und darunter in einer einzigen Spalte (1D) alle
aufgezeichneten Werte.

Gemessen wird für jeden $B_0$--Wert eine Zeitkurve mit einer definierten Zahl
von Werten. Die Zahl der Werte pro Zeitkurve ($t$--Dimension), der Bereich des
durchfahrenen $B_0$--Feldes und dessen Schrittweite ($B_0$--Dimension) werden am
Ende des auskommentierten Bereiches vor den eigentlichen Daten ausgegeben.
Sinnvollerweise werden diese Daten nicht per Hand eingegeben, sondern von hier ausgelesen.

Im Folgenden ist ein Ausschnitt einer solchen Datendatei wiedergegeben. Sehr zur
Vereinfachung des Auslesens trägt die Kennzeichnung der einzelnen Parameter
durch die vorangestellten Bezeichner bei. Unterhalb der Parameter erscheint der
vor der eigentlichen Messung vom Benutzer eingegebene Kommentar.

\vspace{1em}
\hrule
\vspace{-1ex}

\begin{verbatim}
% 
% Number of runs     = 1
% Start field        = 3410.00000 G
% End field          = 3510.00000 G
% Field step width   = 0.500000000 G
% Sensitivity        = 5.00000000 mV/div
% Number of averages = 20
% Time base          = 2.00000000 us/div
% Number of points   = 500
% Trigger position   = 50
% Slice length       = 20.0000000 us
% 
% 9,68455 GHz
% 20 dB
% 274 K
% 460 nm (1/8)
% 
0.000650009918
\end{verbatim}

\vspace{-1ex}
\hrule
\vspace{1em}


\subsection{Reihenfolge anpassen}

\begin{description}
  \item[Funktion] Ordnet die Daten (2D--Array) nach aufsteigendem $B_0$--Wert an
  \item[Übergabe-Parameter] 2D--Array
  \item[Rückgabewert] 2D--Array
\end{description}

Gemessen wird meist symmetrisch: Einmal wird das $B_0$--Feld in aufsteigender,
einmal in absteigender Richtung durchfahren. Zur weiteren Verarbeitung ist es
aber notwendig, daß alle Datensätze in der gleichen Sortierung vorliegen.


\subsection{Akkumulation}

\begin{description}
  \item[Funktion] Aufakkumulation mehrerer Messungen
  \item[Übergabe-Parameter] mehrere 2D--Arrays mit Daten
  \item[Rückgabewert] 2D--Array mit aufakkumulierten Daten
\end{description}

Zur Verbesserung des Signal--Rausch--Abstandes werden mehrere Messungen aufakkumuliert.


\subsection{Offset--Korrektur über Pretrigger--Signal}

\begin{description}
  \item[Funktion] Offset--Korrektur des Signals über die Pretrigger--Zeit
  \item[Übergabe-Parameter] 2D--Array mit Daten, Pretrigger-Zeit
  \item[Rückgabewert] 2D--Array, offset--korrigiert
\end{description}

Langsame Oszillationen oder Drifts (Temperaturschwankungen, Erschütterungen, etc.)
werden durch Abziehen eines Offsets korrigiert. Das Offset wird über die vor dem
Laserpuls aufgenommenen Datenpunkte der Zeitkurve (deren Anzahl steht am Ende
des einleitenden Kommentars der Datendatei) ermittelt.


\subsection{Integration eines 1D--Spektrums ($B_0$)}

\begin{description}
  \item[Funktion] Optimale Integration eines 1D--$B_0$--Spektrums zu einem
  definierten Zeitpunkt $t$
  \item[Übergabe-Parameter] 2D--Array mit Daten, Zeitpunkt $t$, Integrationsbereich
  \item[Rückgabewert] integriertes 1D--Spektrum
\end{description}

Oft werden nicht 2D--Spektren, sondern 1D--$B_0$--Spektren zu festen Zeiten $t$ 
ausgewertet. Für einen verbesserten Signal--Rausch--Abstand wird rund um einen 
gegebenen Zeitpunkt $t$ das Signal aufintegriert. Es gibt ein optimales 
Integrationsintervall innerhalb des vorgegebenen Integrationsbereiches, das den 
Signal--Rausch--Abstand maximiert. Die Funktion optimiert die Integration unter 
den gegebenen Parametern auf dieses optimale Integrationsintervall und gibt das 
geglättete 1D--Spektrum zurück


\subsection{Drift--Korrektur über Dunkelsignal}

\begin{description}
  \item[Funktion] Korrektur der Drift während der Messung mittels der Dunkelsignale
  \item[Übergabe-Parameter] 2D--Array, Anzahl der zu verwendenden 
  Dunkelsignal--Zeitkurven
  \item[Rückgabewert] 2D--Array, drift--korrigiert
\end{description}

Häufig zeigen die Spektren eine Drift über die gesamte Messung. Das ist auch der
Grund für die symmetrische Aufnahme (s.o.). Zur Korrektur dieser Drift werden
zwei (gleich lange) $B_0$--Intervalle am Anfang und Ende des Spektrums
ausgewählt (\emph{per definitionem} kein Signal), gemittelt und diese
Mittelwerte zur Drift--Korrektur verwendet.

Die beiden Korrekturwerte von Anfang und Ende des Spektrums werden gegenläufig
gewichtet: Zu Beginn trägt nur der Mittelwert vom Anfang des Spektrums zur
Driftkorrektur bei, sein Beitrag fällt mit fortschreitendem $B_0$ linear ab,
gleichzeitig steigt der Beitrag des Mittelwertes vom Ende des Spektrums linear
an, um am Ende des Spektrums sein Maximum zu erreichen.


\section{Umsetzung der einzelnen Funktionen}

\subsection{Grundlegendes}

\subsubsection{Aufteilung in einzelne Blöcke}

\matlab\ erlaubt die Deklaration von Funktionen in den sogenannten M--Files. In 
jeder solchen Datei gibt es nur \emph{eine} Haupt--Funktion und berliebig viele 
Unterfunktionen, auf die dann nur die Hauptfunktion (die an erster Stelle in 
der Datei stehen muß) zugreifen kann.


\subsubsection{Logging}

\matlab\ stellt grundsätzlich zwei Möglichkeiten bereit, alle Ausgaben in einer 
separaten Datei zu speichern: über einen Parameter beim Start von \matlab, der
alle Ausgaben in eine dort zu definierende Datei mitschreibt, oder über die
(deutlich komfortablere) Funktion \func{diary}, die als Parameter einen
Dateinamen erwartet.


\subsubsection{Meta--Skript}

Fragt die notwendigen Parameter vom Nutzer ab und stößt die weitere
Datenverarbeitung an.


\subsubsection{Versionsverwaltung}

Via CVS oder Subversion. Jede Funktion gibt bei ihrem Aufruf ihre jeweilige
Revisionsnummer und nach Möglichkeit auch das Datum der Revision aus, um auch im
Nachhinein noch nachvollziehen zu können, welche Version der Funktion bei der
Datenverarbeitung verwendet wurde.


\subsubsection{Dokumentation}

Jede \matlab\--Funktion kann durch Eingabe eines Kommentars direkt hinter der 
Funktions--Deklaration grob dokumentiert werden. Hierher gehören:

\begin{enumerate}
  \item kurze Beschreibung, was die Funktion tut
  \item Eingabe--Parameter (Anzahl, Typ)
  \item Ausgabe--Parameter (Anzahl, Typ)
\end{enumerate}

Eine ausführlichere Dokumentation sollte ebenfalls direkt im Quellcode mittels
\robodoc\ (oder einem anderen Automatisierungs--Tool für Dokumentationen) erfolgen.


\subsection{Kernfunktionen}



\end{document}