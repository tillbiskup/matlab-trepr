function varargout = trEPRgui_infowindow(varargin)
% TREPRGUI_INFOWINDOW Display information to a given dataset.
%
% Normally, this window is called from within the trEPRgui window.
%
% If you have already loaded dataset(s) in the Matlab(tm) workspace, you
% can use the TREPRGUI_INFOWINDOW function to display information about
% that dataset(s).
%
% Usage
%   trEPRgui_infowindow(dataset);
%
%   dataset - cell array or struct
%             contains one or more datasets
%
%   If the datasets get changed, the changes will be saved back to the
%   datasets loaded to the Matlab(tm) workspace. If the function cannot
%   detect the original name of the dataset (e.g., you have specified part
%   of a cell array as input), it will store the modified dataset in the
%   variable "trEPRgui_infowindow_dataset" in the Matlab(tm) workspace.
%
% See also TREPRGUI

% (c) 2011-13, Till Biskup
% 2013-03-01

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Construct the components
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Make GUI effectively a singleton
singleton = trEPRguiGetWindowHandle(mfilename);
if (singleton)
    figure(singleton);
    varargout{1} = singleton;
    return;
end

% Try to get main GUI position
mainGUIHandle = trEPRguiGetWindowHandle();
if ishandle(mainGUIHandle)
    mainGUIPosition = get(mainGUIHandle,'Position');
    guiPosition = [mainGUIPosition(1)+10,mainGUIPosition(2)+10,900,670];
else
    guiPosition = [30,50,900,670];
end

%  Construct the components
hMainFigure = figure('Tag',mfilename,...
    'Visible','off',...
    'Name','trEPR GUI : Info Window',...
    'Units','Pixels',...
    'Position',guiPosition,...
    'Resize','off',...
    'NumberTitle','off', ...
    'KeyPressFcn',@keypress_Callback,...
    'Menu','none','Toolbar','none');

defaultBackground = get(hMainFigure,'Color');
noneditableBackground = [0.92 0.92 0.92];
editableBackground = [1 1 1];
editableWarningBackground = [1 1 0.9];
editableErrorBackground = [1 0.85 0.85];
guiSize = get(hMainFigure,'Position');
guiSize = guiSize([3,4]);
panel_size = 240;
mainPanelWidth = 280;
mainPanelHeight = guiSize(2)-70;
subPanelHeight = guiSize(2)-120;

% Create main controls panels
mp = uipanel('Tag','main_controls_panel',...
    'parent',hMainFigure,...
    'Title','Main controls',...
    'FontUnit','Pixel','Fontsize',12,...
    'FontWeight','bold',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[guiSize(1)-panel_size-40 70 panel_size+20 guiSize(2)-90]);

handle_mp1 = uipanel('Tag','main_panel_dataset_panel',...
    'Parent',mp,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 450 panel_size 100],...
    'Title','Select datasets'...
    );
uicontrol('Tag','main_panel_dataset_listbox',...
    'Style','listbox',...
    'Parent',handle_mp1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 10 panel_size-20 70],...
    'String','',...
    'Callback',{@dataset_listbox_Callback}...
    );
handle_mp2 = uipanel('Tag','main_panel_togglebuttons_panel',...
    'Parent',mp,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 350 panel_size 90],...
    'Title','Select category'...
    );
% Create button group, toggle buttons for switching btw. panels
hButtonGroup = uibuttongroup('Tag','mainButtonGroup',...
    'BackgroundColor',defaultBackground,...
    'Parent',handle_mp2,...
    'BorderType','none',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position', [10 10 panel_size-20 60],...
    'Visible','on',...
    'SelectionChangeFcn',{@tbg_Callback});
tb1 = uicontrol('Tag','general_togglebutton',...
    'Style','Toggle',...
	'Parent', hButtonGroup, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','General',...
    'TooltipString','Show general information about selected dataset',...
    'pos',[0 30 (panel_size-20)/2 30],...
    'Enable','on'...
    );
tb2 = uicontrol('Tag','parameters_togglebutton',...
    'Style','Toggle',...
	'Parent', hButtonGroup, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Parameters',...
    'TooltipString','Show parameters of selected dataset',...
    'pos',[(panel_size-20)/2 30 (panel_size-20)/2 30],...
    'Enable','on'...
    );
tb3 = uicontrol('Tag','history_togglebutton',...
    'Style','Toggle',...
	'Parent', hButtonGroup, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','History',...
    'TooltipString','Access full history of selected dataset',...
    'pos',[0 0 (panel_size-20)/2 30],...
    'Enable','on'...
    );
tb4 = uicontrol('Tag','tools_togglebutton',...
    'Style','Toggle',...
	'Parent', hButtonGroup, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Tools',...
    'TooltipString','Access tools such as reading metafiles and create reports',...
    'pos',[(panel_size-20)/2 0 (panel_size-20)/2 30],...
    'Enable','on'...
    );
handle_mp3 = uipanel('Tag','main_panel_about_panel',...
    'Parent',mp,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 200 panel_size 140],...
    'Title','About the current panel'...
    );
uicontrol('Tag','main_panel_about_text',...
    'Style','text',...
    'parent',handle_mp3,...
    'FontUnit','Pixel','Fontsize',12,...
    'FontAngle','italic',...
    'HorizontalAlignment','Left',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','editable fields',...
    'Position',[10 10 panel_size-20 100]);

handle_mp4 = uipanel('Tag','main_panel_fieldtype_panel',...
    'Parent',mp,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 45 panel_size 145],...
    'Title','Colour codes of fields'...
    );
uipanel('Tag','main_panel_editablebg_panel',...
    'Parent',handle_mp4,...
    'BackgroundColor',editableBackground,...
    'BorderType','none',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 100 20 20],...
    'Title',''...
    );
uicontrol('Tag','main_panel_editablebg_text',...
    'Style','text',...
    'parent',handle_mp4,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','editable fields',...
    'Position',[40 100 panel_size-50 20]);
uipanel('Tag','main_panel_editablebg_panel',...
    'Parent',handle_mp4,...
    'BackgroundColor',editableWarningBackground,...
    'BorderType','none',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 70 20 20],...
    'Title',''...
    );
uicontrol('Tag','main_panel_editablebg_text',...
    'Style','text',...
    'parent',handle_mp4,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','editable, but be CAREFUL!',...
    'Position',[40 70 panel_size-50 20]);
uipanel('Tag','main_panel_editablebg_panel',...
    'Parent',handle_mp4,...
    'BackgroundColor',editableErrorBackground,...
    'BorderType','none',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 40 20 20],...
    'Title',''...
    );
uicontrol('Tag','main_panel_editablebg_text',...
    'Style','text',...
    'parent',handle_mp4,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','editable, wrong/missing value',...
    'Position',[40 40 panel_size-50 20]);
uipanel('Tag','main_panel_noneditablebg_panel',...
    'Parent',handle_mp4,...
    'BackgroundColor',noneditableBackground,...
    'BorderType','none',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 10 20 20],...
    'Title',''...
    );
uicontrol('Tag','main_panel_noneditablebg_text',...
    'Style','text',...
    'parent',handle_mp4,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','not editable fields',...
    'Position',[40 10 panel_size-50 20]);

uicontrol('Tag','help_pushbutton',...
    'Style','pushbutton',...
	'Parent', mp, ...
    'BackgroundColor',defaultBackground,...
    'ForegroundColor',[0 0 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'FontWeight','bold',...
    'String','?',...
    'TooltipString','Display help for how to operate the info GUI',...
    'pos',[panel_size-15 10 25 25],...
    'Enable','on',...
    'Callback',@trEPRgui_info_helpwindow...
    );


% Create (switchable and overlaying) main panels
p1 = uipanel('Tag','general_panel',...
    'parent',hMainFigure,...
    'Title','General information',...
    'FontUnit','Pixel','Fontsize',12,...
    'FontWeight','bold',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[20 20 guiSize(1)-mainPanelWidth-30 guiSize(2)-40]);

p2 = uipanel('Tag','parameter_panel',...
    'parent',hMainFigure,...
    'Title','Parameters of the measurement',...
    'FontUnit','Pixel','Fontsize',12,...
    'FontWeight','bold',...
    'BackgroundColor',defaultBackground,...
    'Visible','off',...
    'Units','pixels',...
    'Position',[20 20 guiSize(1)-mainPanelWidth-30 guiSize(2)-40]);

p3 = uipanel('Tag','history_panel',...
    'parent',hMainFigure,...
    'Title','History',...
    'FontUnit','Pixel','Fontsize',12,...
    'FontWeight','bold',...
    'BackgroundColor',defaultBackground,...
    'Visible','off',...
    'Units','pixels',...
    'Position',[20 20 guiSize(1)-mainPanelWidth-30 guiSize(2)-40]);

p4 = uipanel('Tag','tools_panel',...
    'parent',hMainFigure,...
    'Title','Tools',...
    'FontUnit','Pixel','Fontsize',12,...
    'FontWeight','bold',...
    'BackgroundColor',defaultBackground,...
    'Visible','off',...
    'Units','pixels',...
    'Position',[20 20 guiSize(1)-mainPanelWidth-30 guiSize(2)-40]);

% Controls for p1
p1p1 = uipanel('Tag','general_panel_filename_panel',...
    'parent',p1,...
    'Title','File',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[10 480 mainPanelWidth*2+10 120]);
uicontrol('Tag','general_panel_filepath_text',...
    'Style','text',...
    'parent',p1p1,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Path ',...
    'Position',[10 70 60 20]);
uicontrol('Tag','general_panel_filepath_edit',...
    'Style','edit',...
    'parent',p1p1,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'BackgroundColor',noneditableBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Path to file',...
    'Position',[80 70 mainPanelWidth*2-80 25]);
uicontrol('Tag','general_panel_filename_text',...
    'Style','text',...
    'parent',p1p1,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Name ',...
    'Position',[10 40 60 20]);
uicontrol('Tag','general_panel_filename_edit',...
    'Style','edit',...
    'parent',p1p1,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'BackgroundColor',noneditableBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Filename',...
    'Position',[80 40 mainPanelWidth*2-80 25]);
uicontrol('Tag','general_panel_fileformat_text',...
    'Style','text',...
    'parent',p1p1,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Format ',...
    'Position',[10 10 60 20]);
uicontrol('Tag','general_panel_fileformat_edit',...
    'Style','edit',...
    'parent',p1p1,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'BackgroundColor',noneditableBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','File format',...
    'Position',[80 10 mainPanelWidth*2-80 25]);

p1p2 = uipanel('Tag','general_panel_label_panel',...
    'parent',p1,...
    'Title','Dataset',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[10 410 mainPanelWidth*2+10 60]);
uicontrol('Tag','general_panel_label_text',...
    'Style','text',...
    'parent',p1p2,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Label ',...
    'Position',[10 10 60 20]);
uicontrol('Tag','general_panel_label_edit',...
    'Style','edit',...
    'parent',p1p2,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'BackgroundColor',editableBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','',...
    'Position',[80 10 mainPanelWidth*2-80 25],...
    'Callback',{@general_edit_Callback,'label'}...
    );

p1p3 = uipanel('Tag','general_panel_purpose_panel',...
    'parent',p1,...
    'Title','Purpose of measurement',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[10 300 mainPanelWidth*2+10 100]);
uicontrol('Tag','general_panel_purpose_edit',...
    'Style','edit',...
    'parent',p1p3,...
    'FontUnit','Pixel','Fontsize',12,...
    'FontName','Monospaced',...
    'HorizontalAlignment','Left',...
    'BackgroundColor',editableBackground,...
    'Max',2,'Min',0,...
    'Visible','on',...
    'Units','pixels',...
    'String',{'Purpose of measurement'},...
    'Position',[10 10 mainPanelWidth*2-10 70],...
    'Callback',{@general_edit_Callback,'purpose'});

p1p4 = uipanel('Tag','general_panel_header_panel',...
    'parent',p1,...
    'Title','Header of original file',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[10 120 mainPanelWidth*2+10 170]);
uicontrol('Tag','general_panel_header_edit',...
    'Style','edit',...
    'parent',p1p4,...
    'FontUnit','Pixel','Fontsize',12,...
    'FontName','Monospaced',...
    'HorizontalAlignment','Left',...
    'BackgroundColor',noneditableBackground,...
    'Max',2,'Min',0,...
    'Visible','on',...
    'Units','pixels',...
    'String',{'  1: Header with line numbers','  2: ','  3: '},...
    'Position',[10 10 mainPanelWidth*2-10 140]);

p1p5 = uipanel('Tag','general_panel_comment_panel',...
    'parent',p1,...
    'Title','Comment',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[10 10 mainPanelWidth*2+10 100]);
uicontrol('Tag','general_panel_comment_edit',...
    'Style','edit',...
    'parent',p1p5,...
    'FontUnit','Pixel','Fontsize',12,...
    'FontName','Monospaced',...
    'HorizontalAlignment','Left',...
    'BackgroundColor',editableBackground,...
    'Max',2,'Min',0,...
    'Visible','on',...
    'Units','pixels',...
    'String','Comment',...
    'Position',[10 10 mainPanelWidth*2-10 70],...
    'Callback',{@general_edit_Callback,'comment'});


% Controls for p2
hParameterButtonGroup = uibuttongroup('Tag','parametersButtonGroup',...
    'BackgroundColor',defaultBackground,...
    'Parent',p2,...
    'BorderType','none',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position', [10 mainPanelHeight-30 panel_size-20 30],...
    'Visible','on',...
    'SelectionChangeFcn',{@ptbg_Callback});
uicontrol('Tag','parameter_page1_togglebutton',...
    'Style','Toggle',...
	'Parent', hParameterButtonGroup, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Page 1',...
    'TooltipString','Display parameters for sample, general, transient, field',...
    'pos',[0 0 (panel_size-20)/2 30],...
    'Enable','on'...
    );
uicontrol('Tag','parameter_page2_togglebutton',...
    'Style','Toggle',...
	'Parent', hParameterButtonGroup, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Page 2',...
    'TooltipString','Display parameters for bridge, recorder, laser',...
    'pos',[(panel_size-20)/2 0 (panel_size-20)/2 30],...
    'Enable','on'...
    );
uicontrol('Tag','parameter_page3_togglebutton',...
    'Style','Toggle',...
	'Parent', hParameterButtonGroup, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Page 3',...
    'TooltipString','Display parameters for bridge, recorder, laser',...
    'pos',[(panel_size-20) 0 (panel_size-20)/2 30],...
    'Enable','on'...
    );
p2pp1 = uipanel('Tag','parameter_page1_panel',...
    'parent',p2,...
    'Title','',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'BorderType','none',...
    'Visible','on',...
    'Units','pixels',...
    'Position',[10 10 mainPanelWidth*2+10 mainPanelHeight-50]);
p2pp2 = uipanel('Tag','parameter_page2_panel',...
    'parent',p2,...
    'Title','',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'BorderType','none',...
    'Visible','off',...
    'Units','pixels',...
    'Position',[10 10 mainPanelWidth*2+10 mainPanelHeight-50]);
p2pp3 = uipanel('Tag','parameter_page3_panel',...
    'parent',p2,...
    'Title','',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'BorderType','none',...
    'Visible','off',...
    'Units','pixels',...
    'Position',[10 10 mainPanelWidth*2+10 mainPanelHeight-50]);

p2p1 = uipanel('Tag','parameter_sample_panel',...
    'parent',p2pp1,...
    'Title','Sample',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[0 subPanelHeight-240 mainPanelWidth*2+10 240]);
uicontrol('Tag','parameter_panel_samplename_text',...
    'Style','text',...
    'Parent',p2p1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 190 90 20],...
    'String','Name '...
    );
uicontrol('Tag','parameter_panel_samplename_edit',...
    'Style','edit',...
    'Parent',p2p1,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'Units','Pixels',...
    'Position',[110 190 mainPanelWidth*2-110 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'samplename'}...
    );
uicontrol('Tag','parameter_panel_sampletube_text',...
    'Style','text',...
    'Parent',p2p1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 160 90 20],...
    'String','Tube '...
    );
uicontrol('Tag','parameter_panel_sampletube_edit',...
    'Style','edit',...
    'Parent',p2p1,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'Units','Pixels',...
    'Position',[110 160 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'sampletube'}...
    );
uicontrol('Tag','parameter_panel_sampledescription_text',...
    'Style','text',...
    'Parent',p2p1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 130 90 20],...
    'String','Description '...
    );
uicontrol('Tag','parameter_panel_sampledescription_edit',...
    'Style','edit',...
    'Parent',p2p1,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'FontName','FixedWidth',...
    'HorizontalAlignment','Left',...
    'Units','Pixels',...
    'Position',[110 110 mainPanelWidth*2-110 45],...
    'Max',2,'Min',0,...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'sampledescription'}...
    );
uicontrol('Tag','parameter_panel_samplebuffer_text',...
    'Style','text',...
    'Parent',p2p1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 80 90 20],...
    'String','Buffer '...
    );
uicontrol('Tag','parameter_panel_samplebuffer_edit',...
    'Style','edit',...
    'Parent',p2p1,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'FontName','FixedWidth',...
    'HorizontalAlignment','Left',...
    'Units','Pixels',...
    'Position',[110 60 mainPanelWidth*2-110 45],...
    'Max',2,'Min',0,...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'samplebuffer'}...
    );
uicontrol('Tag','parameter_panel_samplepreparation_text',...
    'Style','text',...
    'Parent',p2p1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 30 90 20],...
    'String','Preparation '...
    );
uicontrol('Tag','parameter_panel_samplepreparation_edit',...
    'Style','edit',...
    'Parent',p2p1,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'FontName','FixedWidth',...
    'HorizontalAlignment','Left',...
    'Units','Pixels',...
    'Position',[110 10 mainPanelWidth*2-110 45],...
    'Max',2,'Min',0,...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'samplepreparation'}...
    );
p2p2 = uipanel('Tag','parameter_general_panel',...
    'parent',p2pp1,...
    'Title','General',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[0 subPanelHeight-430 mainPanelWidth 180]);
uicontrol('Tag','parameter_panel_datestart_text',...
    'Style','text',...
    'Parent',p2p2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 130 90 20],...
    'String','Date (start) '...
    );
uicontrol('Tag','parameter_panel_datestart_edit',...
    'Style','edit',...
    'Parent',p2p2,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 130 mainPanelWidth-120 25],...
    'String','yyyy-mm-dd HH:MM:SS',...
    'Callback',{@parameter_edit_Callback,'datestart'}...
    );
uicontrol('Tag','parameter_panel_dateend_text',...
    'Style','text',...
    'Parent',p2p2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 100 90 20],...
    'String','Date (end) '...
    );
uicontrol('Tag','parameter_panel_dateend_edit',...
    'Style','edit',...
    'Parent',p2p2,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 100 mainPanelWidth-120 25],...
    'String','yyyy-mm-dd HH:MM:SS',...
    'Callback',{@parameter_edit_Callback,'dateend'}...
    );
uicontrol('Tag','parameter_panel_operator_text',...
    'Style','text',...
    'Parent',p2p2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 70 90 20],...
    'String','Operator '...
    );
uicontrol('Tag','parameter_panel_operator_edit',...
    'Style','edit',...
    'Parent',p2p2,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 70 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'operator'}...
    );
uicontrol('Tag','parameter_panel_nruns_text',...
    'Style','text',...
    'Parent',p2p2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 40 90 20],...
    'String','No. of runs '...
    );
uicontrol('Tag','parameter_panel_nruns_edit',...
    'Style','edit',...
    'Parent',p2p2,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 40 mainPanelWidth-120 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'nruns'}...
    );
uicontrol('Tag','parameter_panel_srr_text',...
    'Style','text',...
    'Parent',p2p2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 10 90 20],...
    'String','Shot rep. rate '...
    );
uicontrol('Tag','parameter_panel_shotrepetitionrate_edit',...
    'Style','edit',...
    'Parent',p2p2,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 10 (mainPanelWidth-120)/3*2 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'shotrepetitionrate'}...
    );
uicontrol('Tag','parameter_panel_shotrepetitionrateunit_edit',...
    'Style','edit',...
    'Parent',p2p2,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 10 (mainPanelWidth-120)/3 25],...
    'String','Hz',...
    'Callback',{@parameter_edit_Callback,'shotrepetitionrateunit'}...
    );

p2p3 = uipanel('Tag','parameter_panel_axislabels_panel',...
    'Parent',p2pp1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[mainPanelWidth+10 subPanelHeight-390 mainPanelWidth 140],...
    'Title','Axis labels'...
    );
uicontrol('Tag','parameter_panel_measure_text',...
    'Style','text',...
    'Parent',p2p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 90 (mainPanelWidth-70)/3*2 25],...
    'String','Measure'...
    );
uicontrol('Tag','parameter_panel_unit_text',...
    'Style','text',...
    'Parent',p2p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-70)/3*2 90 (mainPanelWidth-70)/3 25],...
    'String','Unit'...
    );
uicontrol('Tag','parameter_panel_x_text',...
    'Style','text',...
    'Parent',p2p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 70 40 20],...
    'String','x '...
    );
uicontrol('Tag','parameter_panel_xmeasure_edit',...
    'Style','edit',...
    'Parent',p2p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 70 (mainPanelWidth-70)/3*2 25],...
    'String','index',...
    'Callback',{@parameter_edit_Callback,'xmeasure'}...
    );
uicontrol('Tag','parameter_panel_xunit_edit',...
    'Style','edit',...
    'Parent',p2p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-70)/3*2 70 (mainPanelWidth-70)/3 25],...
    'String','points',...
    'Callback',{@parameter_edit_Callback,'xunit'}...
    );
uicontrol('Tag','parameter_panel_y_text',...
    'Style','text',...
    'Parent',p2p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 40 40 20],...
    'String','y '...
    );
uicontrol('Tag','parameter_panel_ymeasure_edit',...
    'Style','edit',...
    'Parent',p2p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 40 (mainPanelWidth-70)/3*2 25],...
    'String','index',...
    'Callback',{@parameter_edit_Callback,'ymeasure'}...
    );
uicontrol('Tag','parameter_panel_yunit_edit',...
    'Style','edit',...
    'Parent',p2p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-70)/3*2 40 (mainPanelWidth-70)/3 25],...
    'String','points',...
    'Callback',{@parameter_edit_Callback,'yunit'}...
    );
uicontrol('Tag','parameter_panel_z_text',...
    'Style','text',...
    'Parent',p2p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 10 40 20],...
    'String','z '...
    );
uicontrol('Tag','parameter_panel_zmeasure_edit',...
    'Style','edit',...
    'Parent',p2p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 10 (mainPanelWidth-70)/3*2 25],...
    'String','index',...
    'Callback',{@parameter_edit_Callback,'zmeasure'}...
    );
uicontrol('Tag','parameter_panel_zunit_edit',...
    'Style','edit',...
    'Parent',p2p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-70)/3*2 10 (mainPanelWidth-70)/3 25],...
    'String','points',...
    'Callback',{@parameter_edit_Callback,'zunit'}...
    );

p2p4 = uipanel('Tag','parameter_temperature_panel',...
    'parent',p2pp1,...
    'Title','Temperature',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[mainPanelWidth+10 subPanelHeight-550 mainPanelWidth 150]);
uicontrol('Tag','parameter_panel_temperature_text',...
    'Style','text',...
    'Parent',p2p4,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 100 90 20],...
    'String','Temperature '...
    );
uicontrol('Tag','parameter_panel_temperature_edit',...
    'Style','edit',...
    'Parent',p2p4,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 100 (mainPanelWidth-120)/3*2 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'temperature'}...
    );
uicontrol('Tag','parameter_panel_temperature_unit_edit',...
    'Style','edit',...
    'Parent',p2p4,...
    'BackgroundColor',editableWarningBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 100 (mainPanelWidth-120)/3 25],...
    'String','K',...
    'Callback',{@parameter_edit_Callback,'temperatureunit'}...
    );
uicontrol('Tag','parameter_panel_temperaturecontroller_text',...
    'Style','text',...
    'Parent',p2p4,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 70 90 20],...
    'String','Controller '...
    );
uicontrol('Tag','parameter_panel_temperaturecontroller_edit',...
    'Style','edit',...
    'Parent',p2p4,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 70 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'temperaturecontroller'}...
    );
uicontrol('Tag','parameter_panel_cryostat_text',...
    'Style','text',...
    'Parent',p2p4,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 40 90 20],...
    'String','Cryostat '...
    );
uicontrol('Tag','parameter_panel_cryostat_edit',...
    'Style','edit',...
    'Parent',p2p4,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 40 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'cryostat'}...
    );
uicontrol('Tag','parameter_panel_cryogen_text',...
    'Style','text',...
    'Parent',p2p4,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 10 90 20],...
    'String','Cryogen '...
    );
uicontrol('Tag','parameter_panel_cryogen_edit',...
    'Style','edit',...
    'Parent',p2p4,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 10 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'cryogen'}...
    );

p2p5 = uipanel('Tag','parameter_panel_spectrometer_panel',...
    'Parent',p2pp1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[0 subPanelHeight-530 mainPanelWidth 90],...
    'Title','Spectrometer'...
    );
uicontrol('Tag','parameter_panel_spectrometername_text',...
    'Style','text',...
    'Parent',p2p5,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 40 90 20],...
    'String','Name '...
    );
uicontrol('Tag','parameter_panel_spectrometername_edit',...
    'Style','edit',...
    'Parent',p2p5,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 40 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'spectrometername'}...
    );
uicontrol('Tag','parameter_panel_spectrometersoftware_text',...
    'Style','text',...
    'Parent',p2p5,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 10 90 20],...
    'String','Software '...
    );
uicontrol('Tag','parameter_panel_spectrometersoftware_edit',...
    'Style','edit',...
    'Parent',p2p5,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 10 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'spectrometersoftware'}...
    );

p2p6 = uipanel('Tag','parameter_field_panel',...
    'parent',p2pp2,...
    'Title','Field',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[0 subPanelHeight-460 mainPanelWidth 460]);
uicontrol('Tag','parameter_panel_fieldpts_text',...
    'Style','text',...
    'Parent',p2p6,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 320 90 20],...
    'String','Dimension '...
    );
uicontrol('Tag','parameter_panel_fieldpts_edit',...
    'Style','edit',...
    'Parent',p2p6,...
    'BackgroundColor',noneditableBackground,...
    'Enable','Inactive',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 410 (mainPanelWidth-120)/3*2 25],...
    'String','0'...
    );
uicontrol('Tag','parameter_panel_fieldpts_unit_edit',...
    'Style','edit',...
    'Parent',p2p6,...
    'BackgroundColor',noneditableBackground,...
    'Enable','Inactive',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 410 (mainPanelWidth-120)/3 25],...
    'String','pt'...
    );
uicontrol('Tag','parameter_panel_fieldstart_text',...
    'Style','text',...
    'Parent',p2p6,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 380 90 20],...
    'String','Start '...
    );
uicontrol('Tag','parameter_panel_fieldstart_edit',...
    'Style','edit',...
    'Parent',p2p6,...
    'BackgroundColor',editableWarningBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 380 (mainPanelWidth-120)/3*2 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'fieldstart'}...
    );
uicontrol('Tag','parameter_panel_fieldstartunit_edit',...
    'Style','edit',...
    'Parent',p2p6,...
    'BackgroundColor',editableWarningBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 380 (mainPanelWidth-120)/3 25],...
    'String','G',...
    'Callback',{@parameter_edit_Callback,'fieldstartunit'}...
    );
uicontrol('Tag','parameter_panel_fieldend_text',...
    'Style','text',...
    'Parent',p2p6,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 350 90 20],...
    'String','End '...
    );
uicontrol('Tag','parameter_panel_fieldend_edit',...
    'Style','edit',...
    'Parent',p2p6,...
    'BackgroundColor',editableWarningBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 350 (mainPanelWidth-120)/3*2 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'fieldend'}...
    );
uicontrol('Tag','parameter_panel_fieldendunit_edit',...
    'Style','edit',...
    'Parent',p2p6,...
    'BackgroundColor',editableWarningBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 350 (mainPanelWidth-120)/3 25],...
    'String','G',...
    'Callback',{@parameter_edit_Callback,'fieldendunit'}...
    );
uicontrol('Tag','parameter_panel_fieldstep_text',...
    'Style','text',...
    'Parent',p2p6,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 320 90 20],...
    'String','Step '...
    );
uicontrol('Tag','parameter_panel_fieldstep_edit',...
    'Style','edit',...
    'Parent',p2p6,...
    'BackgroundColor',editableWarningBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 320 (mainPanelWidth-120)/3*2 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'fieldstep'}...
    );
uicontrol('Tag','parameter_panel_fieldstepunit_edit',...
    'Style','edit',...
    'Parent',p2p6,...
    'BackgroundColor',editableWarningBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 320 (mainPanelWidth-120)/3 25],...
    'String','G',...
    'Callback',{@parameter_edit_Callback,'fieldstepunit'}...
    );
uicontrol('Tag','parameter_panel_fieldsequence_text',...
    'Style','text',...
    'Parent',p2p6,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 290 90 20],...
    'String','Sequence '...
    );
uicontrol('Tag','parameter_panel_fieldsequence_edit',...
    'Style','edit',...
    'Parent',p2p6,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 290 (mainPanelWidth-120) 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'fieldsequence'}...
    );
uicontrol('Tag','parameter_panel_fieldcontroller_text',...
    'Style','text',...
    'Parent',p2p6,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 260 90 20],...
    'String','Controller '...
    );
uicontrol('Tag','parameter_panel_fieldcontroller_edit',...
    'Style','edit',...
    'Parent',p2p6,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 260 (mainPanelWidth-120) 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'fieldcontroller'}...
    );
uicontrol('Tag','parameter_panel_fieldpowersupply_text',...
    'Style','text',...
    'Parent',p2p6,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 230 90 20],...
    'String','Power supply '...
    );
uicontrol('Tag','parameter_panel_fieldpowersupply_edit',...
    'Style','edit',...
    'Parent',p2p6,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 230 (mainPanelWidth-120) 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'fieldpowersupply'}...
    );
uicontrol('Tag','parameter_panel_calibration_text',...
    'Style','text',...
    'Parent',p2p6,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'FontAngle','oblique',...
    'Units','Pixels',...
    'Position',[10 190 mainPanelWidth-20 20],...
    'String','Calibration '...
    );
uicontrol('Tag','parameter_panel_calibrationmethod_text',...
    'Style','text',...
    'Parent',p2p6,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 160 90 20],...
    'String','Method '...
    );
uicontrol('Tag','parameter_panel_fieldcalibrationmethod_popupmenu',...
    'Style','popupmenu',...
    'Parent',p2p6,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 160 (mainPanelWidth-120) 25],...
    'String','Standard|StartEnd',...
    'Callback',{@popupmenu_Callback,'fieldcalibrationmethod'}...
    );
uicontrol('Tag','parameter_panel_fieldprobe_text',...
    'Style','text',...
    'Parent',p2p6,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 130 90 20],...
    'String','Gaussmeter '...
    );
uicontrol('Tag','parameter_panel_fieldprobe_edit',...
    'Style','edit',...
    'Parent',p2p6,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 130 (mainPanelWidth-120) 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'fieldcalibratedprobe'}...
    );

p2p6_1 = uipanel('Tag','parameter_fieldcalibration_standard_panel',...
    'parent',p2p6,...
    'BorderType','None',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[6 5 mainPanelWidth-10 125],...
    'Visible','on');
uicontrol('Tag','parameter_panel_fieldcalibrationstandard_text',...
    'Style','text',...
    'Parent',p2p6_1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[5 95 90 20],...
    'String','Standard '...
    );
uicontrol('Tag','parameter_panel_fieldcalibrationstandard_edit',...
    'Style','edit',...
    'Parent',p2p6_1,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[105 95 (mainPanelWidth-120) 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'fieldcalibrationstandard'}...
    );
uicontrol('Tag','parameter_panel_fieldcalibrationsignalfield_text',...
    'Style','text',...
    'Parent',p2p6_1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[5 65 90 20],...
    'String','Signal field '...
    );
uicontrol('Tag','parameter_panel_fieldcalibrationsignalfield_edit',...
    'Style','edit',...
    'Parent',p2p6_1,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[105 65 (mainPanelWidth-120)/3*2 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'fieldcalibrationsignalfield'}...
    );
uicontrol('Tag','parameter_panel_fieldcalibrationsignalfieldunit_edit',...
    'Style','edit',...
    'Parent',p2p6_1,...
    'BackgroundColor',editableWarningBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[105+(mainPanelWidth-120)/3*2 65 (mainPanelWidth-120)/3 25],...
    'String','G',...
    'Callback',{@parameter_edit_Callback,'fieldcalibrationsignalfieldunit'}...
    );
uicontrol('Tag','parameter_panel_fieldcalibrationmwfrequency_text',...
    'Style','text',...
    'Parent',p2p6_1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[5 35 90 20],...
    'String','MW Frequency '...
    );
uicontrol('Tag','parameter_panel_fieldcalibrationmwfrequency_edit',...
    'Style','edit',...
    'Parent',p2p6_1,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[105 35 (mainPanelWidth-120)/3*2 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'fieldcalibrationmwfrequency'}...
    );
uicontrol('Tag','parameter_panel_fieldcalibrationmwfrequencyunit_edit',...
    'Style','edit',...
    'Parent',p2p6_1,...
    'BackgroundColor',editableWarningBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[105+(mainPanelWidth-120)/3*2 35 (mainPanelWidth-120)/3 25],...
    'String','G',...
    'Callback',{@parameter_edit_Callback,'fieldcalibrationmwfrequencyunit'}...
    );
uicontrol('Tag','parameter_panel_fieldcalibrationdeviation_text',...
    'Style','text',...
    'Parent',p2p6_1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[5 5 90 20],...
    'String','Deviation '...
    );
uicontrol('Tag','parameter_panel_fieldcalibrationdeviation_edit',...
    'Style','edit',...
    'Parent',p2p6_1,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[105 5 (mainPanelWidth-120)/3*2 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'fieldcalibrationdeviation'}...
    );
uicontrol('Tag','parameter_panel_fieldcalibrationdeviationunit_edit',...
    'Style','edit',...
    'Parent',p2p6_1,...
    'BackgroundColor',editableWarningBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[105+(mainPanelWidth-120)/3*2 5 (mainPanelWidth-120)/3 25],...
    'String','G',...
    'Callback',{@parameter_edit_Callback,'fieldcalibrationdeviation'}...
    );

p2p6_2 = uipanel('Tag','parameter_fieldcalibration_startend_panel',...
    'parent',p2p6,...
    'BorderType','none',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[6 5 mainPanelWidth-10 125],...
    'Visible','off');
uicontrol('Tag','parameter_panel_fieldstartcalibrated_text',...
    'Style','text',...
    'Parent',p2p6_2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[5 95 90 20],...
    'String','Calib. start '...
    );
uicontrol('Tag','parameter_panel_fieldstartcalibrated_edit',...
    'Style','edit',...
    'Parent',p2p6_2,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[105 95 (mainPanelWidth-120)/3*2 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'fieldstartcalibrated'}...
    );
uicontrol('Tag','parameter_panel_fieldstartcalibratedunit_edit',...
    'Style','edit',...
    'Parent',p2p6_2,...
    'BackgroundColor',editableWarningBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[105+(mainPanelWidth-120)/3*2 95 (mainPanelWidth-120)/3 25],...
    'String','G',...
    'Callback',{@parameter_edit_Callback,'fieldstartcalibratedunit'}...
    );
uicontrol('Tag','parameter_panel_fieldendcalibrated_text',...
    'Style','text',...
    'Parent',p2p6_2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[5 65 90 20],...
    'String','Calib. end '...
    );
uicontrol('Tag','parameter_panel_fieldendcalibrated_edit',...
    'Style','edit',...
    'Parent',p2p6_2,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[105 65 (mainPanelWidth-120)/3*2 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'fieldendcalibrated'}...
    );
uicontrol('Tag','parameter_panel_fieldendcalibratedunit_edit',...
    'Style','edit',...
    'Parent',p2p6_2,...
    'BackgroundColor',editableWarningBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[105+(mainPanelWidth-120)/3*2 65 (mainPanelWidth-120)/3 25],...
    'String','G',...
    'Callback',{@parameter_edit_Callback,'fieldendcalibratedunit'}...
    );

p2p7 = uipanel('Tag','parameter_bridge_panel',...
    'parent',p2pp2,...
    'Title','Bridge',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[mainPanelWidth+10 subPanelHeight-410 mainPanelWidth 410]);
uicontrol('Tag','parameter_panel_bridgemodel_text',...
    'Style','text',...
    'Parent',p2p7,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 360 90 20],...
    'String','Model '...
    );
uicontrol('Tag','parameter_panel_bridgemodel_edit',...
    'Style','edit',...
    'Parent',p2p7,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 360 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'bridgemodel'}...
    );
uicontrol('Tag','parameter_panel_mwfrequency_text',...
    'Style','text',...
    'Parent',p2p7,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 330 90 20],...
    'String','MW frequency '...
    );
uicontrol('Tag','parameter_panel_mwfrequency_edit',...
    'Style','edit',...
    'Parent',p2p7,...
    'BackgroundColor',editableWarningBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 330 (mainPanelWidth-120)/3*2 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'mwfrequency'}...
    );
uicontrol('Tag','parameter_panel_mwfrequencyunit_edit',...
    'Style','edit',...
    'Parent',p2p7,...
    'BackgroundColor',noneditableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 330 (mainPanelWidth-120)/3 25],...
    'String','GHz'...
    );
uicontrol('Tag','parameter_panel_attenuation_text',...
    'Style','text',...
    'Parent',p2p7,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 300 90 20],...
    'String','Attenuation '...
    );
uicontrol('Tag','parameter_panel_attenuation_edit',...
    'Style','edit',...
    'Parent',p2p7,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 300 (mainPanelWidth-120)/3*2 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'bridgeattenuation'}...
    );
uicontrol('Tag','parameter_panel_attenuationunit_edit',...
    'Style','edit',...
    'Parent',p2p7,...
    'BackgroundColor',noneditableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 300 (mainPanelWidth-120)/3 25],...
    'String','dB'...
    );
uicontrol('Tag','parameter_panel_mwpower_text',...
    'Style','text',...
    'Parent',p2p7,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 270 90 20],...
    'String','Power '...
    );
uicontrol('Tag','parameter_panel_mwpower_edit',...
    'Style','edit',...
    'Parent',p2p7,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 270 (mainPanelWidth-120)/3*2 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'mwpower'}...
    );
uicontrol('Tag','parameter_panel_mwpowerunit_edit',...
    'Style','edit',...
    'Parent',p2p7,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 270 (mainPanelWidth-120)/3 25],...
    'String','mW',...
    'Callback',{@parameter_edit_Callback,'mwpowerunit'}...
    );
uicontrol('Tag','parameter_panel_mwdetection_text',...
    'Style','text',...
    'Parent',p2p7,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 240 90 20],...
    'String','Detection '...
    );
uicontrol('Tag','parameter_panel_mwdetection_edit',...
    'Style','edit',...
    'Parent',p2p7,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 240 (mainPanelWidth-120) 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'mwdetection'}...
    );
uicontrol('Tag','parameter_panel_videoamplifier_text',...
    'Style','text',...
    'Parent',p2p7,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'FontAngle','oblique',...
    'Units','Pixels',...
    'Position',[10 200 mainPanelWidth-20 20],...
    'String','Video amplifier '...
    );
uicontrol('Tag','parameter_panel_bridgebandwidth_text',...
    'Style','text',...
    'Parent',p2p7,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 170 90 20],...
    'String','Bandwidth '...
    );
uicontrol('Tag','parameter_panel_bridgebandwidth_edit',...
    'Style','edit',...
    'Parent',p2p7,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 170 (mainPanelWidth-120)/3*2 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'bridgebandwidth'}...
    );
uicontrol('Tag','parameter_panel_bridgebandwidthunit_edit',...
    'Style','edit',...
    'Parent',p2p7,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 170 (mainPanelWidth-120)/3 25],...
    'String','mW',...
    'Callback',{@parameter_edit_Callback,'bridgebandwidthunit'}...
    );
uicontrol('Tag','parameter_panel_amplification_text',...
    'Style','text',...
    'Parent',p2p7,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 140 90 20],...
    'String','Amplification '...
    );
uicontrol('Tag','parameter_panel_amplification_edit',...
    'Style','edit',...
    'Parent',p2p7,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 140 (mainPanelWidth-120)/3*2 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'videoamplification'}...
    );
uicontrol('Tag','parameter_panel_amplificationunit_edit',...
    'Style','edit',...
    'Parent',p2p7,...
    'BackgroundColor',noneditableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 140 (mainPanelWidth-120)/3 25],...
    'String','dB'...
    );
uicontrol('Tag','parameter_panel_mwcalibration_text',...
    'Style','text',...
    'Parent',p2p7,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'FontAngle','oblique',...
    'Units','Pixels',...
    'Position',[10 100 mainPanelWidth-20 20],...
    'String','Calibration '...
    );
uicontrol('Tag','parameter_panel_mwcalibratedstart_text',...
    'Style','text',...
    'Parent',p2p7,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 70 90 20],...
    'String','Freq. @ start '...
    );
uicontrol('Tag','parameter_panel_mwcalibratedstart_edit',...
    'Style','edit',...
    'Parent',p2p7,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 70 (mainPanelWidth-120)/3*2 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'mwcalibratedstart'}...
    );
uicontrol('Tag','parameter_panel_mwcalibratedstartunit_edit',...
    'Style','edit',...
    'Parent',p2p7,...
    'BackgroundColor',noneditableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 70 (mainPanelWidth-120)/3 25],...
    'String','GHz'...
    );
uicontrol('Tag','parameter_panel_mwcalibratedend_text',...
    'Style','text',...
    'Parent',p2p7,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 40 90 20],...
    'String','Freq. @ end '...
    );
uicontrol('Tag','parameter_panel_mwcalibratedend_edit',...
    'Style','edit',...
    'Parent',p2p7,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 40 (mainPanelWidth-120)/3*2 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'mwcalibratedend'}...
    );
uicontrol('Tag','parameter_panel_mwcalibratedendunit_edit',...
    'Style','edit',...
    'Parent',p2p7,...
    'BackgroundColor',noneditableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 40 (mainPanelWidth-120)/3 25],...
    'String','GHz'...
    );
uicontrol('Tag','parameter_panel_mwcounter_text',...
    'Style','text',...
    'Parent',p2p7,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 10 90 20],...
    'String','Freq. counter '...
    );
uicontrol('Tag','parameter_panel_mwcounter_edit',...
    'Style','edit',...
    'Parent',p2p7,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 10 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'mwcounter'}...
    );

p2p8 = uipanel('Tag','parameter_probehead_panel',...
    'parent',p2pp2,...
    'Title','Probehead',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[mainPanelWidth+10 subPanelHeight-540 mainPanelWidth 120]);
uicontrol('Tag','parameter_panel_probeheadtype_text',...
    'Style','text',...
    'Parent',p2p8,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 70 90 20],...
    'String','Type '...
    );
uicontrol('Tag','parameter_panel_probeheadtype_edit',...
    'Style','edit',...
    'Parent',p2p8,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 70 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'probeheadtype'}...
    );
uicontrol('Tag','parameter_panel_probeheadmodel_text',...
    'Style','text',...
    'Parent',p2p8,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 40 90 20],...
    'String','Model '...
    );
uicontrol('Tag','parameter_panel_probeheadmodel_edit',...
    'Style','edit',...
    'Parent',p2p8,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 40 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'probeheadmodel'}...
    );
uicontrol('Tag','parameter_panel_probeheadcoupling_text',...
    'Style','text',...
    'Parent',p2p8,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 10 90 20],...
    'String','Coupling '...
    );
uicontrol('Tag','parameter_panel_probeheadcoupling_edit',...
    'Style','edit',...
    'Parent',p2p8,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 10 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'probeheadcoupling'}...
    );

p2p9 = uipanel('Tag','parameter_transient_panel',...
    'parent',p2pp3,...
    'Title','Transient',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[0 subPanelHeight-120 mainPanelWidth 120]);
uicontrol('Tag','parameter_panel_npts_text',...
    'Style','text',...
    'Parent',p2p9,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 70 90 20],...
    'String','Dimension '...
    );
uicontrol('Tag','parameter_panel_npts_edit',...
    'Style','edit',...
    'Parent',p2p9,...
    'BackgroundColor',noneditableBackground,...
    'Enable','Inactive',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 70 (mainPanelWidth-120)/3*2 25],...
    'String','0'...
    );
uicontrol('Tag','parameter_panel_npts_unit_edit',...
    'Style','edit',...
    'Parent',p2p9,...
    'BackgroundColor',noneditableBackground,...
    'Enable','Inactive',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 70 (mainPanelWidth-120)/3 25],...
    'String','pt'...
    );
uicontrol('Tag','parameter_panel_triggerposition_text',...
    'Style','text',...
    'Parent',p2p9,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 40 90 20],...
    'String','Trigger pos. '...
    );
uicontrol('Tag','parameter_panel_triggerposition_edit',...
    'Style','edit',...
    'Parent',p2p9,...
    'BackgroundColor',editableWarningBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 40 (mainPanelWidth-120)/3*2 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'triggerposition'}...
    );
uicontrol('Tag','parameter_panel_triggerposition_unit_edit',...
    'Style','edit',...
    'Parent',p2p9,...
    'BackgroundColor',noneditableBackground,...
    'Enable','Inactive',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 40 (mainPanelWidth-120)/3 25],...
    'String','pt'...
    );
uicontrol('Tag','parameter_panel_length_text',...
    'Style','text',...
    'Parent',p2p9,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 10 90 20],...
    'String','Length '...
    );
uicontrol('Tag','parameter_panel_length_edit',...
    'Style','edit',...
    'Parent',p2p9,...
    'BackgroundColor',editableWarningBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 10 (mainPanelWidth-120)/3*2 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'transientlength'}...
    );
uicontrol('Tag','parameter_panel_length_unit_edit',...
    'Style','edit',...
    'Parent',p2p9,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 10 (mainPanelWidth-120)/3 25],...
    'String','us',...
    'Callback',{@parameter_edit_Callback,'transientlengthunit'}...
    );

p2p10 = uipanel('Tag','parameter_background_panel',...
    'parent',p2pp3,...
    'Title','Background',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[0 subPanelHeight-250 mainPanelWidth 120]);
uicontrol('Tag','parameter_panel_backgroundfield_text',...
    'Style','text',...
    'Parent',p2p10,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 70 90 20],...
    'String','Field '...
    );
uicontrol('Tag','parameter_panel_backgroundfield_edit',...
    'Style','edit',...
    'Parent',p2p10,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 70 (mainPanelWidth-120)/3*2 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'backgroundfield'}...
    );
uicontrol('Tag','parameter_panel_backgroundfieldunit_edit',...
    'Style','edit',...
    'Parent',p2p10,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 70 (mainPanelWidth-120)/3 25],...
    'String','G',...
    'Callback',{@parameter_edit_Callback,'backgroundfieldunit'}...
    );
uicontrol('Tag','parameter_panel_backgroundoccurrence_text',...
    'Style','text',...
    'Parent',p2p10,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 40 90 20],...
    'String','Occurrence '...
    );
uicontrol('Tag','parameter_panel_backgroundoccurrence_edit',...
    'Style','edit',...
    'Parent',p2p10,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 40 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'backgroundoccurrence'}...
    );
uicontrol('Tag','parameter_panel_backgroundpolarisation_text',...
    'Style','text',...
    'Parent',p2p10,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 10 90 20],...
    'String','Polarisation '...
    );
uicontrol('Tag','parameter_panel_backgroundpolarisation_edit',...
    'Style','edit',...
    'Parent',p2p10,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 10 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'backgroundpolarisation'}...
    );

p2p11 = uipanel('Tag','parameter_recorder_panel',...
    'parent',p2pp3,...
    'Title','Recorder',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[0 subPanelHeight-500 mainPanelWidth 240]);
uicontrol('Tag','parameter_panel_recordermodel_text',...
    'Style','text',...
    'Parent',p2p11,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 190 90 20],...
    'String','Model '...
    );
uicontrol('Tag','parameter_panel_recordermodel_edit',...
    'Style','edit',...
    'Parent',p2p11,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 190 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'recordermodel'}...
    );
uicontrol('Tag','parameter_panel_averages_text',...
    'Style','text',...
    'Parent',p2p11,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 160 90 20],...
    'String','Averages '...
    );
uicontrol('Tag','parameter_panel_averages_edit',...
    'Style','edit',...
    'Parent',p2p11,...
    'BackgroundColor',editableWarningBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 160 mainPanelWidth-120 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'averages'}...
    );
uicontrol('Tag','parameter_panel_recordercoupling_text',...
    'Style','text',...
    'Parent',p2p11,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 130 90 20],...
    'String','Coupling '...
    );
uicontrol('Tag','parameter_panel_recordercoupling_edit',...
    'Style','edit',...
    'Parent',p2p11,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 130 mainPanelWidth-120 25],...
    'String','',...
    'Callback',{@parameter_edit_Callback,'recordercoupling'}...
    );
uicontrol('Tag','parameter_panel_recorderimpedance_text',...
    'Style','text',...
    'Parent',p2p11,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 100 90 20],...
    'String','Impedance '...
    );
uicontrol('Tag','parameter_panel_recorderimpedance_edit',...
    'Style','edit',...
    'Parent',p2p11,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 100 (mainPanelWidth-120)/3*2 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'recorderimpedance'}...
    );
uicontrol('Tag','parameter_panel_recorderimpedanceunit_edit',...
    'Style','edit',...
    'Parent',p2p11,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 100 (mainPanelWidth-120)/3 25],...
    'String','MOhm',...
    'Callback',{@parameter_edit_Callback,'recorderimpedanceunit'}...
    );
uicontrol('Tag','parameter_panel_timebase_text',...
    'Style','text',...
    'Parent',p2p11,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 70 90 20],...
    'String','Time base '...
    );
uicontrol('Tag','parameter_panel_timebase_edit',...
    'Style','edit',...
    'Parent',p2p11,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 70 (mainPanelWidth-120)/3*2 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'recordertimebase'}...
    );
uicontrol('Tag','parameter_panel_timebaseunit_edit',...
    'Style','edit',...
    'Parent',p2p11,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 70 (mainPanelWidth-120)/3 25],...
    'String','us',...
    'Callback',{@parameter_edit_Callback,'recordertimebaseunit'}...
    );
uicontrol('Tag','parameter_panel_bandwidth_text',...
    'Style','text',...
    'Parent',p2p11,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 40 90 20],...
    'String','Bandwidth '...
    );
uicontrol('Tag','parameter_panel_bandwidth_edit',...
    'Style','edit',...
    'Parent',p2p11,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 40 (mainPanelWidth-120)/3*2 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'recorderbandwidth'}...
    );
uicontrol('Tag','parameter_panel_bandwidthunit_edit',...
    'Style','edit',...
    'Parent',p2p11,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 40 (mainPanelWidth-120)/3 25],...
    'String','MHz',...
    'Callback',{@parameter_edit_Callback,'recorderbandwidthunit'}...
    );
uicontrol('Tag','parameter_panel_sensitivity_text',...
    'Style','text',...
    'Parent',p2p11,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 10 90 20],...
    'String','Sensitivity '...
    );
uicontrol('Tag','parameter_panel_sensitivity_edit',...
    'Style','edit',...
    'Parent',p2p11,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 10 (mainPanelWidth-120)/3*2 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'recordersensitivity'}...
    );
uicontrol('Tag','parameter_panel_sensitivity_unit_edit',...
    'Style','edit',...
    'Parent',p2p11,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 10 (mainPanelWidth-120)/3 25],...
    'String','mV',...
    'Callback',{@parameter_edit_Callback,'recordersensitivityunit'}...
    );

p2p12 = uipanel('Tag','parameter_laser_panel',...
    'parent',p2pp3,...
    'Title','Light source',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[mainPanelWidth+10 subPanelHeight-340 mainPanelWidth 340]);
uicontrol('Tag','parameter_panel_lasertype_text',...
    'Style','text',...
    'Parent',p2p12,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 290 90 20],...
    'String','Type '...
    );
uicontrol('Tag','parameter_panel_lasertype_edit',...
    'Style','edit',...
    'Parent',p2p12,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 290 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'lasertype'}...
    );
uicontrol('Tag','parameter_panel_lasermodel_text',...
    'Style','text',...
    'Parent',p2p12,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 260 90 20],...
    'String','Model '...
    );
uicontrol('Tag','parameter_panel_lasermodel_edit',...
    'Style','edit',...
    'Parent',p2p12,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 260 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'lasermodel'}...
    );
uicontrol('Tag','parameter_panel_wavelength_text',...
    'Style','text',...
    'Parent',p2p12,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 230 90 20],...
    'String','Wavelength '...
    );
uicontrol('Tag','parameter_panel_wavelength_edit',...
    'Style','edit',...
    'Parent',p2p12,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 230 (mainPanelWidth-120)/3*2 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'laserwavelength'}...
    );
uicontrol('Tag','parameter_panel_wavelengthunit_edit',...
    'Style','edit',...
    'Parent',p2p12,...
    'BackgroundColor',noneditableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 230 (mainPanelWidth-120)/3 25],...
    'String','nm'...
    );
uicontrol('Tag','parameter_panel_repetitionrate_text',...
    'Style','text',...
    'Parent',p2p12,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 200 90 20],...
    'String','Rep. rate '...
    );
uicontrol('Tag','parameter_panel_repetitionrate_edit',...
    'Style','edit',...
    'Parent',p2p12,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 200 (mainPanelWidth-120)/3*2 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'laserrepetitionrate'}...
    );
uicontrol('Tag','parameter_panel_repetitionrateunit_edit',...
    'Style','edit',...
    'Parent',p2p12,...
    'BackgroundColor',noneditableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 200 (mainPanelWidth-120)/3 25],...
    'String','Hz'...
    );
uicontrol('Tag','parameter_panel_laserpower_text',...
    'Style','text',...
    'Parent',p2p12,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 170 90 20],...
    'String','Power '...
    );
uicontrol('Tag','parameter_panel_laserpower_edit',...
    'Style','edit',...
    'Parent',p2p12,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 170 (mainPanelWidth-120)/3*2 25],...
    'String','0',...
    'Callback',{@parameter_edit_Callback,'laserpower'}...
    );
uicontrol('Tag','parameter_panel_laserpowerunit_edit',...
    'Style','edit',...
    'Parent',p2p12,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110+(mainPanelWidth-120)/3*2 170 (mainPanelWidth-120)/3 25],...
    'String','mJ',...
    'Callback',{@parameter_edit_Callback,'laserpowerunit'}...
    );
uicontrol('Tag','parameter_panel_tunable_text',...
    'Style','text',...
    'Parent',p2p12,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'FontAngle','oblique',...
    'Units','Pixels',...
    'Position',[10 130 mainPanelWidth-20 20],...
    'String','Tunable '...
    );
uicontrol('Tag','parameter_panel_tunabletype_text',...
    'Style','text',...
    'Parent',p2p12,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 100 90 20],...
    'String','Type '...
    );
uicontrol('Tag','parameter_panel_tunabletype_edit',...
    'Style','edit',...
    'Parent',p2p12,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 100 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'tunabletype'}...
    );
uicontrol('Tag','parameter_panel_tunablemodel_text',...
    'Style','text',...
    'Parent',p2p12,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 70 90 20],...
    'String','Model '...
    );
uicontrol('Tag','parameter_panel_tunablemodel_edit',...
    'Style','edit',...
    'Parent',p2p12,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 70 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'tunablemodel'}...
    );
uicontrol('Tag','parameter_panel_tunabledye_text',...
    'Style','text',...
    'Parent',p2p12,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 40 90 20],...
    'String','Dye '...
    );
uicontrol('Tag','parameter_panel_tunabledye_edit',...
    'Style','edit',...
    'Parent',p2p12,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 40 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'tunabledye'}...
    );
uicontrol('Tag','parameter_panel_tunableposition_text',...
    'Style','text',...
    'Parent',p2p12,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 10 90 20],...
    'String','Position '...
    );
uicontrol('Tag','parameter_panel_tunableposition_edit',...
    'Style','edit',...
    'Parent',p2p12,...
    'BackgroundColor',editableBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[110 10 mainPanelWidth-120 25],...
    'String','N/A',...
    'Callback',{@parameter_edit_Callback,'tunableposition'}...
    );


% Controls for p3
p3p1 = uipanel('Tag','history_panel_records_panel',...
    'parent',p3,...
    'Title','History record',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[10 500 mainPanelWidth 100]);
uicontrol('Tag','history_panel_records_listbox',...
    'Style','listbox',...
    'Parent',p3p1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 10 mainPanelWidth-20 70],...
    'String','',...
    'Callback',{@history_listbox_Callback}...
    );

p3p2 = uipanel('Tag','history_panel_summary_panel',...
    'parent',p3,...
    'Title','Summary',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[10+mainPanelWidth+10 500 mainPanelWidth 100]);
uicontrol('Tag','history_panel_datelabel_text',...
    'Style','text',...
    'parent',p3p2,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Date: ',...
    'Position',[10 50 70 20]);
uicontrol('Tag','history_panel_date_text',...
    'Style','text',...
    'parent',p3p2,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','xxxx-xx-xx ##:##:##',...
    'Position',[85 50 panel_size-75 20]);
uicontrol('Tag','history_panel_methodlabel_text',...
    'Style','text',...
    'parent',p3p2,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Method: ',...
    'Position',[10 30 70 20]);
uicontrol('Tag','history_panel_method_text',...
    'Style','text',...
    'parent',p3p2,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Some method name',...
    'Position',[85 30 panel_size-75 20]);
uicontrol('Tag','history_panel_operatorlabel_text',...
    'Style','text',...
    'parent',p3p2,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Operator: ',...
    'Position',[10 10 70 20]);
uicontrol('Tag','history_panel_operator_text',...
    'Style','text',...
    'parent',p3p2,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Some operator name',...
    'Position',[85 10 panel_size-75 20]);

p3p3 = uipanel('Tag','history_panel_system_panel',...
    'parent',p3,...
    'Title','System',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[10 390 mainPanelWidth*2+10 100]);
uicontrol('Tag','history_panel_platformlabel_text',...
    'Style','text',...
    'parent',p3p3,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Platform: ',...
    'Position',[10 50 115 20]);
uicontrol('Tag','history_panel_platform_text',...
    'Style','text',...
    'parent',p3p3,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String',platform,...
    'Position',[130 50 (mainPanelWidth*2)-130 20]);
uicontrol('Tag','history_panel_matlabversionlabel_text',...
    'Style','text',...
    'parent',p3p3,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Matlab version: ',...
    'Position',[10 30 115 20]);
uicontrol('Tag','history_panel_matlabversion_text',...
    'Style','text',...
    'parent',p3p3,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String',version,...
    'Position',[130 30 (mainPanelWidth*2)-130 20]);
uicontrol('Tag','history_panel_toolboxversionlabel_text',...
    'Style','text',...
    'parent',p3p3,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Toolbox version: ',...
    'Position',[10 10 115 20]);
uicontrol('Tag','history_panel_toolboxversion_text',...
    'Style','text',...
    'parent',p3p3,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Toolbox version string',...
    'Position',[130 10 (mainPanelWidth*2)-130 20]);

p3p4 = uipanel('Tag','history_panel_display_panel',...
    'parent',p3,...
    'Title','Parameters',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[10 200 mainPanelWidth*2+10 180]);
uicontrol('Tag','history_panel_parameter_edit',...
    'Style','edit',...
    'parent',p3p4,...
    'FontUnit','Pixel','Fontsize',12,...
    'FontName','FixedWidth',...
    'HorizontalAlignment','Left',...
    'BackgroundColor',noneditableBackground,...
    'Max',2,'Min',0,...
    'Visible','on',...
    'Units','pixels',...
    'String','No parameters to display currently',...
    'Position',[10 10 mainPanelWidth*2-10 150]);

p4p5 = uipanel('Tag','history_panel_report_panel',...
    'parent',p3,...
    'Title','Report',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[10 10 mainPanelWidth*2+10 180]);
uicontrol('Tag','history_panel_report_edit',...
    'Style','edit',...
    'parent',p4p5,...
    'FontUnit','Pixel','Fontsize',12,...
    'FontName','FixedWidth',...
    'HorizontalAlignment','Left',...
    'BackgroundColor',noneditableBackground,...
    'Max',2,'Min',0,...
    'Visible','on',...
    'Units','pixels',...
    'String','No information to display currently',...
    'Position',[10 10 mainPanelWidth*2-10 150]);


% Controls for p4
p4p1 = uipanel('Tag','tools_panel_infofileread_panel',...
    'parent',p4,...
    'Title','Info file read',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[10 mainPanelHeight-120 mainPanelWidth 120]);
uicontrol('Tag','tools_panel_infofileread_file_text',...
    'Style','text',...
    'parent',p4p1,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','File ',...
    'Position',[10 70 50 20]...
    );
uicontrol('Tag','tools_panel_infofileread_format_edit',...
    'Style','edit',...
    'parent',p4p1,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'BackgroundColor',noneditableBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Name of Info file',...
    'Position',[70 70 mainPanelWidth-110 25]...
    );
uicontrol('Tag','tools_panel_infofileread_file_pushbutton',...
    'Style','pushbutton',...
	'Parent', p4p1, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','...',...
    'TooltipString','Open file selection dialogue to select file to read',...
    'pos',[mainPanelWidth-35 70 25 25],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'infofilereadfilename'}...
    );
uicontrol('Tag','tools_panel_infofileread_format_text',...
    'Style','text',...
    'parent',p4p1,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Format ',...
    'Position',[10 42 50 20]...
    );
uicontrol('Tag','tools_panel_infofileread_format_popupmenu',...
    'Style','popupmenu',...
    'Parent',p4p1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[70 45 mainPanelWidth-80 20],...
    'String','trEPR Info file|automatic'...
    );
uicontrol('Tag','tools_panel_infofileread_apply_pushbutton',...
    'Style','pushbutton',...
	'Parent', p4p1, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Show',...
    'TooltipString','Show infofile in display below',...
    'pos',[70 10 (mainPanelWidth-80)/2 30],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'infofilereadshow'}...
    );
uicontrol('Tag','tools_panel_infofileread_load_pushbutton',...
    'Style','pushbutton',...
	'Parent', p4p1, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Apply',...
    'TooltipString',sprintf('%s\n%s','Parse contents of loaded infofile',...
    'and apply to currently selected dataset'),...
    'pos',[70+(mainPanelWidth-80)/2 10 (mainPanelWidth-80)/2 30],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'infofilereadapply'}...
    );


p4p2 = uipanel('Tag','tools_panel_infofilewrite_panel',...
    'parent',p4,...
    'Title','Info file write',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[10+mainPanelWidth+10 mainPanelHeight-120 mainPanelWidth 120]);
uicontrol('Tag','tools_panel_infofilewrite_file_text',...
    'Style','text',...
    'parent',p4p2,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','File ',...
    'Position',[10 70 50 20]...
    );
uicontrol('Tag','tools_panel_infofilewrite_format_edit',...
    'Style','edit',...
    'parent',p4p2,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'BackgroundColor',noneditableBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Name of Info file',...
    'Position',[70 70 mainPanelWidth-110 25]...
    );
uicontrol('Tag','tools_panel_infofilewrite_file_pushbutton',...
    'Style','pushbutton',...
	'Parent', p4p2, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','...',...
    'TooltipString','Open file selection dialogue to select file to write to',...
    'pos',[mainPanelWidth-35 70 25 25],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'infofilewritefilename'}...
    );
uicontrol('Tag','tools_panel_infofilewrite_format_text',...
    'Style','text',...
    'parent',p4p2,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Format ',...
    'Position',[10 42 50 20]...
    );
uicontrol('Tag','tools_panel_infofilewrite_format_popupmenu',...
    'Style','popupmenu',...
    'Parent',p4p2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[70 45 mainPanelWidth-80 20],...
    'String','Automatic'...
    );
uicontrol('Tag','tools_panel_infofilewrite_preview_pushbutton',...
    'Style','pushbutton',...
	'Parent', p4p2, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Preview',...
    'TooltipString','Apply whatever',...
    'pos',[70 10 (mainPanelWidth-80)/2 30],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'infofilewritepreview'}...
    );
uicontrol('Tag','tools_panel_infofilewrite_save_pushbutton',...
    'Style','pushbutton',...
	'Parent', p4p2, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Save',...
    'TooltipString','Apply whatever',...
    'pos',[70+(mainPanelWidth-80)/2 10 (mainPanelWidth-80)/2 30],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'infofilewritesave'}...
    );

p4p3 = uipanel('Tag','tools_panel_infofiledisplay_panel',...
    'parent',p4,...
    'Title','Info file display',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[10 mainPanelHeight-330 mainPanelWidth*2+10 200]);
uicontrol('Tag','tools_panel_infofiledisplay_edit',...
    'Style','edit',...
    'parent',p4p3,...
    'FontUnit','Pixel','Fontsize',12,...
    'FontName','Monospaced',...
    'HorizontalAlignment','Left',...
    'BackgroundColor',editableBackground,...
    'Max',2,'Min',0,...
    'Visible','on',...
    'Units','pixels',...
    'String','',...
    'Position',[10 10 mainPanelWidth*2-10 170]);

p4p4 = uipanel('Tag','tools_panel_report_panel',...
    'parent',p4,...
    'Title','Report',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[10 10 mainPanelWidth 250]);
uicontrol('Tag','tools_panel_report_file_text',...
    'Style','text',...
    'parent',p4p4,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','File ',...
    'Position',[10 200 50 20]...
    );
uicontrol('Tag','tools_panel_report_format_edit',...
    'Style','edit',...
    'parent',p4p4,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'BackgroundColor',noneditableBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Filename to save report',...
    'Position',[70 200 mainPanelWidth-110 25]...
    );
uicontrol('Tag','tools_panel_report_file_pushbutton',...
    'Style','pushbutton',...
	'Parent', p4p4, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','...',...
    'TooltipString','Open file selection dialogue to select file to write to',...
    'pos',[mainPanelWidth-35 200 25 25],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'reportfilename'}...
    );
uicontrol('Tag','tools_panel_report_format_text',...
    'Style','text',...
    'parent',p4p4,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String','Format ',...
    'Position',[10 172 50 20]...
    );
uicontrol('Tag','tools_panel_report_format_popupmenu',...
    'Style','popupmenu',...
    'Parent',p4p4,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[70 175 mainPanelWidth-80 20],...
    'String','LaTeX source (ZIP)|LaTeX source (DIR)|PDF'...
    );
uicontrol('Tag','tools_panel_report_load_pushbutton',...
    'Style','pushbutton',...
	'Parent', p4p4, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Write',...
    'TooltipString','Apply whatever',...
    'pos',[70+(mainPanelWidth-80)/2 140 (mainPanelWidth-80)/2 30],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'reportload'}...
    );
uicontrol('Tag','tools_panel_report_text',...
    'Style','text',...
    'parent',p4p4,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'FontAngle','Oblique',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String',{...
    ['And here, in the future some additional controls '...
    'will show up that let you control settings for the reports.']...
    ''...
    'But for the time being, there will be no report functionality.'},...
    'Position',[10 10 mainPanelWidth-20 120]...
    );

p4p5 = uipanel('Tag','tools_panel_lis_panel',...
    'parent',p4,...
    'Title','LIS',...
    'FontUnit','Pixel','Fontsize',12,...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[10+mainPanelWidth+10 10 mainPanelWidth 250]...
    );
uicontrol('Tag','tools_panel_lis_text',...
    'Style','text',...
    'parent',p4p5,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Left',...
    'FontAngle','Oblique',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'String',{...
    ['At some point in the bright and shiny future '...
    'there will be a time when this GUI connects to the LIS '...
    'and therefore solves all your problems with lost lab books '...
    'and forgotten information about data and measurements.']...
    ''...
    ['If you don''t know what that could possibly mean '...
    'simply forget about it. It will anyway not come any time soon.']},...
    'Position',[10 10 mainPanelWidth-20 210]...
    );


%--------------------------------------------
% Create controls for main buttons bottom left
uicontrol('Tag','apply_pushbutton',...
    'Style','pushbutton',...
	'Parent', hMainFigure, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Apply',...
    'TooltipString','Apply changes to currently selected dataset',...
    'pos',[guiSize(1)-panel_size-40 20 (panel_size+20)/3 40],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'Apply'}...
    );
uicontrol('Tag','discard_pushbutton',...
    'Style','pushbutton',...
	'Parent', hMainFigure, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Revert',...
    'TooltipString',sprintf('%s\n%s',...
    'Discard changes for current dataset',...
    'and revert to original settings.'),...
    'pos',[guiSize(1)-((panel_size+20)/3*2)-20 20 (panel_size+20)/3 40],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'Revert'}...
    );
uicontrol('Tag','close_pushbutton',...
    'Style','pushbutton',...
	'Parent', hMainFigure, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Close',...
    'TooltipString','Close Info Window',...
    'pos',[guiSize(1)-((panel_size+20)/3)-20 20 (panel_size+20)/3 40],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'Close'}...
    );


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Initialization tasks
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Store handles in guidata
guidata(hMainFigure,guihandles);

% Create appdata structure
ad = trEPRguiDataStructure('guiappdatastructure');

% Set modified to empty array - as at the beginning, no dataset has
% been modified in terms of its information
ad.control.spectra.modified = [];
% Add additional field "unsaved" for datasets that have been
% changed but not saved (hit "Apply") yet - "saved" means here only
% within the info GUI window. The final transfer to the main GUI
% window is done when the info GUI is closed.
ad.control.spectra.unsaved = [];

setappdata(hMainFigure,'data',ad.data);
setappdata(hMainFigure,'origdata',ad.origdata);
setappdata(hMainFigure,'configuration',ad.configuration);
setappdata(hMainFigure,'control',ad.control);

% Load data from Main GUI
mainGuiWindow = trEPRguiGetWindowHandle();
if (mainGuiWindow)
    admain = getappdata(mainGuiWindow);
    % Check for availability of necessary fields in appdata
    if (isfield(admain,'data') ~= 0)
        ad.data = admain.data;
        setappdata(hMainFigure,'data',ad.data);
        ad.origdata = admain.data;
        setappdata(hMainFigure,'origdata',ad.origdata);
    end
    if (isfield(admain,'control') ~= 0)
        ad.control = admain.control;
        % Move (in)visible -> loaded
        ad.control.spectra.loaded = [ ...
            admain.control.spectra.visible ...
        	admain.control.spectra.invisible ...
            ];
        ad.control.spectra = rmfield(ad.control.spectra,'visible');
        ad.control.spectra = rmfield(ad.control.spectra,'invisible');
        % Set history record cell array to default value
        for m=1:length(ad.control.spectra.loaded)
            ad.control.spectra.history{m} = 0;
            % Set info file cell array to default values
            ad.control.spectra.infoFile{m} = struct(...
                'input',struct(...
                    'name','',...
                    'format',''...
                    ),...
                'output',struct(...
                    'name','',...
                    'format',''...
                    )...
                );
        end
        if isempty(ad.control.spectra.active) || ...
                (ad.control.spectra.active == 0)
            ad.control.spectra.active = 1;
        end
        % Add additional field "unsaved" for datasets that have been
        % changed but not saved (hit "Apply") yet - "saved" means here only
        % within the info GUI window. The final transfer to the main GUI
        % window is done when the info GUI is closed.
        ad.control.spectra.unsaved = [];
        setappdata(hMainFigure,'control',ad.control);
    end
    
    updateDatasets();
    updateGeneralPanel();
    updateParameterPanel();
    updateToolsPanel();
    updateHistoryPanel();
elseif nargin && (isstruct(varargin{1}) || iscell(varargin{1}))
    if isstruct(varargin{1})
        ad.data{1} = varargin{1};
    else
        ad.data = varargin{1};
    end
    ad.origdata = ad.data;
    inputParameterName = inputname(1);
    if isempty(inputParameterName)
        inputParameterName = 'trEPRgui_infowindow_dataset';
    end
    
    ad.control.spectra.loaded = 1:length(ad.data);
    for m=1:length(ad.control.spectra.loaded)
        % If there is no history field, add one
        if ~isfield(ad.data{m},'history')
            ad.data{m}.history = cell(0);
            ad.origdata{m}.history = cell(0);
        end
        % If there is no label, use filename as label
        if isempty(ad.data{m}.label)
            [~,label,~] = fileparts(ad.data{m}.file.name);
            ad.data{m}.label = label;
            ad.origdata{m}.label = label;
        end
        ad.control.spectra.history{m} = 0;
    end
    if isempty(ad.control.spectra.active) || ...
            (ad.control.spectra.active == 0)
        ad.control.spectra.active = 1;
    end
    setappdata(hMainFigure,'data',ad.data);
    setappdata(hMainFigure,'origdata',ad.origdata);
    setappdata(hMainFigure,'control',ad.control);
    
    updateDatasets();
    updateGeneralPanel();
    updateParameterPanel();
    updateToolsPanel();
    updateHistoryPanel();
end

switchPanel('General');

% Make the GUI visible.
set(hMainFigure,'Visible','on');
trEPRmsg('Info GUI window opened.','info');

if (nargout == 1)
    varargout{1} = hMainFigure;
end

% Add keypress function to every element that can have one...
handles = findall(...
    allchild(hMainFigure),'style','pushbutton',...
    '-or','style','togglebutton',...
    '-or','style','edit',...
    '-or','style','listbox',...
    '-or','style','popupmenu');
for m=1:length(handles)
    set(handles(m),'KeyPressFcn',@keypress_Callback);
end

% Temporary "fix": Disable elements of the "Tools" panel
set(allchild(p4p4),'Enable','inactive');
set(allchild(p4p5),'Enable','inactive');

% Get all edit fields that are marked as "Handle carefully"
warningBackgroundEditFields = findall(...
    allchild(hMainFigure),'BackgroundColor',editableWarningBackground);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Callbacks
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


function tbg_Callback(source,~)
    try 
        switchPanel(get(get(source,'SelectedObject'),'String'));
    catch exception
        try
            msgStr = ['An exception occurred in ' ...
                exception.stack(1).name  '.'];
            trEPRmsg(msgStr,'error');
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function ptbg_Callback(source,~)
    try 
        switchParameterPanel(get(get(source,'SelectedObject'),'String'));
    catch exception
        try
            msgStr = ['An exception occurred in ' ...
                exception.stack(1).name  '.'];
            trEPRmsg(msgStr,'error');
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function dataset_listbox_Callback(source,~)
    try
        % Get appdata of main window
        mainWindow = trEPRguiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);
        
        ad.control.spectra.active = ad.control.spectra.loaded(...
            get(source,'Value')...
            );
        
        % Update appdata of main window
        setappdata(mainWindow,'control',ad.control);
        
        % Update panels
        updateGeneralPanel();
        updateParameterPanel();
        updateToolsPanel();
        updateHistoryPanel();
    catch exception
        try
            msgStr = ['An exception occurred in ' ...
                exception.stack(1).name  '.'];
            trEPRmsg(msgStr,'error');
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function general_edit_Callback(source,~,value)
    try
        % If value is empty, restore previous entry and return
        if isempty(get(source,'String'))
            % Update general panel
            updateGeneralPanel();
            return;
        end
        
        % Get appdata from main window
        mainWindow = trEPRguiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);
        
        switch value
            case 'label'
                oldValue = ad.data{ad.control.spectra.active}.label;
                if ~strcmp(oldValue,get(source,'String'))
                    ad.data{ad.control.spectra.active}.label = ...
                        get(source,'String');
                    % If current active spectrum is not labeled "modified", do so
                    if isempty(find(ad.control.spectra.modified==ad.control.spectra.active,1))
                        ad.control.spectra.modified(end+1) = ...
                            ad.control.spectra.active;
                    end
                    % If current active spectrum is not labeled "unsaved", do so
                    if isempty(find(ad.control.spectra.unsaved==ad.control.spectra.active,1))
                        ad.control.spectra.unsaved(end+1) = ...
                            ad.control.spectra.active;
                    end
                end
            case 'purpose'
                oldValue = ad.data{ad.control.spectra.active}.parameters.purpose;
                if length(oldValue') ~= length(get(source,'String')) || ...
                        (iscell(oldValue) && isempty(oldValue)) || ...
                        ~all(strcmp(oldValue',get(source,'String')))
                    ad.data{ad.control.spectra.active}.parameters.purpose = ...
                        get(source,'String');
                    % If current active spectrum is not labeled "modified", do so
                    if isempty(find(ad.control.spectra.modified==ad.control.spectra.active,1))
                        ad.control.spectra.modified(end+1) = ...
                            ad.control.spectra.active;
                    end
                    % If current active spectrum is not labeled "unsaved", do so
                    if isempty(find(ad.control.spectra.unsaved==ad.control.spectra.active,1))
                        ad.control.spectra.unsaved(end+1) = ...
                            ad.control.spectra.active;
                    end
                end
            case 'comment'
                oldValue = ad.data{ad.control.spectra.active}.comment;
                if length(oldValue') ~= length(get(source,'String')) || ...
                        (iscell(oldValue) && isempty(oldValue)) || ...
                        ~all(strcmp(oldValue',get(source,'String')))
                    ad.data{ad.control.spectra.active}.comment = ...
                        transpose(get(source,'String'));
                    % If current active spectrum is not labeled "modified", do so
                    if isempty(find(ad.control.spectra.modified==ad.control.spectra.active,1))
                        ad.control.spectra.modified(end+1) = ...
                            ad.control.spectra.active;
                    end
                    % If current active spectrum is not labeled "unsaved", do so
                    if isempty(find(ad.control.spectra.unsaved==ad.control.spectra.active,1))
                        ad.control.spectra.unsaved(end+1) = ...
                            ad.control.spectra.active;
                    end
                end
            otherwise
                % fallback
                st = dbstack;
                trEPRmsg(...
                    [st.name ' : unknown field "' value '"'],...
                    'warning');
                return;
        end
        
        % Update appdata of main window
        setappdata(mainWindow,'data',ad.data);
        setappdata(mainWindow,'control',ad.control);
        
        % Update parameter panel
        updateGeneralPanel();
        
        % Update dataset list
        updateDatasets();
    catch exception
        try
            msgStr = ['An exception occurred in ' ...
                exception.stack(1).name  '.'];
            trEPRmsg(msgStr,'error');
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end     

function parameter_edit_Callback(source,~,value)
    try
        mainWindow = trEPRguiGetWindowHandle(mfilename);
        % Get appdata from info GUI
        ad = getappdata(mainWindow);

        if isempty(ad.data)
            return;
        end
        
        % Get handles from info GUI
        gh = guidata(mainWindow);
        
        active = ad.control.spectra.active;
        
        % Cell array matching values to data structure
        % The first column contains the value (third input parameter).
        % The second column contains the corresponding field in the
        % parameters part of the data structure.
        % The third column contains the name of a function to apply to the
        % value read from the edit field. Leave empty if none to apply.
        % The fourth column contains an index, in case that the field in
        % the data structure is a vector and a certain field of that is
        % needed.        
        matching = {...
            % Sample panel
            'samplename','sample.name','',''; ...
            'sampletube','sample.tube','',''; ...
            'sampledescription','sample.description','',''; ...
            'samplebuffer','sample.buffer','',''; ...
            'samplepreparation','sample.preparation','',''; ...
            % General panel
            'datestart','parameters.date.start','',''; ...
            'dateend','parameters.date.end','',''; ...
            'operator','parameters.operator','',''; ...
            'nruns','parameters.runs','str2double',''; ...
            'shotrepetitionrate','parameters.shotRepetitionRate.value','str2double','';...
            'shotrepetitionrateunit','parameters.shotRepetitionRate.unit','','';...
            % Temperature panel
            'temperature','parameters.temperature.value','str2double',''; ...
            'temperatureunit','parameters.temperature.unit','',''; ...
            'temperaturecontroller','parameters.temperature.model','','';...
            'cryostat','parameters.temperature.cryostat','','';...
            'cryogen','parameters.temperature.cryogen','','';...
            % Spectrometer panel
            'spectrometername','parameters.spectrometer.name','',''; ...
            'spectrometersoftware','parameters.spectrometer.software','',''; ...
            % Axis labels panel
            'xmeasure','axes.x.measure','',''; ...
            'xunit','axes.x.unit','',''; ...
            'ymeasure','axes.y.measure','',''; ...
            'yunit','axes.y.unit','',''; ...
            'zmeasure','axes.z.measure','',''; ...
            'zunit','axes.z.unit','',''; ...
            % Field panel
            'fieldstart','parameters.field.start.value','str2double',''; ...
            'fieldstartunit','parameters.field.start.unit','',''; ...
            'fieldend','parameters.field.stop.value','str2double',''; ...
            'fieldendunit','parameters.field.stop.unit','',''; ...
            'fieldstep','parameters.field.step.value','str2double',''; ...
            'fieldstepunit','parameters.field.step.unit','',''; ...
            'fieldsequence','parameters.field.sequence','',''; ...
            'fieldcontroller','parameters.field.model','',''; ...
            'fieldstartcalibrated','parameters.field.calibration.start.value','str2double',''; ...
            'fieldstartcalibratedunit','parameters.field.calibration.start.unit','',''; ...
            'fieldendcalibrated','parameters.field.calibration.end.value','str2double',''; ...
            'fieldendcalibratedunit','parameters.field.calibration.end.unit','',''; ...
            'fieldcalibratedprobe','parameters.field.calibration.model','',''; ...
            'fieldcalibrationstandard','parameters.field.calibration.standard','',''; ...
            'fieldcalibrationsignalfield','parameters.field.calibration.signalField.value','str2double',''; ...
            'fieldcalibrationmwfrequency','parameters.field.calibration.MWfrequency.value','str2double',''; ...
            'fieldcalibrationdeviation','parameters.field.calibration.deviation.value','str2double',''; ...
            'fieldpowersupply','parameters.field.powersupply','',''; ...
            % Transient panel
            'triggerposition','parameters.transient.triggerPosition','str2double',''; ...
            'transientlength','parameters.transient.length.value','str2double',''; ...
            'transientlengthunit','parameters.transient.length.unit','',''; ...
            % Background panel
            'backgroundfield','parameters.background.field.value','str2double',''; ...
            'backgroundfieldunit','parameters.background.field.unit','',''; ...
            'backgroundoccurrence','parameters.background.occurrence','@(x)round(str2double(x))',''; ...
            'backgroundpolarisation','parameters.background.polarisation','',''; ...
            % Bridge panel
            'bridgemodel','parameters.bridge.model','',''; ...
            'mwfrequency','parameters.bridge.MWfrequency.value','str2double',''; ...
            'bridgeattenuation','parameters.bridge.attenuation.value','str2double',''; ...
            'mwpower','parameters.bridge.power.value','str2double',''; ...
            'mwpowerunit','parameters.bridge.power.unit','',''; ...
            'mwdetection','parameters.bridge.detection','',''; ...
            'bridgebandwidth','parameters.bridge.bandwidth.value','str2double',''; ...
            'bridgebandwidthunit','parameters.bridge.bandwidth.unit','',''; ...
            'videoamplification','parameters.bridge.amplification.value','str2double',''; ...
            'mwcalibratedstart','parameters.bridge.calibration.start.value','str2double',''; ...
            'mwcalibratedstartunit','parameters.bridge.calibration.start.unit','',''; ...
            'mwcalibratedend','parameters.bridge.calibration.end.value','str2double',''; ...
            'mwcalibratedendunit','parameters.bridge.calibration.end.unit','',''; ...
            'mwcounter','parameters.bridge.calibration.model','',''; ...
            % Probehead panel
            'probeheadtype','parameters.probehead.type','',''; ...
            'probeheadmodel','parameters.probehead.model','',''; ...
            'probeheadcoupling','parameters.probehead.coupling','',''; ...
            % Recorder panel
            'recordermodel','parameters.recorder.model','',''; ...
            'averages','parameters.recorder.averages','str2double',''; ...
            'recordercoupling','parameters.recorder.coupling','',''; ...
            'recorderimpedance','parameters.recorder.impedance.value','str2double',''; ...
            'recorderimpedanceunit','parameters.recorder.impedance.unit','',''; ...
            'recordertimebase','parameters.recorder.timeBase.value','str2double',''; ...
            'recordertimebaseunit','parameters.recorder.timeBase.unit','',''; ...
            'recorderbandwidth','parameters.recorder.bandwidth.value','str2double',''; ...
            'recorderbandwidthunit','parameters.recorder.bandwidth.unit','',''; ...
            'recordersensitivity','parameters.recorder.sensitivity.value','str2double',''; ...
            'recordersensitivityunit','parameters.recorder.sensitivity.unit','',''; ...
            % Laser panel
            'lasertype','parameters.laser.type','',''; ...
            'lasermodel','parameters.laser.model','',''; ...
            'laserwavelength','parameters.laser.wavelength.value','str2double',''; ...
            'laserrepetitionrate','parameters.laser.repetitionRate.value','str2double',''; ...
            'laserpower','parameters.laser.power.value','str2double',''; ...
            'laserpowerunit','parameters.laser.power.unit','',''; ...
            'tunabletype','parameters.laser.tunable.type','',''; ...
            'tunablemodel','parameters.laser.tunable.model','',''; ...
            'tunabledye','parameters.laser.tunable.dye','',''; ...
            'tunableposition','parameters.laser.tunable.position','str2double',''; ...
            };
        
        fieldValue = get(source,'String');
        
        % If fieldValue is not NaN after conversion to numeric, 
        % we are dealing with a number and can replace the comma
        if min(size(fieldValue)) == 1 && ...
            ~any(isnan(str2double(strrep(fieldValue,',','.'))))
            fieldValue = strrep(fieldValue,',','.');
        end
        
        % If value is in matching cell array
        [matches,index] = max(strcmp(value,matching(:,1)));
        if matches
            % Check whether there is some function to apply first
            if ~isempty(matching{index,3})
                fun = str2func(matching{index,3});
                fieldValue = fun(fieldValue);
            end
            % Check whether we should get only a particular element
            if ~isempty(matching{index,4})
                fieldValue = fieldValue(matching{index,4});
            end
            oldFieldValue = getCascadedField(...
                ad.data{ad.control.spectra.active},...
                matching{index,2});
            % Workaround in case that oldFieldValue is an empty cell
            if iscell(oldFieldValue) && isempty(oldFieldValue)
                oldFieldValue = '';
            end
            % Only in case that old and new field value are different,
            % update the field in the data structure and set dataset to
            % modified.
            % The test for notempty of both old and new value is due to
            % that an empty edit field will not reply '', but something as
            % "Empty string: 1-by-0" that does not compare to ''.
            if (iscell(oldFieldValue) && ...
                    ~all(size(oldFieldValue) == size(fieldValue)) ) || ...
                    ~strcmp(fieldValue,oldFieldValue) && ...
                    ~strcmp(fieldValue,'N/A') && ...
                    ~strcmp(fieldValue,'yyyy-mm-dd HH:MM:SS') && ...
                    ~strcmp(fieldValue,'index') && ...
                    ~strcmp(fieldValue,'points') && ...
                    ~(isempty(fieldValue) && isempty(oldFieldValue))
                ad.data{active} = setCascadedField(...
                    ad.data{active},...
                    matching{index,2}, ...
                    fieldValue);
                % If current active spectrum is not labeled "modified", do so
                if isempty(find(ad.control.spectra.modified==active,1))
                    ad.control.spectra.modified(end+1) = active;
                end
                % If current active spectrum is not labeled "unsaved", do so
                if isempty(find(ad.control.spectra.unsaved==active,1))
                    ad.control.spectra.unsaved(end+1) = active;
                end
            end
            % If value is NaN, change colour of field accordingly
            if isnumeric(fieldValue) && isnan(fieldValue)
                set(source,'BackgroundColor',editableErrorBackground);
            elseif find(warningBackgroundEditFields==source)
                set(source,'BackgroundColor',editableWarningBackground);
            else
                set(source,'BackgroundColor',editableBackground);
            end
        end

        % Check for consistency of the values for the magnetic field
        fieldEditFields = [...
            gh.parameter_panel_fieldstart_edit ...
            gh.parameter_panel_fieldend_edit ...
            gh.parameter_panel_fieldstep_edit ...            
            ];
        [y,~] = size(ad.data{active}.data);
        if (length(...
                ad.data{active}.parameters.field.start.value:...
                ad.data{active}.parameters.field.step.value:...
                ad.data{active}.parameters.field.stop.value)~=y)
            for k=1:length(fieldEditFields)
                set(fieldEditFields(k),...
                    'BackgroundColor',editableErrorBackground);
            end
        else
            for k=1:length(fieldEditFields)
                set(fieldEditFields(k),...
                    'BackgroundColor',editableWarningBackground);
            end
            % Set field axis values
            ad.data{active}.axes.y.values = ...
                ad.data{active}.parameters.field.start.value:...
                ad.data{active}.parameters.field.step.value:...
                ad.data{active}.parameters.field.stop.value ;
        end
        
        % Set field value consistently for axes as well
        switch value
            case 'fieldstartunit'
                ad.data{active}.axes.y.unit = ...
                    ad.data{active}.parameters.field.start.unit;
                ad.data{active}.parameters.field.stop.unit = ...
                    ad.data{active}.parameters.field.start.unit;
                ad.data{active}.parameters.field.step.unit = ...
                    ad.data{active}.parameters.field.start.unit;
            case 'fieldstepunit'
                ad.data{active}.axes.y.unit = ...
                    ad.data{active}.parameters.field.step.unit;
                ad.data{active}.parameters.field.start.unit = ...
                    ad.data{active}.parameters.field.step.unit;
                ad.data{active}.parameters.field.stop.unit = ...
                    ad.data{active}.parameters.field.step.unit;
            case 'fieldendunit'
                ad.data{active}.axes.y.unit = ...
                    ad.data{active}.parameters.field.stop.unit;
                ad.data{active}.parameters.field.start.unit = ...
                    ad.data{active}.parameters.field.stop.unit;
                ad.data{active}.parameters.field.step.unit = ...
                    ad.data{active}.parameters.field.stop.unit;
        end
        
        % Set time axis parameters according to new values
        ad.data{active}.axes.x.values = ...
            -ad.data{active}.parameters.transient.length.value/...
            ad.data{active}.parameters.transient.points * ...
            (ad.data{active}.parameters.transient.triggerPosition - 1) : ...
            ad.data{active}.parameters.transient.length.value/...
            ad.data{active}.parameters.transient.points : ...
            ad.data{active}.parameters.transient.length.value - ...
            ad.data{active}.parameters.transient.length.value/...
            ad.data{active}.parameters.transient.points * ...
            ad.data{active}.parameters.transient.triggerPosition;
        
        % Update appdata of main window
        setappdata(mainWindow,'data',ad.data);
        setappdata(mainWindow,'control',ad.control);
        
        % Update parameter panel
        updateParameterPanel();
        
        % Update dataset display
        updateDatasets();
    catch exception
        try
            msgStr = ['An exception occurred in ' ...
                exception.stack(1).name  '.'];
            trEPRmsg(msgStr,'error');
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function history_listbox_Callback(source,~)
    try
        % Get appdata of main window
        mainWindow = trEPRguiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);
        
        ad.control.spectra.history{ad.control.spectra.active} = ... 
            get(source,'Value');
        
        % Update appdata of main window
        setappdata(mainWindow,'control',ad.control);
        
        % Update panels
        updateHistoryPanel();
    catch exception
        try
            msgStr = ['An exception occurred in ' ...
                exception.stack(1).name  '.'];
            trEPRmsg(msgStr,'error');
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function pushbutton_Callback(~,~,action)
    try
        if isempty(action)
            return;
        end
        
        % Get appdata and handles of main window
        mainWindow = trEPRguiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);
        gh = guihandles(mainWindow);

        switch action
            case 'infofilereadfilename'
                % TODO: Make this dependend on the popupmenu for the file
                % type
                if isempty(ad.data)
                    return;
                end
                FilterSpec = '*.info';
                [filePath,~,~] = fileparts(...
                    ad.data{ad.control.spectra.active}.file.name);
                [infoFileName,infoPathName] = uigetfile(...
                    FilterSpec,'Get Info File Name',...
                    'MultiSelect','off',...
                    filePath);
                if ischar(infoFileName)
                    ad.control.spectra.infoFile{...
                        ad.control.spectra.active}.input.name = ...
                        fullfile(infoPathName,infoFileName);
                    setappdata(mainWindow,'control',ad.control);
                    infoFileText = textFileRead(...
                        fullfile(infoPathName,infoFileName),...
                        'LineNumbers',logical(false));
                    set(gh.tools_panel_infofiledisplay_edit,...
                        'String',infoFileText);
                    set(gh.tools_panel_infofileread_format_edit,...
                        'String',infoFileName);
                end
            case 'infofilereadshow'
                if isempty(ad.data)
                    return;
                end
                if isempty(ad.control.spectra.infoFile{...
                        ad.control.spectra.active}.input.name)
                    return;
                end
                infoFileText = textFileRead(ad.control.spectra.infoFile{...
                    ad.control.spectra.active}.input.name,...
                    'LineNumbers',logical(false));
                set(gh.tools_panel_infofiledisplay_edit,...
                    'String',infoFileText);
                [~,fn,ext] = fileparts(ad.control.spectra.infoFile{...
                    ad.control.spectra.active}.input.name);
                set(gh.tools_panel_infofileread_format_edit,...
                    'String',[fn ext]);
            case 'infofilereadapply'
                if isempty(ad.data)
                    return;
                end
                active = ad.control.spectra.active;
                if isempty(ad.control.spectra.infoFile{active}.input.name)
                    return;
                end
                [parameters,warnings] = trEPRinfoFileParse(...
                    ad.control.spectra.infoFile{active}.input.name,'map');
                if isempty(warnings)
                    % Handle situation with MWfrequency parameters
                    if length(ad.data{active}.parameters.bridge.MWfrequency.value) > 1
                        ad.data{active}.parameters.bridge.MWfrequency.values = ...
                            ad.data{active}.parameters.bridge.MWfrequency.value;
                    end
                    ad.data{active} = structcopy(ad.data{active},parameters);
                    setappdata(mainWindow,'data',ad.data);
                    if ~any(ad.control.spectra.unsaved==active)
                        ad.control.spectra.unsaved(end+1) = active;
                    end
                    if ~any(ad.control.spectra.modified==active)
                        ad.control.spectra.modified(end+1) = active;
                    end
                    setappdata(mainWindow,'control',ad.control);
                    updateParameterPanel();
                    updateGeneralPanel();
                    updateDatasets();
                end
            case 'infofilewritefilename'
                % TODO: Make this dependend on the popupmenu for the file
                % type
                if isempty(ad.data)
                    return;
                end
                FilterSpec = '*.info';
                [filePath,~,~] = fileparts(...
                    ad.data{ad.control.spectra.active}.file.name);
                [infoFileName,infoPathName] = uiputfile(...
                    FilterSpec,'Get Info File Name',...
                    filePath);
                if ischar(infoFileName)
                    ad.control.spectra.infoFile{...
                        ad.control.spectra.active}.output.name = ...
                        fullfile(infoPathName,infoFileName);
                    setappdata(mainWindow,'control',ad.control);
                    set(gh.tools_panel_infofilewrite_format_edit,...
                        'String',infoFileName);
                end
            case 'infofilewritepreview'
                if isempty(ad.data)
                    return;
                end
                [infoFileText,warnings] = trEPRinfoFileCreate(...
                    ad.data{ad.control.spectra.active});
                if ~isempty(warnings)
                    add2status(warnings);
                end
                set(gh.tools_panel_infofiledisplay_edit,...
                    'String',infoFileText);
            case 'infofilewritesave'
                active = ad.control.spectra.active;
                if isempty(ad.data)
                    return;
                end
                % Check whether there is a filename to save to
                if isempty(ad.control.spectra.infoFile{active}.output.name)
                    FilterSpec = '*.info';
                    [filePath,~,~] = fileparts(...
                        ad.data{ad.control.spectra.active}.file.name);
                    [infoFileName,infoPathName] = uiputfile(...
                        FilterSpec,'Get Info File Name',...
                        filePath);
                    if ischar(infoFileName)
                        ad.control.spectra.infoFile{...
                            ad.control.spectra.active}.output.name = ...
                            fullfile(infoPathName,infoFileName);
                        setappdata(mainWindow,'control',ad.control);
                        set(gh.tools_panel_infofilewrite_format_edit,...
                            'String',infoFileName);
                    else
                        return;
                    end
                end
                % Check whether file exists already
                if exist(ad.control.spectra.infoFile{active}.output.name,'file')
                    while 1
                        button = questdlg(...
                            sprintf('File\n  %s\n exists already. Overwrite?',...
                            ad.control.spectra.infoFile{active}.output.name),...
                            'File exists...',...
                            'Yes','No','Cancel','No');
                        switch lower(button)
                            case 'no'
                                [FileName,PathName] = uiputfile('*.info',...
                                    'Select filename for info file');
                                if ~isempty(FileName) && FileName ~= 0;
                                    ad.control.spectra.infoFile{active}.output.name = ...
                                        fullfile(PathName,FileName);
                                    break;
                                end
                            case 'cancel'
                                return;
                            otherwise
                                break;
                        end
                    end
                end
                % Get contents of text display
                infoFileText = get(gh.tools_panel_infofiledisplay_edit,...
                    'String');
                if isempty(infoFileText)
                    pushbutton_Callback('','','infofilewritepreview');
                    infoFileText = get(...
                        gh.tools_panel_infofiledisplay_edit,'String');
                end
                % Write to file
                fh = fopen(ad.control.spectra.infoFile{active}.output.name,'w');
                cellfun(@(x)fprintf(fh,'%s\n',x),infoFileText);
                fclose(fh);
            case 'Apply'
                % In case the current dataset is unsaved, remove it from
                % "unsaved", thus preventing the dialogue when closing
                % asking for modified, but unsaved datasets
                if find(ad.control.spectra.unsaved==ad.control.spectra.active)
                    ad.control.spectra.unsaved(...
                        ad.control.spectra.unsaved==ad.control.spectra.active) = [];
                end
                % Update appdata of main window
                setappdata(mainWindow,'control',ad.control);
                % Update dataset display
                updateDatasets();
            case 'Revert'
                % If there is no active spectrum, silently return
                if ~ad.control.spectra.active
                    return;
                end
                % If there are no changes made to the currently active
                % dataset, silently return
                if ~find(ad.control.spectra.modified==ad.control.spectra.active)
                    return;
                end
                % TODO: Show dialogue asking the user whether he/she really
                % would like to discard all changes made to the current
                % dataset
                
                % Revert dataset to "original" dataset as loaded to the
                % info GUI
                ad.data{ad.control.spectra.active} = ...
                    ad.origdata{ad.control.spectra.active};
                % In case the current dataset is unsaved, remove it from
                % "unsaved".
                if find(ad.control.spectra.unsaved==ad.control.spectra.active)
                    ad.control.spectra.unsaved(...
                        ad.control.spectra.unsaved==ad.control.spectra.active) = [];
                end
                % Remove the current dataset from modified. (If it were not
                % modified, we should never end up here, see above.)
                ad.control.spectra.modified(...
                    ad.control.spectra.modified==ad.control.spectra.active) = [];
                % Update appdata of main window
                setappdata(mainWindow,'control',ad.control);
                setappdata(mainWindow,'data',ad.data);
                % Update dataset display and panels
                updateDatasets();
                updateGeneralPanel();
                updateParameterPanel();
                updateToolsPanel();
                updateHistoryPanel();
            case 'Close'
                % In case there are unsaved datasets, display dialogue
                if ~isempty(ad.control.spectra.unsaved)
                    answer = questdlg(...
                        {'There are modified and still unsaved datasets. Close anyway?'...
                        ' '...
                        'Note that "Close" means that you loose the changes you made.'...
                        ' '...
                        'Other options: "Apply & Close", "Cancel".'},...
                        'Warning: Modified Datasets...',...
                        'Discard & Close','Apply & Close','Cancel',...
                        'Cancel');
                    switch answer
                        case 'Apply & Close'
                            % As we simply want to write the datasets back
                            % to the main GUI in this case, we have to do
                            % nothing in here and pass everything to after
                            % this switch statement, as it will get done
                            % there.
                        case 'Discard & Close'
                            msgStr = 'Closing Info GUI and discarding all changes.';
                            trEPRmsg(msgStr);
                            guiClose();
                            return;
                        case 'Cancel'
                            msgStr = {'Closing Info GUI aborted by user. ' ...
                                'Reason: Modified and unsaved datasets'};
                            trEPRmsg(msgStr);
                            return;
                        otherwise
                            msgStr = {...
                                sprintf('Info GUI: Unknown answer "%s".',...
                                answer)};
                            trEPRmsg(msgStr);
                            return;
                    end

                end
                % In case there are modified datasets, write them back to
                % main GUI
                if ~isempty(ad.control.spectra.modified)
                    for k=1:length(ad.control.spectra.modified)
                        if isempty(trEPRguiGetWindowHandle())
                            assignin('base',inputParameterName,ad.data);
                        else
                            status = trEPRrefreshDatasetInMainGUI(...
                                ad.data{ad.control.spectra.modified(k)},...
                                ad.control.spectra.modified(k),...
                                'modified',true,...
                                'label',ad.origdata{ad.control.spectra.modified(k)}.label);
                            if status
                                disp('Hmm... some problems with appending modified dataset to main GUI.');
                            end
                        end
                    end
                end
                guiClose();
            otherwise
                st = dbstack;
                trEPRmsg(...
                    [st.name ' : unknown action "' action '"'],...
                    'warning');
                return;
        end
    catch exception
        try
            msgStr = ['An exception occurred in ' ...
                exception.stack(1).name  '.'];
            trEPRmsg(msgStr,'error');
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function popupmenu_Callback(source,~,action)
    try
        if isempty(action)
            return;
        end
        
        mainWindow = trEPRguiGetWindowHandle(mfilename);
        % Get appdata and handles of main window
        ad = getappdata(mainWindow);
        
        % Get value
        values = cellstr(get(source,'String'));
        value = values{get(source,'Value')};

        switch lower(action)
            case 'fieldcalibrationmethod'
                switch lower(value)
                    case 'standard'
                        set(p2p6_1,'Visible','On');
                        set(p2p6_2,'Visible','Off');
                    case 'startend'
                        set(p2p6_1,'Visible','Off');
                        set(p2p6_2,'Visible','On');
                    otherwise
                        disp([mfilename ' : popupmenu_Callback() : '...
                            'Unknown fieldcalibrationmethod "' value '"']);
                        return;
                end
            otherwise
                st = dbstack;
                trEPRmsg(...
                    [st.name ' : unknown action "' action '"'],...
                    'warning');
                return;
        end
    catch exception
        try
            msgStr = ['An exception occurred in ' ...
                exception.stack(1).name  '.'];
            trEPRmsg(msgStr,'error');
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function keypress_Callback(src,evt)
    try
        if isempty(evt.Character) && isempty(evt.Key)
            % In case "Character" is the empty string, i.e. only modifier key
            % was pressed...
            return;
        end
        if ~isempty(evt.Modifier)
            if any(strcmpi('shift',evt.Modifier)) && ...
                    (any(strcmpi('command',evt.Modifier)) || ...
                    any(strcmpi('control',evt.Modifier)))
                % If parameters panel is active
                if find(cell2mat(get([tb1 tb2 tb3 tb4],'Value'))) == 2
                    switch evt.Key
                        case '1'
                            switchParameterPanel('Page 1');
                        case '2'
                            switchParameterPanel('Page 2');
                        case '3'
                            switchParameterPanel('Page 3');
                    end
                end
            elseif (strcmpi(evt.Modifier{1},'command')) || ...
                    (strcmpi(evt.Modifier{1},'control'))
                switch evt.Key
                    case 'w'
                        pushbutton_Callback(src,evt,'Close')
                        return;
                    case '1'
                        switchPanel('General');
                        return;
                    case '2'
                        switchPanel('Parameters');
                        return;
                    case '3'
                        switchPanel('History');
                        return;
                    case '4'
                        switchPanel('Tools');
                        return;
                end
            end
        end
        switch evt.Key
            case 'f1'
                trEPRgui_info_helpwindow();
                return;
            otherwise
%                 disp(evt);
%                 fprintf('       Caller: %i\n\n',src);
                return;
        end
    catch exception
        try
            msgStr = ['An exception occurred in ' ...
                exception.stack(1).name  '.'];
            trEPRmsg(msgStr,'error');
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Utility functions
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function guiClose()
    try
        % Look for Info GUI Help window and if its there, close as well
        hHelpWindow = trEPRguiGetWindowHandle('trEPRgui_info_helpwindow');
        if ishandle(hHelpWindow)
            delete(hHelpWindow);
        end
        trEPRmsg('Info GUI window closed.','info');
        delete(trEPRguiGetWindowHandle(mfilename));
    catch exception
        try
            msgStr = ['An exception occurred in ' ...
                exception.stack(1).name  '.'];
            trEPRmsg(msgStr,'error');
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end 
end

function switchPanel(panelName)
    try
        % Get handles of main window
        mainWindow = trEPRguiGetWindowHandle(mfilename);
        gh = guihandles(mainWindow);

        panels = [p1 p2 p4 p3];
        buttons = [tb1 tb2 tb3 tb4];
        switch panelName
            case 'General'
                set(panels,'Visible','off');
                set(buttons,'Value',0);
                set(p1,'Visible','on');
                set(tb1,'Value',1);
                set(gh.main_panel_about_text,'String',...
                    ['General information about the dataset, such as '...
                    'full filename (with path), label, and header '...
                    'information. In case of Bruker BES3T files, '...
                    '"header" displays the content of the DSC file.']);
                updateGeneralPanel()
            case 'Parameters'
                set(panels,'Visible','off');
                set(buttons,'Value',0);
                set(p2,'Visible','on');
                set(tb2,'Value',1);
                set(gh.main_panel_about_text,'String',{...
                    ['All information from the "parameters" structure '...
                    'of the dataset. Most of these parameters are '...
                    'extracted from the raw data. ']...
                    ['Be careful with editing the highlighted '...
                    'fields, as that may corrupt your data!']...
                    });
                updateParameterPanel()
            case 'History'
                set(panels,'Visible','off');
                set(buttons,'Value',0);
                set(p3,'Visible','on');
                set(tb3,'Value',1);
                set(gh.main_panel_about_text,'String',{...
                    ['Access to the complete history of the dataset '...
                    'including a detailed account of the parameters '...
                    'used for every step in the history. ']...
                    ['If there is a report from a given record, '...
                    'it will be displayed as well.']...
                    });
                updateHistoryPanel()
            case 'Tools'
                set(panels,'Visible','off');
                set(buttons,'Value',0);
                set(p4,'Visible','on');
                set(tb4,'Value',1);
                set(gh.main_panel_about_text,'String',{...
                    ['Tools as reading metafiles and applying '...
                    'their contents to the currently active dataset.'] ...
                    '' ...
                    ['Note: Currently, this is just a tech preview '...
                    'lacking any functionality.'] ...
                    });
                updateToolsPanel()
            otherwise
                st = dbstack;
                trEPRmsg(...
                    [st.name ' : unknown panel "' panelName '"'],...
                    'warning');
                return;
        end
    catch exception
        try
            msgStr = ['An exception occurred in ' ...
                exception.stack(1).name  '.'];
            trEPRmsg(msgStr,'error');
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end 
end

function switchParameterPanel(panelName)
    try
        % Get handles of main window
        mainWindow = trEPRguiGetWindowHandle(mfilename);
        gh = guihandles(mainWindow);

        panels = [ ...
            gh.parameter_page1_panel ...
            gh.parameter_page2_panel ...
            gh.parameter_page3_panel ...
            ];
        buttons = [...
            gh.parameter_page1_togglebutton ...
            gh.parameter_page2_togglebutton ...
            gh.parameter_page3_togglebutton ...
            ];
        switch lower(panelName)
            case 'page 1'
                set(panels,'Visible','off');
                set(buttons,'Value',0);
                set(gh.parameter_page1_panel,'Visible','on');
                set(gh.parameter_page1_togglebutton,'Value',1);
            case 'page 2'
                set(panels,'Visible','off');
                set(buttons,'Value',0);
                set(gh.parameter_page2_panel,'Visible','on');
                set(gh.parameter_page2_togglebutton,'Value',1);
            case 'page 3'
                set(panels,'Visible','off');
                set(buttons,'Value',0);
                set(gh.parameter_page3_panel,'Visible','on');
                set(gh.parameter_page3_togglebutton,'Value',1);
            otherwise
                st = dbstack;
                trEPRmsg(...
                    [st.name ' : unknown panel "' panelName '"'],...
                    'warning');
                return;
        end
    catch exception
        try
            msgStr = ['An exception occurred in ' ...
                exception.stack(1).name  '.'];
            trEPRmsg(msgStr,'error');
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end 
end

function updateDatasets()
    try
        mainWindow = trEPRguiGetWindowHandle(mfilename);
        % Get appdata from ACC GUI
        ad = getappdata(mainWindow);
            
        if isempty(ad.data)
            return;
        end
        
        % Get handle for loaded spectra listbox
        gh = guidata(mainWindow);
        lbox = gh.main_panel_dataset_listbox;
        
        % Get indices of loaded spectra
        loaded = ad.control.spectra.loaded;
        
        % Get names for display in listbox
        if ~isempty(loaded)
            set(lbox,'Enable','on');
            labels = cell(0);
            for k=1:length(loaded)
                if find(ad.control.spectra.unsaved==loaded(k))
                    labels{k} = ['*' ad.data{loaded(k)}.label];
                else
                    labels{k} = ad.data{loaded(k)}.label;
                end
            end
            % Update status display
            set(lbox,'String',labels);
            if (get(lbox,'Value')>length(loaded))
                set(lbox,'Value',length(loaded));
            end
            if ((get(lbox,'Value')==0) && (~isempty(loaded)))
                set(lbox,'Value',1);
            end
        else
            set(lbox,'String','');
            set(lbox,'Enable','off');
            ad.control.spectra.active = [];
        end
        
        % Highlight currently active
        if ad.control.spectra.active
            set(lbox,'Value',find(loaded==ad.control.spectra.active));
        end
        
        % Set appdata of info GUI
        setappdata(mainWindow,'control',ad.control);

    catch exception
        try
            msgStr = ['An exception occurred in ' ...
                exception.stack(1).name  '.'];
            trEPRmsg(msgStr,'error');
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end 
end

function updateGeneralPanel()
    try
        mainWindow = trEPRguiGetWindowHandle(mfilename);
        % Get appdata from info GUI
        ad = getappdata(mainWindow);
        
        if isempty(ad.data)
            return;
        end
        
        % Get handles from info GUI
        gh = guidata(mainWindow);

        [filepath,filename,fileext] = ...
            fileparts(ad.data{ad.control.spectra.active}.file.name);
        if filepath
            filepath = [filepath '/'];
        end
        set(gh.general_panel_filepath_edit,'String',filepath);
        set(gh.general_panel_filename_edit,'String',[filename fileext]);
        set(gh.general_panel_fileformat_edit,'String',...
            ad.data{ad.control.spectra.active}.file.format);
        set(gh.general_panel_label_edit,'String',...
            ad.data{ad.control.spectra.active}.label);
        
        for k=1:length(ad.data{ad.control.spectra.active}.header)
            ad.data{ad.control.spectra.active}.header{k} = ...
                sprintf('%03.0f: %s',...
                k,char(ad.data{ad.control.spectra.active}.header{k}));
        end
        set(gh.general_panel_purpose_edit,'String',...
            ad.data{ad.control.spectra.active}.parameters.purpose);
        set(gh.general_panel_header_edit,'String',...
            ad.data{ad.control.spectra.active}.header);
        set(gh.general_panel_comment_edit,'String',...
            ad.data{ad.control.spectra.active}.comment);

    catch exception
        try
            msgStr = ['An exception occurred in ' ...
                exception.stack(1).name  '.'];
            trEPRmsg(msgStr,'error');
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end 
end

function updateParameterPanel()
    try
        mainWindow = trEPRguiGetWindowHandle(mfilename);
        % Get appdata and handles from info GUI
        ad = getappdata(mainWindow);
        gh = guidata(mainWindow);
        
        % Make life easier
        active = ad.control.spectra.active;
        
        % Cell array matching GUI edit fields to data structure
        % The first column contains the GUI edit field tags.
        % The second column contains the default string of the field.
        % The third column contains the corresponding field in the
        % parameters part of the data structure.
        % The fourth column contains an index, in case that the field in
        % the data structure is a vector and a certain field of that is
        % needed.
        matchingSample = {...
            'parameter_panel_samplename_edit','N/A','name',''; ...
            'parameter_panel_sampletube_edit','N/A','tube',''; ...
            'parameter_panel_sampledescription_edit','N/A','description',''; ...
            'parameter_panel_samplebuffer_edit','N/A','buffer',''; ...
            'parameter_panel_samplepreparation_edit','N/A','preparation',''; ...
            };
        matchingAxes = {...
            'parameter_panel_xmeasure_edit','index','x.measure',''; ...
            'parameter_panel_xunit_edit','points','x.unit',''; ...
            'parameter_panel_ymeasure_edit','index','y.measure',''; ...
            'parameter_panel_yunit_edit','points','y.unit',''; ...
            'parameter_panel_zmeasure_edit','index','z.measure',''; ...
            'parameter_panel_zunit_edit','points','z.unit',''; ...
            };
        matchingParameter = {...
            % General panel
            'parameter_panel_nruns_edit','0','runs',''; ...
            'parameter_panel_datestart_edit','yyyy-mm-dd HH:MM:SS','date.start',''; ...
            'parameter_panel_dateend_edit','yyyy-mm-dd HH:MM:SS','date.end',''; ...
            'parameter_panel_shotrepetitionrate_edit','0','shotRepetitionRate.value',''; ...
            'parameter_panel_shotrepetitionrateunit_edit','Hz','shotRepetitionRate.unit',''; ...
            'parameter_panel_operator_edit','N/A','operator',''; ...
            % Temperature panel
            'parameter_panel_temperature_edit','0','temperature.value',''; ...
            'parameter_panel_temperature_unit_edit','K','temperature.unit',''; ...
            'parameter_panel_temperaturecontroller_edit','N/A','temperature.model',''; ...
            'parameter_panel_cryostat_edit','N/A','temperature.cryostat',''; ...
            'parameter_panel_cryogen_edit','N/A','temperature.cryogen',''; ...
            % Spectrometer panel
            'parameter_panel_spectrometername_edit','N/A','spectrometer.name',''; ...
            'parameter_panel_spectrometersoftware_edit','N/A','spectrometer.software',''; ...
            % Field panel
            'parameter_panel_fieldstart_edit','0','field.start.value',''; ...
            'parameter_panel_fieldstartunit_edit','G','field.start.unit',''; ...
            'parameter_panel_fieldend_edit','0','field.stop.value',''; ...
            'parameter_panel_fieldendunit_edit','G','field.stop.unit',''; ...
            'parameter_panel_fieldstep_edit','0','field.step.value',''; ...
            'parameter_panel_fieldstepunit_edit','G','field.step.unit',''; ...
            'parameter_panel_fieldsequence_edit','N/A','field.sequence',''; ...
            'parameter_panel_fieldcontroller_edit','N/A','field.model',''; ...
            'parameter_panel_fieldpowersupply_edit','N/A','field.powersupply','';...
            'parameter_panel_fieldprobe_edit','N/A','field.calibration.model',''; ...
            'parameter_panel_fieldcalibrationstandard_edit','N/A','field.calibration.standard',''; ...
            'parameter_panel_fieldcalibrationsignalfield_edit','0','field.calibration.signalField.value',''; ...
            'parameter_panel_fieldcalibrationsignalfieldunit_edit','G','field.calibration.signalField.unit',''; ...
            'parameter_panel_fieldcalibrationmwfrequency_edit','0','field.calibration.MWfrequency.value',''; ...
            'parameter_panel_fieldcalibrationmwfrequencyunit_edit','GHz','field.calibration.MWfrequency.unit',''; ...
            'parameter_panel_fieldcalibrationdeviation_edit','0','field.calibration.deviation.value',''; ...
            'parameter_panel_fieldcalibrationdeviationunit_edit','G','field.calibration.deviation.unit',''; ...
            'parameter_panel_fieldstartcalibrated_edit','0','field.calibration.start.value',''; ...
            'parameter_panel_fieldstartcalibratedunit_edit','G','field.calibration.start.unit',''; ...
            'parameter_panel_fieldendcalibrated_edit','0','field.calibration.end.value',''; ...
            'parameter_panel_fieldendcalibratedunit_edit','G','field.calibration.end.value',''; ...
            % Bridge panel
            'parameter_panel_bridgemodel_edit','N/A','bridge.model',''; ...
            'parameter_panel_mwfrequency_edit','0','bridge.MWfrequency.value',1; ...
            'parameter_panel_attenuation_edit','0','bridge.attenuation.value',''; ...
            'parameter_panel_mwpower_edit','0','bridge.power.value',''; ...
            'parameter_panel_mwpowerunit_edit','mW','bridge.power.unit',''; ...
            'parameter_panel_mwdetection_edit','N/A','bridge.detection',''; ...
            'parameter_panel_bridgebandwidth_edit','0','bridge.bandwidth.value',''; ...
            'parameter_panel_bridgebandwidthunit_edit','MHz','bridge.bandwidth.unit',''; ...
            'parameter_panel_amplificationunit_edit','dB','bridge.amplification.unit',''; ...
            'parameter_panel_amplification_edit','0','bridge.amplification.value',''; ...
            'parameter_panel_mwcalibratedstart_edit','0','bridge.calibration.start.value',''; ...
            'parameter_panel_mwcalibratedstartunit_edit','GHz','bridge.calibration.start.unit',''; ...
            'parameter_panel_mwcalibratedend_edit','0','bridge.calibration.end.value',''; ...
            'parameter_panel_mwcalibratedendunit_edit','GHz','bridge.calibration.end.unit',''; ...
            'parameter_panel_mwcounter_edit','N/A','bridge.calibration.model',''; ...
            % Probehead panel
            'parameter_panel_probeheadtype_edit','N/A','probehead.type','';...
            'parameter_panel_probeheadmodel_edit','N/A','probehead.model','';...
            'parameter_panel_probeheadcoupling_edit','N/A','probehead.coupling','';...
            % Transient panel
            'parameter_panel_npts_edit','0','transient.points',''; ...
            'parameter_panel_triggerposition_edit','0','transient.triggerPosition',''; ...
            'parameter_panel_length_edit','0','transient.length.value',''; ...
            'parameter_panel_length_unit_edit','us','transient.length.unit',''; ...
            % Background panel
            'parameter_panel_backgroundfield_edit','0','background.field.value',''; ...
            'parameter_panel_backgroundfieldunit_edit','G','background.field.unit',''; ...
            'parameter_panel_backgroundoccurrence_edit','0','background.occurrence',''; ...
            'parameter_panel_backgroundpolarisation_edit','N/A','background.polarisation',''; ...
            % Recorder panel
            'parameter_panel_sensitivity_edit','0','recorder.sensitivity.value',''; ...
            'parameter_panel_sensitivity_unit_edit','mV','recorder.sensitivity.unit',''; ...
            'parameter_panel_averages_edit','0','recorder.averages',''; ...
            'parameter_panel_timebase_edit','0','recorder.timeBase.value',''; ...
            'parameter_panel_timebaseunit_edit','us','recorder.timeBase.unit',''; ...
            'parameter_panel_bandwidth_edit','0','recorder.bandwidth.value',''; ...
            'parameter_panel_bandwidthunit_edit','MHz','recorder.bandwidth.unit',''; ...
            'parameter_panel_recordermodel_edit','N/A','recorder.model',''; ...
            'parameter_panel_recordercoupling_edit','N/A','recorder.coupling',''; ...
            'parameter_panel_recorderimpedance_edit','0','recorder.impedance.value',''; ...
            'parameter_panel_recorderimpedanceunit_edit','MOhm','recorder.impedance.unit',''; ...
            % Laser panel
            'parameter_panel_wavelength_edit','0','laser.wavelength.value',''; ...
            'parameter_panel_repetitionrate_edit','0','laser.repetitionRate.value',''; ...
            'parameter_panel_laserpower_edit','0','laser.power.value',''; ...
            'parameter_panel_laserpowerunit_edit','mJ','laser.power.unit',''; ...
            'parameter_panel_lasertype_edit','N/A','laser.type',''; ...
            'parameter_panel_lasermodel_edit','N/A','laser.model',''; ...
            'parameter_panel_tunabletype_edit','N/A','laser.tunable.type',''; ...
            'parameter_panel_tunablemodel_edit','N/A','laser.tunable.model',''; ...
            'parameter_panel_tunabledye_edit','N/A','laser.tunable.dye',''; ...
            'parameter_panel_tunableposition_edit','N/A','laser.tunable.position',''; ...
            };
        
        if isempty(ad.data)
            % Set all edit fields to default values
            for k=1:size(matchingParameter,1)
                set(gh.(matchingParameter{k,1}),'String',matchingParameter{k,2});
            end
            for k=1:size(matchingSample,1)
                set(gh.(matchingSample{k,1}),'String',matchingSample{k,2});
            end
            for k=1:size(matchingAxes,1)
                set(gh.(matchingAxes{k,1}),'String',matchingAxes{k,2});
            end
            return;
        else
            for idx=1:length(matchingParameter)
                if ~isempty(matchingParameter{idx,3}) && ~isempty(...
                        getCascadedField(...
                        ad.data{active}.parameters,...
                        matchingParameter{idx,3}))
                    if ~isempty(matchingParameter{idx,4})
                        value = getCascadedField(...
                            ad.data{active}.parameters,...
                            matchingParameter{idx,3});
                        set(gh.(matchingParameter{idx,1}),'String',...
                            num2str(value(matchingParameter{idx,4})));
                    else
                        set(gh.(matchingParameter{idx,1}),'String',...
                            getCascadedField(...
                            ad.data{active}.parameters,...
                            matchingParameter{idx,3})...
                            );
                    end
                else
                    set(gh.(matchingParameter{idx,1}),...
                        'String',matchingParameter{idx,2});
                end
            end
            for k=1:size(matchingSample,1)
                if ~isempty(matchingSample{k,3}) && ~isempty(...
                        getCascadedField(...
                        ad.data{active}.sample,...
                        matchingSample{k,3}))
                    if ~isempty(matchingSample{k,4})
                        value = getCascadedField(...
                            ad.data{active}.sample,...
                            matchingSample{k,3});
                        set(gh.(matchingSample{k,1}),'String',...
                            num2str(value(matchingSample{k,4})));
                    else
                        set(gh.(matchingSample{k,1}),'String',...
                            getCascadedField(...
                            ad.data{active}.sample,...
                            matchingSample{k,3})...
                            );
                    end
                else
                    set(gh.(matchingSample{k,1}),'String',matchingSample{k,2});
                end
            end
            for k=1:size(matchingAxes,1)
                if ~isempty(matchingAxes{k,3}) && ~isempty(...
                        getCascadedField(...
                        ad.data{active}.axes,...
                        matchingAxes{k,3}))
                    if ~isempty(matchingAxes{k,4})
                        value = getCascadedField(...
                            ad.data{active}.axes,...
                            matchingAxes{k,3});
                        set(gh.(matchingAxes{k,1}),'String',...
                            num2str(value(matchingAxes{k,4})));
                    else
                        set(gh.(matchingAxes{k,1}),'String',...
                            getCascadedField(...
                            ad.data{active}.axes,...
                            matchingAxes{k,3})...
                            );
                    end
                else
                    set(gh.(matchingAxes{k,1}),'String',matchingAxes{k,2});
                end
            end
        end
        % Account for additional field "parameter_panel_fieldpts_edit"
        [y,~] = size(ad.data{active}.data);
        set(gh.parameter_panel_fieldpts_edit,'String',num2str(y));
        
        % Account for parameter_panel_fieldcalibrationmethod_popupmenu
        methods = cellstr(get(...
            gh.parameter_panel_fieldcalibrationmethod_popupmenu,'String'));
        if any(strcmpi(ad.data{active}.parameters.field.calibration.method,...
                methods))
            set(gh.parameter_panel_fieldcalibrationmethod_popupmenu,...
                'Value',find(...
                strcmpi(ad.data{active}.parameters.field.calibration.method,...
                methods)));
            popupmenu_Callback(...
                gh.parameter_panel_fieldcalibrationmethod_popupmenu,[],...
                'fieldcalibrationmethod');
        elseif ~isempty(ad.data{active}.parameters.field.calibration.method)
            disp([mfilename ': updateParameterPanel(): Unknown '...
                'calibration method ' ...
                ad.data{active}.parameters.field.calibration.method]);
        end
    catch exception
        try
            msgStr = ['An exception occurred in ' ...
                exception.stack(1).name  '.'];
            trEPRmsg(msgStr,'error');
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end 
end

function updateToolsPanel()
    try
        mainWindow = trEPRguiGetWindowHandle(mfilename);
        % Get appdata from info GUI
        ad = getappdata(mainWindow);
        
        if isempty(ad.data)
            return;
        end

        % Get handles from info GUI
%         gh = guidata(mainWindow);

    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            trEPRmsg(msgStr,'error');
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end 
end

function updateHistoryPanel()
    try
        mainWindow = trEPRguiGetWindowHandle(mfilename);
        % Get appdata from info GUI
        ad = getappdata(mainWindow);
        
        % Get handles from info GUI
        gh = guidata(mainWindow);
        
        % To shorten lines, assign Id of currently active dataset
        selectedId = ad.control.spectra.active;
        
        % If no data or no history
        if isempty(ad.data) || isempty(ad.data{selectedId}.history)
            % Empty all strings
            set(gh.history_panel_records_listbox,'String','');
            set(gh.history_panel_records_listbox,'Enable','inactive');
            set(gh.history_panel_date_text,'String','');
            set(gh.history_panel_method_text,'String','');
            set(gh.history_panel_operator_text,'String','');
            set(gh.history_panel_platform_text,'String','');
            set(gh.history_panel_matlabversion_text,'String','');
            set(gh.history_panel_toolboxversion_text,'String','');
            set(gh.history_panel_parameter_edit,'String','');
            set(gh.history_panel_report_edit,'String','');
            return;
        end
        
        % Set selected history record for currently active dataset
        if ~(ad.control.spectra.history{selectedId})
            ad.control.spectra.history{selectedId} = 1;
        end
        historyId = ad.control.spectra.history{selectedId};
        
        % Get labels for history records listbox
        recordLabels = ...
            cell(length(ad.data{selectedId}.history),1);
        for k=1:length(ad.data{selectedId}.history)
            recordLabels{k} = ad.data{selectedId}.history{k}.method;
        end
        % Set history records listbox
        set(gh.history_panel_records_listbox,'Enable','on');
        set(gh.history_panel_records_listbox,'String',recordLabels);
        set(gh.history_panel_records_listbox,'Value',...
            ad.control.spectra.history{selectedId});
        
        % Set summary panel strings
        set(gh.history_panel_date_text,'String',...
            ad.data{selectedId}.history{historyId}.date);
        set(gh.history_panel_method_text,'String',...
            ad.data{selectedId}.history{historyId}.method);
        set(gh.history_panel_operator_text,'String',...
            ad.data{selectedId}.history{historyId}.system.username);
        
        % Set system panel strings
        set(gh.history_panel_platform_text,'String',...
            ad.data{selectedId}.history{historyId}.system.platform);
        set(gh.history_panel_matlabversion_text,'String',...
            ad.data{selectedId}.history{historyId}.system.matlab);
        set(gh.history_panel_toolboxversion_text,'String',...
            ad.data{selectedId}.history{historyId}.system.trEPR);
        
        % Set parameters panel
        set(gh.history_panel_parameter_edit,'String',...
            trEPRhistoryDisplay(ad.data{selectedId}.history{historyId}));
        
        % Set report panel
        set(gh.history_panel_report_edit,'String',...
            ad.data{selectedId}.history{historyId}.info);

    catch exception
        try
            msgStr = ['An exception occurred in ' ...
                exception.stack(1).name  '.'];
            trEPRmsg(msgStr,'error');
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end 
end

% --- Get field of cascaded struct
function value = getCascadedField (struct, fieldName)
    try
        % Get number of "." in fieldName
        nDots = strfind(fieldName,'.');
        if isempty(nDots)
            if isfield(struct,fieldName)
                value = struct.(fieldName);
            else
                value = '';
            end
        else
            if isfield(struct,fieldName(1:nDots(1)-1))
                struct = struct.(fieldName(1:nDots(1)-1));
                value = getCascadedField(...
                    struct,...
                    fieldName(nDots(1)+1:end));
            else
                value = '';
            end
        end
    catch exception
        try
            disp(fieldName);
            disp(struct);
            msgStr = ['An exception occurred in ' ...
                exception.stack(1).name  '.'];
            trEPRmsg(msgStr,'error');
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end 
end

% --- Set field of cascaded struct
function struct = setCascadedField (struct, fieldName, value)
    try
        % Get number of "." in fieldName
        nDots = strfind(fieldName,'.');
        if isempty(nDots)
            struct.(fieldName) = value;
        else
            if ~isfield(struct,fieldName(1:nDots(1)-1))
                struct.(fieldName(1:nDots(1)-1)) = [];
            end
            innerstruct = struct.(fieldName(1:nDots(1)-1));
            innerstruct = setCascadedField(...
                innerstruct,...
                fieldName(nDots(1)+1:end),...
                value);
            struct.(fieldName(1:nDots(1)-1)) = innerstruct;
        end
    catch exception
        try
            disp(fieldName);
            disp(struct);
            msgStr = ['An exception occurred in ' ...
                exception.stack(1).name  '.'];
            trEPRmsg(msgStr,'error');
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end 
end

end