function varargout = trEPRgui_AVGwindow(varargin)
% TREPRGUI_AVGWINDOW Provide user with all necessary controls to perform
% averaging in one dimension on a given dataset.
%
% Normally, this window is called from within the trEPRgui window.
%
% See also TREPRGUI

% (c) 2011, Till Biskup
% 2011-11-13

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Construct the components
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Make GUI effectively a singleton
singleton = findobj('Tag','trepr_gui_AVGwindow');
if (singleton)
    figure(singleton);
    varargout{1} = singleton;
    return;
end

%  Construct the components
hMainFigure = figure('Tag','trepr_gui_AVGwindow',...
    'Visible','off',...
    'Name','trEPR GUI : AVG Window',...
    'Units','Pixels',...
    'Position',[30,50,800,670],...
    'Resize','off',...
    'NumberTitle','off', ...
    'KeyPressFcn',@keypress_Callback,...
    'Menu','none','Toolbar','none');

defaultBackground = get(hMainFigure,'Color');
mainPanelWidth = 260;
mainPanelHeight = 540;
panel_size = 240;
guiSize = get(hMainFigure,'Position');
guiSize = guiSize([3,4]);

hPlotAxes = axes(...         % the axes for plotting selected plot
    'Tag','axis',...
	'Parent', hMainFigure, ...
    'FontUnit','Pixel','Fontsize',12,...
    'Units', 'Pixels', ...
    'Position',[70 250 400 400]);
uicontrol('Tag','position_slider',...
    'Style', 'slider',...
	'Parent', hMainFigure, ...
    'Min',1,'Max',100,'Value',50,...
    'Position', [485 250 15 400],...
    'BackgroundColor',[1 1 1],...
    'TooltipString','',...
    'Enable','off',...
    'Callback', {@position_slider_Callback}...
    );

uicontrol('Tag','axis2heading_text',...
    'Style','text',...
    'Parent',hMainFigure,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Center',...
    'FontWeight','bold',...
    'Units','Pixels',...
    'Position',[70 190 400 20],...
    'String','1D Display along the axis the dataset is averaged over'...
    );
axes(...         % the axes for plotting selected plot
    'Tag','axis2',...
	'Parent', hMainFigure, ...
    'FontUnit','Pixel','Fontsize',12,...
    'Units', 'Pixels', ...
    'Position',[70 50 400 140]);


% Create button group, toggle buttons for switching btw. panels
hButtonGroup = uibuttongroup('Tag','mainButtonGroup',...
    'BackgroundColor',defaultBackground,...
    'BorderType','none',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position', [guiSize(1)-mainPanelWidth-20 guiSize(2)-50 mainPanelWidth 30],...
    'Visible','on',...
    'SelectionChangeFcn',{@tbg_Callback});
tb1 = uicontrol('Tag','datasets_togglebutton',...
    'Style','Toggle',...
	'Parent', hButtonGroup, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Display',...
    'TooltipString','Select the dataset and review the display settings',...
    'pos',[0 0 (mainPanelWidth)/3 30],...
    'Enable','on'...
    );
tb2 = uicontrol('Tag','fit_togglebutton',...
    'Style','Toggle',...
	'Parent', hButtonGroup, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Average',...
    'TooltipString','Set parameters for accumulation',...
    'pos',[mainPanelWidth/3 0 (mainPanelWidth)/3 30],...
    'Enable','on'...
    );
tb3 = uicontrol('Tag','settings_togglebutton',...
    'Style','Toggle',...
	'Parent', hButtonGroup, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Settings',...
    'TooltipString','Show results of accumulation',...
    'pos',[mainPanelWidth/3*2 0 (mainPanelWidth)/3 30],...
    'Enable','on'...
    );

% Create (switchable and overlaying) main panels
pp1 = uipanel('Tag','display_panel',...
    'parent',hMainFigure,...
    'Title','Display',...
    'FontUnit','Pixel','Fontsize',12,...
    'FontWeight','bold',...
    'BackgroundColor',defaultBackground,...
    'Visible','on',...
    'Units','pixels',...
    'Position',[guiSize(1)-mainPanelWidth-20 70 mainPanelWidth mainPanelHeight]);

pp2 = uipanel('Tag','fit_panel',...
    'parent',hMainFigure,...
    'Title','Average',...
    'FontUnit','Pixel','Fontsize',12,...
    'FontWeight','bold',...
    'BackgroundColor',defaultBackground,...
    'Visible','off',...
    'Units','pixels',...
    'Position',[guiSize(1)-mainPanelWidth-20 70 mainPanelWidth mainPanelHeight]);

pp3 = uipanel('Tag','settings_panel',...
    'parent',hMainFigure,...
    'Title','Settings',...
    'FontUnit','Pixel','Fontsize',12,...
    'FontWeight','bold',...
    'BackgroundColor',defaultBackground,...
    'Visible','off',...
    'Units','pixels',...
    'Position',[guiSize(1)-mainPanelWidth-20 70 mainPanelWidth mainPanelHeight]);

% elements for pp1
pp1_p1 = uipanel('Tag','visible_panel',...
    'Parent',pp1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-130 mainPanelWidth-20 110],...
    'Title','Visible datasets'...
    );
uicontrol('Tag','visible_panel_listbox',...
    'Style','listbox',...
    'Parent',pp1_p1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 10 mainPanelWidth-40 80],...
    'TooltipString','List of currently visible spectra',...
    'String','',...
    'Callback',{@visible_panel_listbox_Callback}...
    );

pp1_p2 = uipanel('Tag','displaytype_panel',...
    'Parent',pp1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-190 mainPanelWidth-20 50],...
    'Title','Display type'...
    );
uicontrol('Tag','displaytype_popupmenu',...
    'Style','popupmenu',...
    'Parent',pp1_p2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 10 mainPanelWidth-40 20],...
    'String','2D plot|1D along x|1D along y',...
    'Callback', {@displaytype_popupmenu_Callback}...
    );

pp1_p3 = uipanel('Tag','sliderposition_panel',...
    'Parent',pp1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-340 mainPanelWidth-20 140],...
    'Title','Slider position'...
    );
uicontrol('Tag','sliderposition_index_text',...
    'Style','text',...
    'Parent',pp1_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 90 (mainPanelWidth-90)/2 25],...
    'String','index'...
    );
uicontrol('Tag','sliderposition_unit_text',...
    'Style','text',...
    'Parent',pp1_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 90 (mainPanelWidth-90)/2 25],...
    'String','unit'...
    );
uicontrol('Tag','sliderposition_x_text',...
    'Style','text',...
    'Parent',pp1_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 70 35 20],...
    'String','x'...
    );
uicontrol('Tag','sliderposition_x_index_edit',...
    'Style','edit',...
    'Parent',pp1_p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 70 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@position_edit_Callback,'xindex'}...
    );
uicontrol('Tag','sliderposition_x_unit_edit',...
    'Style','edit',...
    'Parent',pp1_p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 70 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@position_edit_Callback,'xunit'}...
    );
uicontrol('Tag','sliderposition_y_text',...
    'Style','text',...
    'Parent',pp1_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 40 35 20],...
    'String','y'...
    );
uicontrol('Tag','sliderposition_y_index_edit',...
    'Style','edit',...
    'Parent',pp1_p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 40 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@position_edit_Callback,'yindex'}...
    );
uicontrol('Tag','sliderposition_y_unit_edit',...
    'Style','edit',...
    'Parent',pp1_p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 40 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@position_edit_Callback,'yunit'}...
    );
uicontrol('Tag','slider_panel_show_position_checkbox',...
    'Style','checkbox',...
    'Parent',pp1_p3,...
    'BackgroundColor',defaultBackground,...
    'Enable','on',...
    'TooltipString','Check to display current position in main display',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[20 10 100 25],...
    'String','Show',...
    'Value',0,...
    'Callback',{@showposition_checkbox_Callback}...
    );
uicontrol('Tag','slider_panel_maximum_pushbutton',...
    'Style','pushbutton',...
    'Parent',pp1_p3,...
    'BackgroundColor',defaultBackground,...
    'Enable','on',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 10 (mainPanelWidth-90)/2 25],...
    'String','Maximum',...
    'TooltipString','Set position to maximum in both dimensions',...
    'Callback',{@pushbutton_Callback,'showMaximum'}...
    );

pp1_p4 = uipanel('Tag','measure_panel',...
    'Parent',pp1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-490 mainPanelWidth-20 140],...
    'Title','Measure'...
    );
uicontrol('Tag','measure_index_text',...
    'Style','text',...
    'Parent',pp1_p4,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 90 (mainPanelWidth-90)/2 25],...
    'String','index'...
    );
uicontrol('Tag','measure_unit_text',...
    'Style','text',...
    'Parent',pp1_p4,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 90 (mainPanelWidth-90)/2 25],...
    'String','unit'...
    );
uicontrol('Tag','measure_x_text',...
    'Style','text',...
    'Parent',pp1_p4,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 70 35 20],...
    'String','x'...
    );
uicontrol('Tag','measure_x_index_edit',...
    'Style','edit',...
    'Parent',pp1_p4,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 70 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Enable','Inactive',...
    'Callback',{@position_edit_Callback,'xindex'}...
    );
uicontrol('Tag','measure_x_unit_edit',...
    'Style','edit',...
    'Parent',pp1_p4,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 70 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Enable','Inactive',...
    'Callback',{@position_edit_Callback,'xunit'}...
    );
uicontrol('Tag','measure_y_text',...
    'Style','text',...
    'Parent',pp1_p4,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 40 35 20],...
    'String','y'...
    );
uicontrol('Tag','measure_y_index_edit',...
    'Style','edit',...
    'Parent',pp1_p4,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 40 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Enable','Inactive',...
    'Callback',{@position_edit_Callback,'yindex'}...
    );
uicontrol('Tag','measure_y_unit_edit',...
    'Style','edit',...
    'Parent',pp1_p4,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 40 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Enable','Inactive',...
    'Callback',{@position_edit_Callback,'yunit'}...
    );
uicontrol('Tag','measure_pick_togglebutton',...
    'Style','togglebutton',...
    'Parent',pp1_p4,...
    'BackgroundColor',defaultBackground,...
    'Enable','on',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 10 (mainPanelWidth-90)/2 25],...
    'String','Pick',...
    'TooltipString','Pick point to measure',...
    'Callback',{@togglebutton_Callback,'measurePick'}...
    );
uicontrol('Tag','measure_clear_pushbutton',...
    'Style','pushbutton',...
    'Parent',pp1_p4,...
    'BackgroundColor',defaultBackground,...
    'Enable','on',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 10 (mainPanelWidth-90)/2 25],...
    'String','Clear',...
    'TooltipString','Clear current measurement',...
    'Callback',{@pushbutton_Callback,'measureClear'}...
    );

% elements for pp2

pp2_p1 = uipanel('Tag','dimension_panel',...
    'Parent',pp2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-70 mainPanelWidth-20 50],...
    'Title','Average dimension'...
    );
uicontrol('Tag','dimension_popupmenu',...
    'Style','popupmenu',...
    'Parent',pp2_p1,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 10 mainPanelWidth-40 20],...
    'String','x  ---  B0 spectrum|y  ---  time trace',...
    'Callback', {@popupmenu_Callback,'dimension'}...
    );

pp2_p2 = uipanel('Tag','label_panel',...
    'Parent',pp2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-140 mainPanelWidth-20 60],...
    'Title','Label for new dataset'...
    );
uicontrol('Tag','label_edit',...
    'Style','edit',...
    'Parent',pp2_p2,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','left',...
    'Units','Pixels',...
    'Position',[10 10 (mainPanelWidth-40) 25],...
    'String','label',...
    'Enable','on',...
    'Callback',{@edit_Callback,'label'}...
    );

pp2_p3 = uipanel('Tag','averagearea_panel',...
    'Parent',pp2,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-320 mainPanelWidth-20 170],...
    'Title','Average area'...
    );
uicontrol('Tag','averagearea_index_text',...
    'Style','text',...
    'Parent',pp2_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 120 (mainPanelWidth-90)/2 25],...
    'String','index'...
    );
uicontrol('Tag','averagearea_unit_text',...
    'Style','text',...
    'Parent',pp2_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 120 (mainPanelWidth-90)/2 25],...
    'String','unit'...
    );
uicontrol('Tag','average_start_text',...
    'Style','text',...
    'Parent',pp2_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','right',...
    'Units','Pixels',...
    'Position',[10 100 45 20],...
    'String','Start '...
    );
uicontrol('Tag','average_start_index_edit',...
    'Style','edit',...
    'Parent',pp2_p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 100 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@area_edit_Callback,'startindex'}...
    );
uicontrol('Tag','average_start_unit_edit',...
    'Style','edit',...
    'Parent',pp2_p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 100 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@area_edit_Callback,'startunit'}...
    );
uicontrol('Tag','average_stop_text',...
    'Style','text',...
    'Parent',pp2_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','right',...
    'Units','Pixels',...
    'Position',[10 70 45 20],...
    'String','Stop '...
    );
uicontrol('Tag','average_stop_index_edit',...
    'Style','edit',...
    'Parent',pp2_p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 70 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@area_edit_Callback,'stopindex'}...
    );
uicontrol('Tag','average_stop_unit_edit',...
    'Style','edit',...
    'Parent',pp2_p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 70 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@area_edit_Callback,'stopunit'}...
    );
uicontrol('Tag','average_delta_text',...
    'Style','text',...
    'Parent',pp2_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','right',...
    'Units','Pixels',...
    'Position',[10 40 45 20],...
    'String','Delta '...
    );
uicontrol('Tag','average_delta_index_edit',...
    'Style','edit',...
    'Parent',pp2_p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 40 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@area_edit_Callback,'deltaindex'}...
    );
uicontrol('Tag','average_delta_unit_edit',...
    'Style','edit',...
    'Parent',pp2_p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 40 (mainPanelWidth-90)/2 25],...
    'String','0',...
    'Callback',{@area_edit_Callback,'deltaunit'}...
    );
uicontrol('Tag','average_draw_pushbutton',...
    'Style','pushbutton',...
    'Parent',pp2_p3,...
    'BackgroundColor',defaultBackground,...
    'Enable','on',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60 10 (mainPanelWidth-90)/2 25],...
    'String','Draw',...
    'TooltipString','Draw area to average over',...
    'Callback',{@pushbutton_Callback,'averageDraw'}...
    );
uicontrol('Tag','average_clear_pushbutton',...
    'Style','pushbutton',...
    'Parent',pp2_p3,...
    'BackgroundColor',defaultBackground,...
    'Enable','on',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[60+(mainPanelWidth-90)/2 10 (mainPanelWidth-90)/2 25],...
    'String','Clear',...
    'TooltipString','Clear average area',...
    'Callback',{@pushbutton_Callback,'averageClear'}...
    );

uicontrol('Tag','average_pushbutton',...
    'Style','pushbutton',...
	'Parent', pp2, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Average',...
    'TooltipString','Perform average with parameters set above',...
    'pos',[10+(mainPanelWidth-20)/3*2 mainPanelHeight-370 (mainPanelWidth-20)/3 40],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'Average'}...
    );

% controls for pp3
% ...

pp3_p2 = uipanel('Tag','grid_panel',...
    'Parent',pp3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-80 mainPanelWidth-20 60],...
    'Title','Grid'...
    );
uicontrol('Tag','grid_x_togglebutton',...
    'Style','Toggle',...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','X',...
    'TooltipString','Show grid in x',...
    'pos',[10 10 (mainPanelWidth-40)/4 30],...
    'parent',pp3_p2,...
    'HandleVisibility','off',...
    'Value',0,...
    'Callback',{@togglebutton_Callback,'gridx'}...
    );
uicontrol('Tag','grid_y_togglebutton',...
    'Style','Toggle',...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Y',...
    'TooltipString','Show grid in y',...
    'pos',[10+(mainPanelWidth-40)/4 10 (mainPanelWidth-40)/4 30],...
    'parent',pp3_p2,...
    'HandleVisibility','off',...
    'Value',0,...
    'Callback',{@togglebutton_Callback,'gridy'}...
    );
uicontrol('Tag','grid_minor_togglebutton',...
    'Style','Toggle',...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','minor',...
    'TooltipString',sprintf('%s\n%s','Show minor grid',...
    '(Works only in combination with X or Y grid)'),...
    'pos',[10+(mainPanelWidth-40)/4*2 10 (mainPanelWidth-40)/4 30],...
    'parent',pp3_p2,...
    'HandleVisibility','off',...
    'Value',0,...
    'Callback',{@togglebutton_Callback,'gridminor'}...
    );
uicontrol('Tag','grid_zero_togglebutton',...
    'Style','Toggle',...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','zero',...
    'TooltipString','Show dashed line at zero',...
    'pos',[10+(mainPanelWidth-40)/4*3 10 (mainPanelWidth-40)/4 30],...
    'parent',pp3_p2,...
    'HandleVisibility','off',...
    'Value',1,...
    'Callback',{@togglebutton_Callback,'gridzero'}...
    );

pp3_p3 = uipanel('Tag','averageareasettings_panel',...
    'Parent',pp3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-180 mainPanelWidth-20 90],...
    'Title','Average area'...
    );
uicontrol('Tag','averageareasettings_colour_text',...
    'Style','text',...
    'Parent',pp3_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 40 (mainPanelWidth-40)/4-10 20],...
    'String','Colour '...
    );
uicontrol('Tag','averageareasettings_coloursample_text',...
    'Style','text',...
    'Parent',pp3_p3,...
    'BackgroundColor',[0.5 0.5 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10+(mainPanelWidth-40)/4 42 (mainPanelWidth-40)/4-10 25],...
    'String',''...
    );
uicontrol('Tag','averageareasettings_colour_pushbutton',...
    'Style','pushbutton',...
    'Parent',pp3_p3,...
    'BackgroundColor',defaultBackground,...
    'Enable','on',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10+(mainPanelWidth-40)/4*2 40 (mainPanelWidth-40)/4*2 30],...
    'String','Palette...',...
    'Callback',{@pushbutton_Callback,'averageareaColourPalette'}...
    );
uicontrol('Tag','averageareasettings_alpha_text',...
    'Style','text',...
    'Parent',pp3_p3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 10 (mainPanelWidth-40)/4-10 20],...
    'String','Alpha '...
    );
uicontrol('Tag','averageareasettings_alpha_edit',...
    'Style','edit',...
    'Parent',pp3_p3,...
    'BackgroundColor',[1 1 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','center',...
    'Units','Pixels',...
    'Position',[10+(mainPanelWidth-40)/4 10 (mainPanelWidth-40)/4-10 25],...
    'String','0.4',...
    'Enable','on',...
    'Callback',{@edit_Callback,'averageareaAlpha'}...
    );
uicontrol('Tag','averageareasettings_alpha_slider',...
    'Style', 'slider',...
	'Parent', pp3_p3, ...
    'Min',0,'Max',1,'Value',0.4,...
    'Position', [10+(mainPanelWidth-40)/4*2 10 (mainPanelWidth-40)/4*2 20],...
    'TooltipString','',...
    'Enable','on',...
    'Callback',{@slider_Callback,'averageareaAlpha'}...
    );

pp3_p4 = uipanel('Tag','avglinesettings_panel',...
    'Parent',pp3,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10 mainPanelHeight-310 mainPanelWidth-20 120],...
    'Title','Averaged data line settings'...
    );
uicontrol('Tag','avglinesettings_colour_text',...
    'Style','text',...
    'Parent',pp3_p4,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 70 (mainPanelWidth-40)/4-10 20],...
    'String','Colour '...
    );
uicontrol('Tag','avglinesettings_coloursample_text',...
    'Style','text',...
    'Parent',pp3_p4,...
    'BackgroundColor',[1 0 0],...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10+(mainPanelWidth-40)/4 72 (mainPanelWidth-40)/4-10 25],...
    'String',''...
    );
uicontrol('Tag','avglinesettings_colour_pushbutton',...
    'Style','pushbutton',...
    'Parent',pp3_p4,...
    'BackgroundColor',defaultBackground,...
    'Enable','on',...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10+(mainPanelWidth-40)/4*2 70 (mainPanelWidth-40)/4*2 30],...
    'String','Palette...',...
    'Callback',{@pushbutton_Callback,'avglineColourPalette'}...
    );
uicontrol('Tag','avglinesettings_width_text',...
    'Style','text',...
    'Parent',pp3_p4,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 40 (mainPanelWidth-40)/4-10 20],...
    'String','Width '...
    );
uicontrol('Tag','avglinesettings_width_popupmenu',...
    'Style','popupmenu',...
    'Parent',pp3_p4,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10+(mainPanelWidth-40)/4 42 (mainPanelWidth-40)/4*3 20],...
    'String','1 px|2 px|3 px|4 px|5 px',...
    'Callback', {@popupmenu_Callback,'avglineWidth'}...
    );
uicontrol('Tag','avglinesettings_style_text',...
    'Style','text',...
    'Parent',pp3_p4,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'HorizontalAlignment','Right',...
    'Units','Pixels',...
    'Position',[10 10 (mainPanelWidth-40)/4-10 20],...
    'String','Style '...
    );
uicontrol('Tag','avglinesettings_style_popupmenu',...
    'Style','popupmenu',...
    'Parent',pp3_p4,...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'Units','Pixels',...
    'Position',[10+(mainPanelWidth-40)/4 12 (mainPanelWidth-40)/4*3 20],...
    'String','solid|dashed|dotted|dash-dotted',...
    'Callback', {@popupmenu_Callback,'avglineStyle'}...
    );

uicontrol('Tag','settings_save_pushbutton',...
    'Style','pushbutton',...
	'Parent', pp3, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Save',...
    'TooltipString','Save current settings to configuration file',...
    'pos',[10 10 (mainPanelWidth-20)/2 40],...
    'Enable','off',...
    'Callback',{@pushbutton_Callback,'SettingsSave'}...
    );
uicontrol('Tag','settings_default_pushbutton',...
    'Style','pushbutton',...
	'Parent', pp3, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Defaults',...
    'TooltipString','Reset settings to default settings',...
    'pos',[10+(mainPanelWidth-20)/2 10 (mainPanelWidth-20)/2 40],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'SettingsDefault'}...
    );


uicontrol('Tag','zoom_togglebutton',...
    'Style','togglebutton',...
	'Parent', hMainFigure, ...
    'BackgroundColor',defaultBackground,...
    'ForegroundColor',[0 0 0],...
    'FontUnit','Pixel','Fontsize',12,...
    'FontWeight','bold',...
    'String','+',...
    'TooltipString','Zoom',...
    'pos',[panel_size*2+5 220 25 25],...
    'Enable','on',...
    'Callback',{@togglebutton_Callback,'Zoom'}...
    );

uicontrol('Tag','help_pushbutton',...
    'Style','pushbutton',...
	'Parent', hMainFigure, ...
    'BackgroundColor',defaultBackground,...
    'ForegroundColor',[0 0 1],...
    'FontUnit','Pixel','Fontsize',12,...
    'FontWeight','bold',...
    'String','?',...
    'TooltipString','Display help for how to operate the AVG GUI',...
    'pos',[panel_size*2+5 190 25 25],...
    'Enable','on',...
    'Callback',@trEPRgui_AVG_helpwindow...
    );


uicontrol('Tag','apply_pushbutton',...
    'Style','pushbutton',...
	'Parent', hMainFigure, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Apply',...
    'TooltipString','Apply averaging(s) and append dataset(s) to main GUI',...
    'pos',[guiSize(1)-((mainPanelWidth))-20 20 (mainPanelWidth)/3 40],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'Apply'}...
    );
uicontrol('Tag','discard_pushbutton',...
    'Style','pushbutton',...
	'Parent', hMainFigure, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Discard',...
    'TooltipString','Discard current or all averagings',...
    'pos',[guiSize(1)-((mainPanelWidth)/3*2)-20 20 (mainPanelWidth)/3 40],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'Discard'}...
    );
uicontrol('Tag','close_pushbutton',...
    'Style','pushbutton',...
	'Parent', hMainFigure, ...
    'BackgroundColor',defaultBackground,...
    'FontUnit','Pixel','Fontsize',12,...
    'String','Close',...
    'TooltipString','Close AVG GUI',...
    'pos',[guiSize(1)-((mainPanelWidth)/3)-20 20 (mainPanelWidth)/3 40],...
    'Enable','on',...
    'Callback',{@pushbutton_Callback,'Close'}...
    );

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Initialization tasks
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Store handles in guidata
guidata(hMainFigure,guihandles);

% Create appdata structure
ad = guiDataStructure('guiappdatastructure');

% Assign configuration parameters
% TODO: Later on, read this from a file
% AVG-specific settings
ad.configuration.avg.dimension = 'x';
ad.configuration.avg.area.patch.color = [0.5 0.5 1];
ad.configuration.avg.area.patch.alpha = 0.4;
ad.configuration.avg.area.patch.edge = 'none';
ad.configuration.avg.line.style = '-';
ad.configuration.avg.line.color = [1 0 0];
ad.configuration.avg.line.width = 2;
% Axis-specific settings
ad.configuration.axis.position = false;
ad.configuration.axis.grid.zero = true;
ad.configuration.axis.grid.x = 'off';
ad.configuration.axis.grid.y = 'off';
ad.configuration.axis.grid.minor = 'off';

% AVG - struct
ad.avg = struct();
ad.avg.dimension = ad.configuration.avg.dimension;
ad.avg.area.patch.color = ad.configuration.avg.area.patch.color;
ad.avg.area.patch.alpha = ad.configuration.avg.area.patch.alpha;
ad.avg.area.patch.edge = ad.configuration.avg.area.patch.edge;
ad.avg.line.style = ad.configuration.avg.line.style;
ad.avg.line.color = ad.configuration.avg.line.color;
ad.avg.line.width = ad.configuration.avg.line.width;

% avgdata - cell array
ad.avgdata = cell(0);

setappdata(hMainFigure,'data',ad.data);
setappdata(hMainFigure,'origdata',ad.origdata);
setappdata(hMainFigure,'configuration',ad.configuration);
setappdata(hMainFigure,'control',ad.control);
setappdata(hMainFigure,'avg',ad.avg);
setappdata(hMainFigure,'avgdata',ad.avgdata);

% Make the GUI visible.
set(hMainFigure,'Visible','on');
msgStr = 'AVG GUI window opened';
add2status(msgStr);


% Load data from Main GUI
mainGuiWindow = guiGetWindowHandle();
if (mainGuiWindow)
    admain = getappdata(mainGuiWindow);
    % Check for availability of necessary fields in appdata
    if (isfield(admain,'data') ~= 0)
        ad.data = admain.data;
        % Add AVG struct to each dataset
        for l=1:length(ad.data)
            ad.data{l}.avg.start = 1;
            ad.data{l}.avg.stop = 1;
            ad.data{l}.avg.delta = 0;
            ad.data{l}.avg.label = '';
            ad.data{l}.avg.dimension = ad.configuration.avg.dimension;
        end
        setappdata(hMainFigure,'data',ad.data);
        ad.origdata = admain.data;
        setappdata(hMainFigure,'origdata',ad.origdata);
    end
    if (isfield(admain,'control') ~= 0)
        ad.control = admain.control;
        ad.control.axis.position = ad.configuration.axis.position;
        ad.control.axis.grid.zero = ad.configuration.axis.grid.zero;
        ad.control.axis.grid.x = ad.configuration.axis.grid.x;
        ad.control.axis.grid.y = ad.configuration.axis.grid.y;
        ad.control.axis.grid.minor = ad.configuration.axis.grid.minor;
        setappdata(hMainFigure,'control',ad.control);
    end
    
    updateSpectra();
    ad = getappdata(hMainFigure);
end

updateAxes();
update_position_display();

if (nargout == 1)
    varargout{1} = hMainFigure;
end

% Create function-global cell array with the line styles
% The first column contains the "names", the second column the values
lineStyles = {'solid','-';'dashed','--';'dotted',':';'dash-dotted','-.'};

% Add keypress function to every element that can have one...
handles = findall(...
    allchild(hMainFigure),'style','pushbutton',...
    '-or','style','togglebutton',...
    '-or','style','edit',...
    '-or','style','listbox',...
    '-or','style','popupmenu');
for m=1:length(handles)
    set(handles(m),'KeyPressFcn',@keypress_Callback);
end

% Disable average draw button
gh = guihandles(mainWindow);
set(gh.average_draw_pushbutton,'Enable','Inactive');


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Callbacks
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function tbg_Callback(source,~)
    try 
        switchPanel(get(get(source,'SelectedObject'),'String'));
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function position_slider_Callback(source,~)
    try
        mainWindow = guiGetWindowHandle(mfilename);
        % Get appdata from AVG GUI
        ad = getappdata(mainWindow);
        
        % Depending on display type settings
        switch ad.control.axis.displayType
            case '1D along x'
                ad.data{ad.control.spectra.active}.display.position.y = ...
                    int16(get(source,'value'));
            case '1D along y'
                ad.data{ad.control.spectra.active}.display.position.x = ...
                    int16(get(source,'value'));
            otherwise
                msg = sprintf('Display type %s currently unsupported',...
                    ad.control.axis.displayType);
                add2status(msg);
        end
        
        % Set appdata from AVG GUI
        setappdata(mainWindow,'data',ad.data);
        
        updateAxes();
        update_position_display();
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function position_edit_Callback(source,~,position)
    try
        if isempty(position)
            return;
        end
        
        % If value is empty or NaN after conversion to numeric, restore
        % previous entry and return
        if (isempty(get(source,'String')) || isnan(str2double(get(source,'String'))))
            % Update slider panel
            updateSliderPanel();
            return;
        end
        
        % Get appdata of AVG GUI
        mainWindow = guiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);
        
        % Be as robust as possible: if there is no axes, default is indices
        [y,x] = size(ad.data{ad.control.spectra.active}.data);
        x = linspace(1,x,x);
        y = linspace(1,y,y);
        if (isfield(ad.data{ad.control.spectra.active},'axes') ...
                && isfield(ad.data{ad.control.spectra.active}.axes,'x') ...
                && isfield(ad.data{ad.control.spectra.active}.axes.x,'values') ...
                && not (isempty(ad.data{ad.control.spectra.active}.axes.x.values)))
            x = ad.data{ad.control.spectra.active}.axes.x.values;
        end
        if (isfield(ad.data{ad.control.spectra.active},'axes') ...
                && isfield(ad.data{ad.control.spectra.active}.axes,'y') ...
                && isfield(ad.data{ad.control.spectra.active}.axes.y,'values') ...
                && not (isempty(ad.data{ad.control.spectra.active}.axes.y.values)))
            y = ad.data{ad.control.spectra.active}.axes.y.values;
        end
        
        switch position
            case 'xindex'
                value = round(str2double(get(source,'String')));
                if (value > length(x)) value = length(x); end
                if (value < 1) value = 1; end
                ad.data{ad.control.spectra.active}.display.position.x = ...
                    value;
            case 'xunit'
                value = str2double(get(source,'String'));
                if (value < x(1)) value = x(1); end
                if (value > x(end)) value = x(end); end
                ad.data{ad.control.spectra.active}.display.position.x = ...
                    interp1(x,[1:length(x)],value,'nearest');
            case 'yindex'
                value = round(str2double(get(source,'String')));
                if (value > length(y)) value = length(y); end
                if (value < 1) value = 1; end
                ad.data{ad.control.spectra.active}.display.position.y = ...
                    value;
            case 'yunit'
                value = str2double(get(source,'String'));
                if (value < y(1)) value = y(1); end
                if (value > y(end)) value = y(end); end
                ad.data{ad.control.spectra.active}.display.position.y = ...
                    interp1(y,1:length(y),value,'nearest');
            otherwise
                return;
        end
        
        % Update appdata of main window
        setappdata(mainWindow,'data',ad.data);
        
        % Update slider values display
        updateSliderPanel()

        %Update main axis
        updateAxes();
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function showposition_checkbox_Callback(source,~)
    try
        mainWindow = guiGetWindowHandle(mfilename);
        % Get appdata from AVG GUI
        ad = getappdata(mainWindow);
        
        ad.control.axis.position = get(source,'Value');
        
        % Set appdata from AVG GUI
        setappdata(mainWindow,'control',ad.control);
        
        % Update display
        updateAxes();
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function area_edit_Callback(source,~,position)
    try
        if isempty(position)
            return;
        end
        
        % If value is empty or NaN after conversion to numeric, restore
        % previous entry and return
        if isempty(get(source,'String')) || ...
                isnan(str2double(get(source,'String')))
            % Update slider panel
            updateAveragePanel();
            return;
        end
        
        % Get appdata of AVG GUI
        mainWindow = guiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);
        
        % Get handles of main window
        gh = guihandles(mainWindow);
        
        % Make code lines shorter and code easier to read
        active = ad.control.spectra.active;
        
        % Be as robust as possible: if there is no axes, default is indices
        [y,x] = size(ad.data{active}.data);
        x = linspace(1,x,x);
        y = linspace(1,y,y);
        if (isfield(ad.data{active},'axes') ...
                && isfield(ad.data{active}.axes,'x') ...
                && isfield(ad.data{active}.axes.x,'values') ...
                && not (isempty(ad.data{active}.axes.x.values)))
            x = ad.data{active}.axes.x.values;
        end
        if (isfield(ad.data{active},'axes') ...
                && isfield(ad.data{active}.axes,'y') ...
                && isfield(ad.data{active}.axes.y,'values') ...
                && not (isempty(ad.data{active}.axes.y.values)))
            y = ad.data{active}.axes.y.values;
        end
        
        if strcmpi(ad.avg.dimension,'x')
            dim = x;
        else
            dim = y;
        end
        
        switch position
            case 'startindex'
                value = round(str2double(get(source,'String')));
                if (value > length(dim)) value = length(dim); end
                if (value < 1) value = 1; end
                ad.data{active}.avg.start = value;
                % Set stop value not overlapping
                if ad.data{active}.avg.start > ad.data{active}.avg.stop
                    % Check whether start + delta > length(dim)
                    if (ad.data{active}.avg.start + ad.data{active}.avg.delta > length(dim))
                        ad.data{active}.avg.stop = length(dim);
                        ad.data{active}.avg.delta = ...
                            ad.data{active}.avg.stop-ad.data{active}.avg.start;
                    else
                        ad.data{active}.avg.stop = ...
                            ad.data{active}.avg.start+ad.data{active}.avg.delta;
                    end
                end
                % Set delta value
                ad.data{active}.avg.delta = ...
                    ad.data{active}.avg.stop-ad.data{active}.avg.start;
            case 'startunit'
                value = str2double(get(source,'String'));
                if (value < dim(1)) value = dim(1); end
                if (value > dim(end)) value = dim(end); end
                ad.data{active}.avg.start = ...
                    interp1(...
                    dim,1:length(dim),...
                    value,...
                    'nearest'...
                    );
                % Set stop value not overlapping
                if ad.data{active}.avg.start > ad.data{active}.avg.stop
                    % Check whether start + delta > length(dim)
                    if (ad.data{active}.avg.start + ad.data{active}.avg.delta > length(dim))
                        ad.data{active}.avg.stop = length(dim);
                        ad.data{active}.avg.delta = ...
                            ad.data{active}.avg.stop-ad.data{active}.avg.start;
                    else
                        ad.data{active}.avg.stop = ...
                            ad.data{active}.avg.start+ad.data{active}.avg.delta;
                    end
                end
                % Set delta value
                ad.data{active}.avg.delta = ...
                    ad.data{active}.avg.stop-ad.data{active}.avg.start;
            case 'stopindex'
                value = round(str2double(get(source,'String')));
                if (value > length(dim)) value = length(dim); end
                if (value < 1) value = 1; end
                ad.data{active}.avg.stop = value;
                % Set start value not overlapping
                if ad.data{active}.avg.start > ad.data{active}.avg.stop
                    % Check whether stop - delta < length(dim)
                    if (ad.data{active}.avg.stop - ad.data{active}.avg.delta < 1)
                        ad.data{active}.avg.start = 1;
                        ad.data{active}.avg.delta = ...
                            ad.data{active}.avg.stop-ad.data{active}.avg.start;
                    else
                        ad.data{active}.avg.start = ...
                            ad.data{active}.avg.stop-ad.data{active}.avg.delta;
                    end
                end
                % Set delta value
                ad.data{active}.avg.delta = ...
                    ad.data{active}.avg.stop-ad.data{active}.avg.start;
            case 'stopunit'
                value = str2double(get(source,'String'));
                if (value < dim(1)) value = dim(1); end
                if (value > dim(end)) value = dim(end); end
                ad.data{active}.avg.stop = ...
                    interp1(...
                    dim,1:length(dim),...
                    value,...
                    'nearest'...
                    );
                % Set start value not overlapping
                if ad.data{active}.avg.start > ad.data{active}.avg.stop
                    % Check whether stop - delta < length(dim)
                    if (ad.data{active}.avg.stop - ad.data{active}.avg.delta < 1)
                        ad.data{active}.avg.start = 1;
                        ad.data{active}.avg.delta = ...
                            ad.data{active}.avg.stop-ad.data{active}.avg.start;
                    else
                        ad.data{active}.avg.start = ...
                            ad.data{active}.avg.stop-ad.data{active}.avg.delta;
                    end
                end
                % Set delta value
                ad.data{active}.avg.delta = ...
                    ad.data{active}.avg.stop-ad.data{active}.avg.start;
            case 'deltaindex'
                value = round(str2double(get(source,'String')));
                if (value > length(dim)) value = length(dim); end
                if (value < 0) value = 0; end
                ad.data{active}.avg.delta = value;
                % Check whether start + delta > length(dim)
                if (ad.data{active}.avg.start + ad.data{active}.avg.delta > length(dim))
                    ad.data{active}.avg.stop = length(dim);
                    ad.data{active}.avg.delta = ...
                        ad.data{active}.avg.stop-ad.data{active}.avg.start;
                else
                    ad.data{active}.avg.stop = ...
                        ad.data{active}.avg.start+ad.data{active}.avg.delta;
                end
            case 'deltaunit'
                value = str2double(get(source,'String'));
                if (value < 0) value = 0; end
                if (value > dim(end)-dim(1)) value = dim(end)-dim(1); end
                ad.data{active}.avg.delta = ...
                    interp1(...
                    0+abs(dim(2)-dim(1)):abs(dim(2)-dim(1)):(abs(dim(2)-dim(1))*(length(dim))),...
                    1:length(dim),...
                    value,...
                    'nearest'...
                    );
                if isnan(ad.data{active}.avg.delta)
                    ad.data{active}.avg.delta = 0;
                end
                % Check whether start + delta > length(dim)
                if (ad.data{active}.avg.start + ad.data{active}.avg.delta > length(dim))
                    ad.data{active}.avg.stop = length(dim);
                    ad.data{active}.avg.delta = ...
                        ad.data{active}.avg.stop-ad.data{active}.avg.start;
                else
                    ad.data{active}.avg.stop = ...
                        ad.data{active}.avg.start+ad.data{active}.avg.delta;
                end
            otherwise
                disp('trEPRgui_AVGwindow() : area_edit_Callback() : Unknown action');
                disp(action);
                return;
        end
        
        % Set dimension and label for current averaging
        ad.data{active}.avg.dimension = ad.avg.dimension;
        ad.data{active}.avg.label = get(gh.label_edit,'String');
        
        % Update appdata of main window
        setappdata(mainWindow,'data',ad.data);
        
        % Update average panel display
        updateAveragePanel();

        %Update main axis
        updateAxes();
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function visible_panel_listbox_Callback(source,~)
    try
        mainWindow = guiGetWindowHandle(mfilename);
        % Get appdata from AVG GUI
        ad = getappdata(mainWindow);
        
        ad.control.spectra.active = ad.control.spectra.visible(...
            get(source,'Value')...
            );
        
        % Set appdata from AVG GUI
        setappdata(mainWindow,'control',ad.control);
        
        updateAxes();
        update_position_display();
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function edit_Callback(source,~,field)
    try
        if isempty(field)
            return;
        end
        
        % Get appdata of main window
        mainWindow = guiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);
        
        value = get(source,'String');
        
        switch field
            case 'npts_clipping'
                value = str2double(value);
                xdim = size(ad.data{ad.control.spectra.active}.data,2);
                if isnan(value) || (value > xdim) || (value < 0)
                    set(source,'string',...
                        num2str(ad.control.axis.ignorefirstn));
                else
                    ad.control.axis.ignorefirstn = value;
                    setappdata(mainWindow,'control',ad.control)
                end
                updateAxes();
                return;
            case 'bgfit_ignorepoints'
                value = str2double(value);
                xdim = size(ad.data{ad.control.spectra.active}.data,2);
                if isnan(value) || (value > xdim) || (value < 0)
                    set(source,'string',...
                        num2str(ad.control.axis.ignorefirstn));
                else
                    ad.fft.bgfit.ignorefirstn = value;
                    setappdata(mainWindow,'fft',ad.fft)
                end
                updateAxes();
            otherwise
                return;
        end
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function popupmenu_Callback(source,~,action)
    try
        if isempty(action)
            return;
        end
        
        % Get appdata of main window
        mainWindow = guiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);

        values = cellstr(get(source,'String'));
        value = values{get(source,'Value')};
        
        switch action
            case 'dimension'
                ad.avg.dimension = value(1);
                setappdata(mainWindow,'avg',ad.avg);
                % Reset average values (safest way to prevent trouble)
                pushbutton_Callback('','','averageClear');
                updateAxes();
            case 'avglineWidth'
                ad.avg.line.width = str2double(value(1));
                setappdata(mainWindow,'avg',ad.avg);
                updateAxes();
            case 'avglineStyle'
                % Get line style
                [~,ind] = max(strcmp(value,lineStyles(:,1)));
                ad.avg.line.style = char(lineStyles(ind,2));
                setappdata(mainWindow,'avg',ad.avg);
                updateAxes();
            otherwise
                disp('Unknown popupmenu')
                disp(action);
        end

    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end  
end

function togglebutton_Callback(source,~,action)
    try
        if isempty(action)
            return;
        end
        
        % Get appdata of main window
        mainWindow = guiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);

        % Get state of toggle button
        value = get(source,'Value');
        
        % For those togglebuttons who do more complicated stuff
        % Toggle button
        if value % If toggle switched ON
            switch lower(action)
                case 'measurepick'
                    % Switch off zoom
                    zoom(mainWindow,'off');
                    % Set pointer callback functions
                    set(mainWindow,...
                        'WindowButtonMotionFcn',@trackPointer);
                    set(mainWindow,...
                        'WindowButtonDownFcn',@switchMeasurePointer);
                    return;
                case 'zoom'
                    % Reset pointer callback functions
                    set(mainWindow,'WindowButtonMotionFcn','');
                    set(mainWindow,'WindowButtonDownFcn','');
                    % Reset other zoom toggle button
                    zoom(mainWindow,'on');
                    return;
                case 'gridx'
                    ad.control.axis.grid.x = 'on';
                    setappdata(mainWindow,'control',ad.control);
                    updateAxes();
                    return;
                case 'gridy'
                    ad.control.axis.grid.y = 'on';
                    setappdata(mainWindow,'control',ad.control);
                    updateAxes();
                    return;
                case 'gridminor'
                    ad.control.axis.grid.minor = 'on';
                    setappdata(mainWindow,'control',ad.control);
                    updateAxes();
                    return;
                case 'gridzero'
                    ad.control.axis.grid.zero = value;
                    setappdata(mainWindow,'control',ad.control);
                    updateAxes();
                    return;
                otherwise
                    disp('trEPRgui_fitwindow: togglebutton_Callback(): Unknown action');
                    disp(action);
                    return;
            end
        else % If toggle button switched OFF
            switch lower(action)
                case 'measurepick'
                    % Reset pointer callback functions
                    set(mainWindow,'WindowButtonMotionFcn','');
                    set(mainWindow,'WindowButtonDownFcn','');
                    return;
                case 'zoom'
                    zoom(mainWindow,'off');
                    return;
                case 'gridx'
                    ad.control.axis.grid.x = 'off';
                    setappdata(mainWindow,'control',ad.control);
                    updateAxes();
                    return;
                case 'gridy'
                    ad.control.axis.grid.y = 'off';
                    setappdata(mainWindow,'control',ad.control);
                    updateAxes();
                    return;
                case 'gridminor'
                    ad.control.axis.grid.minor = 'off';
                    setappdata(mainWindow,'control',ad.control);
                    updateAxes();
                    return;
                case 'gridzero'
                    ad.control.axis.grid.zero = value;
                    setappdata(mainWindow,'control',ad.control);
                    updateAxes();
                    return;
                otherwise
                    disp('trEPRgui_fitwindow: togglebutton_Callback(): Unknown action');
                    disp(action);
                    return;
            end
        end
        
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end
        
function pushbutton_Callback(~,~,action)
    try
        if isempty(action)
            return;
        end
        
        % Get appdata of main window
        mainWindow = guiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);
        
        % Get handles of main window
        gh = guihandles(mainWindow);

        switch action
            case 'showMaximum'
                % If no datasets are loaded, return
                if isempty(ad.data)
                    return;
                end
                [~,ximax] = max(max(ad.data{ad.control.spectra.active}.data));
                [~,yimax] = max(ad.data{ad.control.spectra.active}.data(:,ximax));
                ad.data{ad.control.spectra.active}.display.position.x = ximax;
                ad.data{ad.control.spectra.active}.display.position.y = yimax;
                
                % Set appdata from AVG GUI
                setappdata(mainWindow,'data',ad.data);
                
                updateAxes();
                update_position_display();
                return;
            case 'zoomReset'
                zoom(mainWindow,'off');
                set(gh.zoom_x_togglebutton,'Value',0);
                set(gh.zoom_xy_togglebutton,'Value',0);
                updateAxes();
                return;
            case'measureClear'
                set(gh.measure_pick_togglebutton,'Value',0);
                set(gh.measure_x_index_edit,'String','0');
                set(gh.measure_x_unit_edit,'String','0');
                set(gh.measure_y_index_edit,'String','0');
                set(gh.measure_y_unit_edit,'String','0');
                return;
            case 'averageClear'
                ad.data{ad.control.spectra.active}.avg.start = 1;
                ad.data{ad.control.spectra.active}.avg.stop = 1;
                ad.data{ad.control.spectra.active}.avg.delta = 0;
                setappdata(mainWindow,'data',ad.data);
                updateAveragePanel();
                updateAxes();
                return;
            case 'Average'
                if strcmp('x',ad.avg.dimension)
                    ad.control.axis.displayType = '1D along y';
                else
                    ad.control.axis.displayType = '1D along x';
                end
                setappdata(mainWindow,'control',ad.control);
                updateAxes();
                return;
            case 'averageareaColourPalette'
                ad.avg.area.patch.color = uisetcolor(...
                    ad.avg.area.patch.color,'Set average area colour');
                setappdata(mainWindow,'avg',ad.avg);
                updateSettingsPanel();
                updateAxes();
                return;
            case 'avglineColourPalette'
                ad.avg.line.color = uisetcolor(...
                    ad.avg.line.color,'Set averaged data line colour');
                setappdata(mainWindow,'avg',ad.avg);
                updateSettingsPanel();
                updateAxes();
                return;
            case 'SettingsDefault'
                updateSettingsPanel('defaults');
                updateAxes();
                return;
            case 'Apply'
                % Check for every dataset whether an average has been
                % performed (avg.delta ~= 0) and if so, do proper AVG
                ad.avgdata = cell(0);
                for k=1:length(ad.data)
                    if ad.data{k}.avg.delta
                        avgparams = struct(...
                            'dimension',ad.data{k}.avg.dimension,...
                            'start',ad.data{k}.avg.start,...
                            'stop',ad.data{k}.avg.stop,...
                            'label',ad.data{k}.avg.label...
                            );
                        ad.avgdata{end+1} = trEPRAVG(ad.data{k},avgparams);
                    end
                end
                setappdata(mainWindow,'avgdata',ad.avgdata);
                return;
            case 'Discard'
                if isempty(ad.avgdata)
                    return;
                end
                answer = questdlg(...
                    {'Discard averaging for all datasets or'...
                    'only for the datasetcurrently selected? '},...
                    'Question: Discard all or only current...',...
                    'All','Current','Cancel',...
                    'Cancel');
                switch answer
                    case 'All'
                        for k=1:length(ad.data)
                            ad.data{k}.avg.start = 1;
                            ad.data{k}.avg.stop = 1;
                            ad.data{k}.avg.delta = 0;
                        end
                        setappdata(mainWindow,'data',ad.data);
                        % Remove all datasets from ad.avgdata
                        ad.avgdata = cell(0);
                        setappdata(mainWindow,'avgdata',ad.avgdata);
                        updateAveragePanel();
                        updateAxes();
                    case 'Current'
                        ad.data{ad.control.spectra.active}.avg.start = 1;
                        ad.data{ad.control.spectra.active}.avg.stop = 1;
                        ad.data{ad.control.spectra.active}.avg.delta = 0;
                        setappdata(mainWindow,'data',ad.data);
                        updateAveragePanel();
                        updateAxes();
                        for k=length(ad.avgdata):-1:1
                            if strcmp(ad.avgdata{k}.label,...
                                    get(gh.label_edit,'String'))
                                ad.avgdata(k) = [];
                            end
                        setappdata(mainWindow,'avgdata',ad.avgdata);
                        end
                    case 'Cancel'
                        return;
                    otherwise
                        return;
                end
                return;
            case 'Close'
                if ~isempty(ad.avgdata)
                    msgStr = {...
                        ['Trying to append averaged data as new '...
                        'datasets to main GUI.']...
                        };
                    add2status(msgStr);
                    % Return BLC data to main GUI
                    for k=1:length(ad.avgdata)
                        % Remove avg field in data structure
                        if isfield(ad.avgdata{k},'avg')
                            ad.avgdata{k} = rmfield(ad.avgdata{k},'avg');
                        end
                        % Remove display field in data structure
                        if isfield(ad.avgdata{k},'display')
                            ad.avgdata{k} = rmfield(ad.avgdata{k},'display');
                        end
                        status = appendDatasetToMainGUI(...
                            ad.avgdata{k},...
                            'modified',true);
                        if status
                            disp('Hmm... some problems with appending baseline-correced dataset to main GUI.');
                        end
                    end
                end
                msgStr = 'AVG GUI window closed.';
                add2status(msgStr);

                % Look for AVG GUI Help window and if its there, close as
                % well
                hHelpWindow = findobj('Tag','trEPRgui_AVG_helpwindow');
                if ishandle(hHelpWindow)
                    delete(hHelpWindow);
                end
                delete(guiGetWindowHandle(mfilename));
            otherwise
                disp('trEPRgui_fitwindow: pushbutton_Callback(): Unknown action');
                disp(action);
                return;
        end
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function slider_Callback(source,~,action)
    try
        if isempty(action)
            return;
        end
        
        % Get appdata of main window
        mainWindow = guiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);
        
        % Get handles of main window
        gh = guihandles(mainWindow);

        % Get state of toggle button
        value = get(source,'Value');
        
        switch lower(action)
            case 'averageareaalpha'
                set(gh.averageareasettings_alpha_edit,'String',num2str(value));
                ad.avg.area.patch.alpha = value;
                setappdata(mainWindow,'avg',ad.avg);
                updateAxes();
            otherwise
                disp('trEPRgui_fitwindow: slider_Callback(): Unknown action');
                disp(action);
        end
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end
    
function displaytype_popupmenu_Callback(source,~)
    try
        % Get appdata of main window
        ad = getappdata(hMainFigure);

        % Get handles of main window
        gh = guihandles(hMainFigure);
        
        displayTypes = cellstr(get(source,'String'));
        ad.control.axis.displayType = displayTypes{get(source,'Value')};
        
        % Set appdata of main window
        setappdata(hMainFigure,'control',ad.control);

        % If no datasets are loaded, return
        % NOTE: As we return only here, the display type gets set for later
        if isempty(ad.data)
            return;
        end

        switch ad.control.axis.displayType
            case '2D plot'
                set(gh.position_slider,'Enable','Off');
                updateAxes()
            case '1D along x'
                set(gh.position_slider,'Enable','On');
                updateAxes()
            case '1D along y'
                set(gh.position_slider,'Enable','On');
                updateAxes()
            otherwise
                % unknown
                return;
        end
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function keypress_Callback(src,evt)
    try
        if isempty(evt.Character) && isempty(evt.Key)
            % In case "Character" is the empty string, i.e. only modifier key
            % was pressed...
            return;
        end
        mainWindow = guiGetWindowHandle(mfilename);
        % Get appdata from AVG GUI
        ad = getappdata(mainWindow);

        if ~isempty(evt.Modifier)
            if (strcmpi(evt.Modifier{1},'command')) || ...
                    (strcmpi(evt.Modifier{1},'control'))
                switch evt.Key
                    case 'w'
                        pushbutton_Callback(src,evt,'Close')
                        return;
                    case '1'
                        switchPanel('Display');
                        return;
                    case '2'
                        switchPanel('Average');
                        return;
                    case '3'
                        switchPanel('Settings');
                        return;
                    case 'x'
                        ad.control.axis.displayType = '1D along x';
                        setappdata(mainWindow,'control',ad.control);
                        updateAxes();
                        return;
                    case 'y'
                        ad.control.axis.displayType = '1D along y';
                        setappdata(mainWindow,'control',ad.control);
                        updateAxes();
                        return;
                    case 'z'
                        ad.control.axis.displayType = '2D plot';
                        setappdata(mainWindow,'control',ad.control);
                        updateAxes();
                        return;
                end
            end
        end
        switch evt.Key
            case 'f1'
                trEPRgui_AVG_helpwindow();
                return;
            otherwise
%                 disp(evt);
%                 fprintf('       Caller: %i\n\n',src);
                return;
        end
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Utility functions
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function switchPanel(panelName)
    try
        panels = [pp1 pp2 pp3];
        buttons = [tb1 tb2 tb3];
        switch panelName
            case 'Display'
                set(panels,'Visible','off');
                set(buttons,'Value',0);
                set(pp1,'Visible','on');
                set(tb1,'Value',1);
            case 'Average'
                set(panels,'Visible','off');
                set(buttons,'Value',0);
                set(pp2,'Visible','on');
                set(tb2,'Value',1);
                updateAveragePanel();
            case 'Settings'
                set(panels,'Visible','off');
                set(buttons,'Value',0);
                set(pp3,'Visible','on');
                set(tb3,'Value',1);
                updateSettingsPanel();
            otherwise
        end
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end 
end

function updateSliderPanel()
    try
        mainWindow = guiGetWindowHandle(mfilename);
        % Get appdata of AVG GUI
        ad = getappdata(mainWindow);
        
        % Get handles of AVG GUI
        gh = guihandles(mainWindow);
        
        if ~isfield(ad,'data') || isempty(ad.data)
            set(findall(...
                allchild(gh.sliderposition_panel),...
                'Style','Edit'),'String','1');
            return;
        end

        % Get dimensions and axes of current dataset
        [y,x] = size(ad.data{ad.control.spectra.active}.data);
        x = linspace(1,x,x);
        y = linspace(1,y,y);
        if (isfield(ad.data{ad.control.spectra.active},'axes') ...
                && isfield(ad.data{ad.control.spectra.active}.axes,'x') ...
                && isfield(ad.data{ad.control.spectra.active}.axes.x,'values') ...
                && not (isempty(ad.data{ad.control.spectra.active}.axes.x.values)))
            x = ad.data{ad.control.spectra.active}.axes.x.values;
        end
        if (isfield(ad.data{ad.control.spectra.active},'axes') ...
                && isfield(ad.data{ad.control.spectra.active}.axes,'y') ...
                && isfield(ad.data{ad.control.spectra.active}.axes.y,'values') ...
                && not (isempty(ad.data{ad.control.spectra.active}.axes.y.values)))
            y = ad.data{ad.control.spectra.active}.axes.y.values;
        end
        % In case that we loaded 1D data...
        if isscalar(x)
            x = [x x+1];
        end
        if isscalar(y)
            y = [y y+1];
        end
        
        % update position panel
        set(...
            gh.sliderposition_x_index_edit,...
            'string',...
            ad.data{ad.control.spectra.active}.display.position.x...
            );
        set(...
            gh.sliderposition_x_unit_edit,...
            'string',...
            x(ad.data{ad.control.spectra.active}.display.position.x)...
            );
        set(...
            gh.sliderposition_y_index_edit,...
            'string',...
            ad.data{ad.control.spectra.active}.display.position.y...
            );
        set(...
            gh.sliderposition_y_unit_edit,...
            'string',...
            y(ad.data{ad.control.spectra.active}.display.position.y)...
            );
    catch exception
        try
            msgstr = ['an exception occurred. '...
                'the bug reporter should have been opened'];
            add2status(msgstr);
        catch exception2
            exception = addcause(exception2, exception);
            disp(msgstr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % if even displaying the bug report window fails...
            exception = addcause(exception3, exception);
            throw(exception);
        end
    end
end

function updateAveragePanel()
    try
        mainWindow = guiGetWindowHandle(mfilename);
        % Get appdata of AVG GUI
        ad = getappdata(mainWindow);
        
        % Get handles of AVG GUI
        gh = guihandles(mainWindow);
        
        if ~isfield(ad,'data') || isempty(ad.data)
            set(findall(...
                allchild(gh.sliderposition_panel),...
                'Style','Edit'),'String','1');
            return;
        end

        % Make codelines shorter and easier to read
        active = ad.control.spectra.active;
        
        % Set label field
        if isempty(ad.data{active}.avg.label)
            ad.data{active}.avg.label = sprintf('%s (AVG, %s)',...
                ad.data{active}.label,ad.avg.dimension);
        end
        set(gh.label_edit,'String',ad.data{active}.avg.label);
        
        % Get dimensions and axes of current dataset
        [y,x] = size(ad.data{active}.data);
        x = linspace(1,x,x);
        y = linspace(1,y,y);
        if (isfield(ad.data{active},'axes') ...
                && isfield(ad.data{active}.axes,'x') ...
                && isfield(ad.data{active}.axes.x,'values') ...
                && not (isempty(ad.data{active}.axes.x.values)))
            x = ad.data{active}.axes.x.values;
        end
        if (isfield(ad.data{active},'axes') ...
                && isfield(ad.data{active}.axes,'y') ...
                && isfield(ad.data{active}.axes.y,'values') ...
                && not (isempty(ad.data{active}.axes.y.values)))
            y = ad.data{active}.axes.y.values;
        end
        % In case that we loaded 1D data...
        if isscalar(x)
            x = [x x+1];
        end
        if isscalar(y)
            y = [y y+1];
        end
        
        % update position panel
        set(...
            gh.average_start_index_edit,...
            'string',...
            ad.data{active}.avg.start...
            );
        set(...
            gh.average_stop_index_edit,...
            'string',...
            ad.data{active}.avg.stop...
            );
        set(...
            gh.average_delta_index_edit,...
            'string',...
            ad.data{active}.avg.delta...
            );

        if strcmpi(ad.avg.dimension,'x')
            set(gh.average_start_unit_edit,...
                'string',num2str(x(ad.data{active}.avg.start))...
                );
            set(gh.average_stop_unit_edit,...
                'string',num2str(x(ad.data{active}.avg.stop))...
                );
            set(gh.average_delta_unit_edit,...
                'string',num2str(abs(x(2)-x(1))*ad.data{active}.avg.delta)...
                );
        else
            set(gh.average_start_unit_edit,...
                'string',num2str(y(ad.data{active}.avg.start))...
                );
            set(gh.average_stop_unit_edit,...
                'string',num2str(y(ad.data{active}.avg.stop))...
                );
            set(gh.average_delta_unit_edit,...
                'string',num2str(abs(y(2)-y(1))*ad.data{active}.avg.delta)...
                );
        end
    catch exception
        try
            msgstr = ['an exception occurred. '...
                'the bug reporter should have been opened'];
            add2status(msgstr);
        catch exception2
            exception = addcause(exception2, exception);
            disp(msgstr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % if even displaying the bug report window fails...
            exception = addcause(exception3, exception);
            throw(exception);
        end
    end
end

function updateSettingsPanel(varargin)
    try
        mainWindow = guiGetWindowHandle(mfilename);
        % Get appdata from AVG GUI
        ad = getappdata(mainWindow);

        % Get handles from main window
        gh = guidata(mainWindow);
               
        if nargin && strcmpi('defaults',varargin{1})
            % Reset display settings
            ad.control.axis.grid.x = ad.configuration.axis.grid.x;
            ad.control.axis.grid.y = ad.configuration.axis.grid.y;
            ad.control.axis.grid.minor = ad.configuration.axis.grid.minor;
            ad.control.axis.grid.zero = ad.configuration.axis.grid.zero;
            % Reset avg settings
            ad.avg.area.patch.color = ad.configuration.avg.area.patch.color;
            ad.avg.area.patch.alpha = ad.configuration.avg.area.patch.alpha;
            ad.avg.line.color = ad.configuration.avg.line.color;
            ad.avg.line.width = ad.configuration.avg.line.width;
            ad.avg.line.style = ad.configuration.avg.line.style;
            setappdata(mainWindow,'avg',ad.avg);
            setappdata(mainWindow,'control',ad.control);
        end
        
        if strcmpi('on',ad.control.axis.grid.x)
            set(gh.grid_x_togglebutton,'Value',1);
        else
            set(gh.grid_x_togglebutton,'Value',0);
        end
        if strcmpi('on',ad.control.axis.grid.y)
            set(gh.grid_y_togglebutton,'Value',1);
        else
            set(gh.grid_y_togglebutton,'Value',0);
        end
        if strcmpi('on',ad.control.axis.grid.minor)
            set(gh.grid_minor_togglebutton,'Value',1);
        else
            set(gh.grid_minor_togglebutton,'Value',0);
        end
        set(gh.grid_zero_togglebutton,'Value',ad.control.axis.grid.zero);
        
        set(gh.averageareasettings_coloursample_text,'Background',...
            ad.avg.area.patch.color);
        set(gh.averageareasettings_alpha_edit,'String',...
            num2str(ad.avg.area.patch.alpha));
        set(gh.averageareasettings_alpha_slider,'Value',...
            ad.avg.area.patch.alpha);
        
        set(gh.avglinesettings_coloursample_text,'Background',...
            ad.avg.line.color);
        % Line width
        values = cellstr(get(gh.avglinesettings_width_popupmenu,'String'));
        [~,ind] = max(strcmp(sprintf('%i px',ad.avg.line.width),values));
        set(gh.avglinesettings_width_popupmenu,'Value',ind)
        % Line style
        values = cellstr(get(gh.avglinesettings_style_popupmenu,'String'));
        [~,ind] = max(strcmp(ad.avg.line.style,lineStyles(:,2)));
        [~,ind2] = max(strcmp(lineStyles(ind,2),values));
        set(gh.avglinesettings_style_popupmenu,'Value',ind2)

    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end 
end
        
function updateSpectra()
    try
        mainWindow = guiGetWindowHandle(mfilename);
        % Get appdata from AVG GUI
        ad = getappdata(mainWindow);
        
        if isempty(ad.data) || isempty(ad.control.spectra.visible)
            return;
        end
        
        % Get handle for visible spectra listbox
        gh = guidata(mainWindow);
        visLbox = gh.visible_panel_listbox;
        
        % Get indices of invisible spectra
        vis = ad.control.spectra.visible;
        
        % Get names for display in listbox
        labels = cell(0);
        for k=1:length(vis)
            labels{k} = ad.data{vis(k)}.label;
        end
        
        % Update status display
        set(visLbox,'String',labels);
        if (get(visLbox,'Value')>length(vis))
            set(visLbox,'Value',length(vis));
        end
        if ((get(visLbox,'Value')==0) && ~isempty(vis))
            set(visLbox,'Value',1);
        end
        
        % Highlight currently active
        if ad.control.spectra.active
            set(visLbox,'Value',find(vis==ad.control.spectra.active));
        end
        
        % Change enable status of pushbuttons and other elements
        set(gh.slider_panel_maximum_pushbutton,'Enable','on');

    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end 
    
end

function update_position_display()
    mainWindow = guiGetWindowHandle(mfilename);
    % Get appdata from AVG GUI
    ad = getappdata(mainWindow);

    if isempty(ad.data) || isempty(ad.control.spectra.visible)
        return;
    end
    
    % Get handle for visible spectra listbox
    gh = guidata(mainWindow);

    try
        % Set position in time edit boxes
        set(gh.sliderposition_y_index_edit,...
            'String',...
            num2str(ad.data{ad.control.spectra.active}.display.position.y));
        % Set unit
        [y,~] = size(ad.data{ad.control.spectra.active}.data);
        y = linspace(1,y,y);
        if (isfield(ad.data{ad.control.spectra.active},'axes') ...
                && isfield(ad.data{ad.control.spectra.active}.axes,'y') ...
                && isfield(ad.data{ad.control.spectra.active}.axes.y,'values') ...
                && not (isempty(ad.data{ad.control.spectra.active}.axes.y.values)))
            y = ad.data{ad.control.spectra.active}.axes.y.values;
        end
        set(gh.sliderposition_y_unit_edit,...
            'String',...
            num2str(y(ad.data{ad.control.spectra.active}.display.position.y)));
        
        % Set position in time edit boxes
        set(gh.sliderposition_x_index_edit,...
            'String',...
            num2str(ad.data{ad.control.spectra.active}.display.position.x));
        % Set unit
        [~,x] = size(ad.data{ad.control.spectra.active}.data);
        x = linspace(1,x,x);
        if (isfield(ad.data{ad.control.spectra.active},'axes') ...
                && isfield(ad.data{ad.control.spectra.active}.axes,'x') ...
                && isfield(ad.data{ad.control.spectra.active}.axes.x,'values') ...
                && not (isempty(ad.data{ad.control.spectra.active}.axes.x.values)))
            x = ad.data{ad.control.spectra.active}.axes.x.values;
        end
        set(gh.sliderposition_x_unit_edit,...
            'String',...
            num2str(x(ad.data{ad.control.spectra.active}.display.position.x)));
        
        % Set slider
        switch ad.control.axis.displayType
            case '1D along x'
                set(gh.position_slider,'Value',...
                    ad.data{ad.control.spectra.active}.display.position.y);
            case '1D along y'
                set(gh.position_slider,'Value',...
                    ad.data{ad.control.spectra.active}.display.position.x);
        end
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end 
end


function updateAxes()
    mainWindow = guiGetWindowHandle(mfilename);
    % Get appdata from AVG GUI
    ad = getappdata(mainWindow);

    % Get handles from main window
    gh = guidata(mainWindow);
    
    if isempty(ad.data) || isempty(ad.control.spectra.visible)
%         % Display splash
%         try
%             set(hMainFigure,'CurrentAxes',hPlotAxes);
%             splash = imread(fullfile(trEPRinfo('dir'),...
%                 'GUI','private','splashes','fitGUISplash.png'),'png');
%             image(splash);
%             axis off          % Remove axis ticks and numbers
%         catch exception
%             % If this happens, something probably more serious went wrong...
%             throw(exception);
%         end
        return;
    end
    
    try
        % Set displayType popupmenu
        displayTypes = cellstr(...
            get(gh.displaytype_popupmenu,'String'));
        [~,index] = max(strcmp(ad.control.axis.displayType,displayTypes));
        set(gh.displaytype_popupmenu,'Value',index);
        
        data = ad.data{ad.control.spectra.active}.data;
        xvalues = ad.data{ad.control.spectra.active}.axes.x.values;
        xmeasure = ad.data{ad.control.spectra.active}.axes.x.measure;
        xunit = ad.data{ad.control.spectra.active}.axes.x.unit;
        yvalues = ad.data{ad.control.spectra.active}.axes.y.values;
        ymeasure = ad.data{ad.control.spectra.active}.axes.y.measure;
        yunit = ad.data{ad.control.spectra.active}.axes.y.unit;

        [y,x] = size(data);
        
        cla(gh.axis,'reset');
        axes(gh.axis);
        switch ad.control.axis.displayType
            case '2D plot'
                % Disable position slider
                set(gh.position_slider,'Enable','off');

                z = [ min(min(data)) max(max(data)) ];
                hold on;
                % Plot 2D data
                imagesc(...
                    xvalues,...
                    yvalues,...
                    data,'Parent',gh.axis);
                if ad.control.axis.position
                    % Plot red line with position in time
                    plot(gh.axis,...
                        [xvalues(ad.data{ad.control.spectra.active}.display.position.x) ...
                        xvalues(ad.data{ad.control.spectra.active}.display.position.x)],...
                        [yvalues(1) yvalues(end)],...
                        'r-');
                    % Plot red line with position in field
                    plot(gh.axis,...
                        [xvalues(1) xvalues(end)],...
                        [yvalues(ad.data{ad.control.spectra.active}.display.position.y) ...
                        yvalues(ad.data{ad.control.spectra.active}.display.position.y)],...
                        'r-');
                end
                hold off;
                set(gh.axis,'XLim',[...
                    xvalues(1) ...
                    xvalues(end)]);
                set(gh.axis,'YLim',[...
                    yvalues(1) ...
                    yvalues(end)]);
                set(gh.axis,'YDir','normal');
                set(gh.axis,'CLim',z);
                xlabel(gh.axis,sprintf('{\\it %s} / %s',xmeasure,xunit));
                ylabel(gh.axis,sprintf('{\\it %s} / %s',ymeasure,yunit));

            case '1D along x'
                % Enable position slider only if second axis has more than one value
                if (y>1)
                    set(gh.position_slider,...
                        'Min',1,'Max',y,...
                        'Value',...
                        ad.data{ad.control.spectra.active}.display.position.y,...
                        'SliderStep',[1/(y-1) 10/(y-1)],...
                        'Enable','on');
                else
                    set(gh.position_slider,...
                        'Enable','off'...
                        );
                end
                % Plot time trace at given position in spectrum
                hold on;
                plot(gh.axis,...
                    xvalues,...
                    data(...
                    ad.data{ad.control.spectra.active}.display.position.y,:),...
                    'k-');
                set(gh.axis,'XLim',[xvalues(1) xvalues(end)]);
                z = [ min(min(data)) max(max(data)) ];
                ZLim = [z(1)-((z(2)-z(1))/20) z(2)+((z(2)-z(1))/20)];
                set(gh.axis,'YLim',ZLim);
                if ad.control.axis.position
                    % Plot red line with position in time
                    plot(gh.axis,...
                        [xvalues(ad.data{ad.control.spectra.active}.display.position.x) ...
                        xvalues(ad.data{ad.control.spectra.active}.display.position.x)],...
                        ZLim,...
                        'r-');
                end
                if ad.data{ad.control.spectra.active}.avg.delta && strcmpi(ad.avg.dimension,'y')
                    % Plot average spectrum
                    plot(gh.axis,...
                        xvalues,...
                        mean(data(ad.data{ad.control.spectra.active}.avg.start:...
                        ad.data{ad.control.spectra.active}.avg.stop,:),1),...
                        'LineStyle',ad.avg.line.style,...
                        'Color',ad.avg.line.color,...
                        'LineWidth',ad.avg.line.width);
                end
                hold off;
                if (ad.control.axis.grid.zero)
                    line(...
                        [xvalues(1) xvalues(end)],...
                        [0 0],...
                        'Color',[0.5 0.5 0.5],'LineStyle','--',...
                        'Parent',gh.axis);
                end
                set(gh.axis,'YTickLabel',[]);
                xlabel(gh.axis,sprintf('{\\it %s} / %s',xmeasure,xunit));
                if ad.data{ad.control.spectra.active}.avg.delta && strcmpi(ad.avg.dimension,'x')
                    ylim = get(gh.axis,'YLim');
                    patch(...
                        'XData',[...
                        xvalues(ad.data{ad.control.spectra.active}.avg.start) ...
                        xvalues(ad.data{ad.control.spectra.active}.avg.start)...
                        xvalues(ad.data{ad.control.spectra.active}.avg.stop) ...
                        xvalues(ad.data{ad.control.spectra.active}.avg.stop)],...
                        'YData',[ylim(1) ylim(end) ylim(end) ylim(1)],...
                        'ZData',[0 0 0 0],...
                        'EdgeColor',ad.avg.area.patch.edge,...
                        'FaceColor',ad.avg.area.patch.color,...
                        'FaceAlpha',ad.avg.area.patch.alpha,...
                        'Parent',gh.axis);
                end
            case '1D along y'
                % Enable position slider only if second axis has more than one value
                if (x>1)
                    set(gh.position_slider,...
                        'Min',1,'Max',x,...
                        'Value',...
                        ad.data{ad.control.spectra.active}.display.position.x,...
                        'SliderStep',[1/(x-1) 10/(x-1)],...
                        'Enable','on');
                else
                    set(gh.position_slider,...
                        'Enable','off'...
                        );
                end
                % Plot B0 spectrum at given position in time
                hold on;
                % Including this (redundand) line here seems to prevent
                % Matlab from crashing due to stupid errors (plot: vectors
                % must be of same length) when being too fast with the
                % sliders.
                plot(gh.axis,...
                    yvalues,...
                    data(...
                    :,ad.data{ad.control.spectra.active}.display.position.x),...
                    'k-');
                set(gh.axis,'XLim',[yvalues(1) yvalues(end)]);
                z = [ min(min(data)) max(max(data)) ];
                ZLim = [z(1)-((z(2)-z(1))/20) z(2)+((z(2)-z(1))/20)];
                set(gh.axis,'YLim',ZLim);
                if ad.control.axis.position
                    % Plot red line with position in time
                    plot(gh.axis,...
                        [yvalues(ad.data{ad.control.spectra.active}.display.position.y) ...
                        yvalues(ad.data{ad.control.spectra.active}.display.position.y)],...
                        ZLim,...
                        'r-');
                end
                if ad.data{ad.control.spectra.active}.avg.delta && strcmpi(ad.avg.dimension,'x')
                    % Plot average spectrum
                    plot(gh.axis,...
                        yvalues,...
                        mean(data(:,ad.data{ad.control.spectra.active}.avg.start:ad.data{ad.control.spectra.active}.avg.stop),2),...
                        'LineStyle',ad.avg.line.style,...
                        'Color',ad.avg.line.color,...
                        'LineWidth',ad.avg.line.width);
                end
                hold off;
                if (ad.control.axis.grid.zero)
                    line(...
                        [yvalues(1) yvalues(end)],...
                        [0 0],...
                        'Color',[0.5 0.5 0.5],'LineStyle','--',...
                        'Parent',gh.axis);
                end
                set(gh.axis,'YTickLabel',[]);
                xlabel(gh.axis,sprintf('{\\it %s} / %s',ymeasure,yunit));
                if ad.data{ad.control.spectra.active}.avg.delta && strcmpi(ad.avg.dimension,'y')
                    ylim = get(gh.axis,'YLim');
                    patch(...
                        'XData',[...
                        yvalues(ad.data{ad.control.spectra.active}.avg.start)...
                        yvalues(ad.data{ad.control.spectra.active}.avg.start)...
                        yvalues(ad.data{ad.control.spectra.active}.avg.stop)...
                        yvalues(ad.data{ad.control.spectra.active}.avg.stop)],...
                        'YData',[ylim(1) ylim(end) ylim(end) ylim(1)],...
                        'ZData',[0 0 0 0],...
                        'EdgeColor',ad.avg.area.patch.edge,...
                        'FaceColor',ad.avg.area.patch.color,...
                        'FaceAlpha',ad.avg.area.patch.alpha,...
                        'Parent',gh.axis);
                end
        end
        
        switch ad.avg.dimension
            case 'x'
                cla(gh.axis2,'reset');
                hold on;
                plot(gh.axis2,...
                    xvalues,...
                    data(...
                    ad.data{ad.control.spectra.active}.display.position.y,:),...
                    'k-');
                if (ad.control.axis.grid.zero)
                    line(...
                        [xvalues(1) xvalues(end)],...
                        [0 0],...
                        'Color',[0.5 0.5 0.5],'LineStyle','--',...
                        'Parent',gh.axis2);
                end
                hold off;
                set(gh.axis2,'YTickLabel',[]);
                set(gh.axis2,'XLim',[xvalues(1) xvalues(end)]);
                set(gh.axis2,'YTickLabel',[]);
                xlabel(gh.axis2,sprintf('{\\it %s} / %s',xmeasure,xunit));
                if ad.data{ad.control.spectra.active}.avg.delta
                    ylim = get(gh.axis2,'YLim');
                    patch(...
                        'XData',[...
                        xvalues(ad.data{ad.control.spectra.active}.avg.start)...
                        xvalues(ad.data{ad.control.spectra.active}.avg.start)...
                        xvalues(ad.data{ad.control.spectra.active}.avg.stop)...
                        xvalues(ad.data{ad.control.spectra.active}.avg.stop)],...
                        'YData',[ylim(1) ylim(end) ylim(end) ylim(1)],...
                        'ZData',[0 0 0 0],...
                        'EdgeColor',ad.avg.area.patch.edge,...
                        'FaceColor',ad.avg.area.patch.color,...
                        'FaceAlpha',ad.avg.area.patch.alpha,...
                        'Parent',gh.axis2);
                end
            case 'y'
                cla(gh.axis2,'reset');
                hold on;
                plot(gh.axis2,...
                    yvalues,...
                    data(...
                    :,ad.data{ad.control.spectra.active}.display.position.x),...
                    'k-');
                if (ad.control.axis.grid.zero)
                    line(...
                        [yvalues(1) yvalues(end)],...
                        [0 0],...
                        'Color',[0.5 0.5 0.5],'LineStyle','--',...
                        'Parent',gh.axis2);
                end
                hold off;
                set(gh.axis2,'YTickLabel',[]);
                set(gh.axis2,'XLim',[yvalues(1) yvalues(end)]);
                set(gh.axis2,'YTickLabel',[]);
                xlabel(gh.axis2,sprintf('{\\it %s} / %s',ymeasure,yunit));
                if ad.data{ad.control.spectra.active}.avg.delta
                    ylim = get(gh.axis2,'YLim');
                    patch(...
                        'XData',[...
                        yvalues(ad.data{ad.control.spectra.active}.avg.start)...
                        yvalues(ad.data{ad.control.spectra.active}.avg.start)...
                        yvalues(ad.data{ad.control.spectra.active}.avg.stop)...
                        yvalues(ad.data{ad.control.spectra.active}.avg.stop)],...
                        'YData',[ylim(1) ylim(end) ylim(end) ylim(1)],...
                        'ZData',[0 0 0 0],...
                        'EdgeColor',ad.avg.area.patch.edge,...
                        'FaceColor',ad.avg.area.patch.color,...
                        'FaceAlpha',ad.avg.area.patch.alpha,...
                        'Parent',gh.axis2);
                end
            otherwise
                disp('trEPRgui_AVGwindow : updateAxis(): Unknown AVG dimension');
                disp(ad.avg.dimension);
        end
        
        % Set grid for main axis
        set(gh.axis,'XGrid',ad.control.axis.grid.x);
        set(gh.axis,'YGrid',ad.control.axis.grid.y);
        if (isequal(ad.control.axis.grid.x,'on'))
            set(gh.axis,'XMinorGrid',ad.control.axis.grid.minor);
        end
        if (isequal(ad.control.axis.grid.y,'on'))
            set(gh.axis,'YMinorGrid',ad.control.axis.grid.minor);
        end
        % Set grid for auxilliary axis
        set(gh.axis2,'XGrid',ad.control.axis.grid.x);
        set(gh.axis2,'YGrid',ad.control.axis.grid.y);
        if (isequal(ad.control.axis.grid.x,'on'))
            set(gh.axis2,'XMinorGrid',ad.control.axis.grid.minor);
        end
        if (isequal(ad.control.axis.grid.y,'on'))
            set(gh.axis2,'YMinorGrid',ad.control.axis.grid.minor);
        end        

    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end 
end

function switchMeasurePointer(~,~)
    try
        % Get appdata of main window
        mainWindow = guiGetWindowHandle(mfilename);
        ad = getappdata(mainWindow);

        % Get handles from main window
        gh = guidata(mainWindow);
        
        % Reset pointer callback functions
        set(mainWindow,'WindowButtonMotionFcn','');
        set(mainWindow,'WindowButtonDownFcn','');
        
        % Reset pointer
        set(mainWindow,'Pointer','arrow');
        
        % Switch off togglebuttons
        set(gh.measure_pick_togglebutton,'Value',0);
        
        % Update appdata of main window
        setappdata(mainWindow,'control',ad.control);
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

function trackPointer(varargin)
    try
        mainWindow = guiGetWindowHandle(mfilename);
        
        % Get handles of mainwindow
        gh = guihandles(mainWindow);
        
        % Get appdata of main window
        ad = getappdata(mainWindow);
        
        % Get position of mainAxis (axis coordinates)
        axisPosition = get(hPlotAxes,'Position');
        % Coordinates are "real" x,y pairs relative to the mainWindow
        axisCoordinates = [ ...
            axisPosition(1)-1 ...
            axisPosition(2)-1 ...
            axisPosition(1)+axisPosition(3) ...
            axisPosition(2)+axisPosition(4) ...
            ];
        
        % Get current position of pointer
        pointerPosition = get(mainWindow,'CurrentPoint');
        
        % Create CData for custom pointer
        pointerShapeCData = ones(16)*nan;
        pointerShapeCData([1 8 15],[1:6 10:15]) = 1;
        pointerShapeCData([1:6 10:15],[1 8 15]) = 1;
        
        % As long as we are inside the mainAxis
        if pointerPosition(1) > axisCoordinates(1) && ...
                pointerPosition(1) < axisCoordinates(3) && ...
                pointerPosition(2) > axisCoordinates(2) && ...
                pointerPosition(2) < axisCoordinates(4)
            
            % Get pointer position coordinates relative to axis
            pointerPositionInAxis = ...
                pointerPosition - [axisCoordinates(1) axisCoordinates(2)];
            
            % Set pointer shape
            %set(mainWindow,'Pointer','crosshair');
            set(mainWindow,'Pointer','custom',...
                'PointerShapeCData',pointerShapeCData,...
                'PointerShapeHotSpot',[9 9]);
            
            % Get xdata and ydata of currently active dataset
            if (strcmp(ad.control.axis.displayType,'2D plot'))
                xdata = get(...
                    findobj('Parent',hPlotAxes,'-and','Type','image'),...
                    'xdata');
                ydata = get(...
                    findobj('Parent',hPlotAxes,'-and','Type','image'),...
                    'ydata');
            else
                xdata = get(...
                    findobj('Parent',hPlotAxes,'-and','Type','line'),...
                    'xdata');
                ydata = get(...
                    findobj('Parent',hPlotAxes,'-and','Type','line'),...
                    'ydata');
            end
    
            % Get id of current spectrum (to shorten lines afterwards)
            active = ad.control.spectra.active;
            
            % If we are in 1D display mode and there are more than one spectrum
            % and/or a zero line displayed
            if ( (strcmp(ad.control.axis.displayType,'1D along x') || ...
                    strcmp(ad.control.axis.displayType,'1D along y')) ) && ...
                    (iscell(xdata) && iscell(ydata))
                if ad.control.axis.grid.zero 
                    xdata = xdata{2};
                    ydata = ydata{2};
                else
                    xdata = xdata{1};
                    ydata = ydata{1};
                end
            end
            
            % Create vectors with indices for xdata and ydata
            % Those are used in case of axis limits <> dataset limits
            xindex = 1 : length(xdata);
            yindex = 1 : length(ydata);
            
            % Handle situation that axis limits and dataset limits don't coincide.
            % Therefore, in case of the dataset being smaller than axis limits, pad
            % it with the first/last value to fill xdata/ydata, respectively.
            % Alternatively, the dataset being larger than axis limits, cut out
            % part from the dataset that's currently displayed.
            % To find out how many points to pad, use interp1 to get ending points
            % of dataset in current axis.
            
            % IMPORTANT: DON'T MESS UP THE CODE BELOW, IF YOU'RE NOT ABSOLUTELY
            % SURE WHAT YOU'RE DOING. I SPEND A WHOLE DAY FIGHTING WITH IT UNTIL IT
            % WORKED SOMEWHAT FINE.
            
            % Get x and y limits of axes
            axisXLim = get(hPlotAxes,'XLim');
            axisYLim = get(hPlotAxes,'YLim');
            % Get x and y limits of currently active dataset
            datasetXLim = [ xdata(1) xdata(end) ];
            datasetYLim = [ ydata(1) ydata(end) ];
            
            % Get dataset limits in axis coordinates
            if (axisXLim(1) > datasetXLim(1))
                % In case dataset is larger than current axis limits
                
                % Need to come up with a good variable name for that, but it looks
                % like we get here the position of the axis limit in the data
                % vector, what would be very useful
                newDatasetXmin=interp1(...
                    linspace(datasetXLim(1),datasetXLim(2),length(xdata)),...
                    linspace(1,length(xdata),length(xdata)),...
                    axisXLim(1),'nearest');
                newXdata = xdata(newDatasetXmin:end);
                newXindex = xindex(newDatasetXmin:end);
            else
                newDatasetXmin=interp1(...
                    linspace(axisXLim(1),axisXLim(2),length(xdata)),...
                    linspace(1,length(xdata),length(xdata)),...
                    xdata(1),'nearest');
                newXdata = [ones(1,newDatasetXmin)*xdata(1) xdata];
                newXindex = [ones(1,newDatasetXmin)*xindex(1) xindex];
            end
            if (axisXLim(2) < datasetXLim(2))
                % In case dataset is larger than current axis limits
                
                % Need to come up with a good variable name for that, but it looks
                % like we get here the position of the axis limit in the data
                % vector, what would be very useful
                newDatasetXmax=interp1(...
                    linspace(datasetXLim(1),datasetXLim(end),length(xdata)),...
                    linspace(1,length(xdata),length(xdata)),...
                    axisXLim(2),'nearest');
                newXdata = newXdata(1:end-(length(xdata)-newDatasetXmax));
                newXindex = newXindex(1:end-(length(xindex)-newDatasetXmax));
            else
                newDatasetXmax=interp1(...
                    linspace(axisXLim(1),axisXLim(2),length(xdata)),...
                    linspace(1,length(xdata),length(xdata)),...
                    xdata(end),'nearest');
                newXdata = [newXdata ones(1,length(xdata)-newDatasetXmax)*xdata(end)];
                newXindex = [newXindex ones(1,length(xindex)-newDatasetXmax)*xindex(end)];
            end
            
            if (strcmp(ad.control.axis.displayType,'2D plot'))
                if (axisYLim(1) > datasetYLim(1))
                    % In case dataset is larger than current axis limits
                    
                    % Need to come up with a good variable name for that, but it looks
                    % like we get here the position of the axis limit in the data
                    % vector, what would be very useful
                    newDatasetYmin=interp1(...
                        linspace(datasetYLim(1),datasetYLim(2),length(ydata)),...
                        linspace(1,length(ydata),length(ydata)),...
                        axisYLim(1),'nearest');
                    newYdata = ydata(newDatasetYmin:end);
                    newYindex = yindex(newDatasetYmin:end);
                else
                    newDatasetYmin=interp1(...
                        linspace(axisYLim(1),axisYLim(2),length(ydata)),...
                        linspace(1,length(ydata),length(ydata)),...
                        ydata(1),'nearest');
                    newYdata = [ones(1,newDatasetYmin)*ydata(1) ydata];
                    newYindex = [ones(1,newDatasetYmin)*yindex(1) yindex];
                end
                if (axisYLim(2) < datasetYLim(2))
                    % In case dataset is larger than current axis limits
                    
                    % Need to come up with a good variable name for that, but it looks
                    % like we get here the position of the axis limit in the data
                    % vector, what would be very useful
                    newDatasetYmax=interp1(...
                        linspace(datasetYLim(1),datasetYLim(end),length(ydata)),...
                        linspace(1,length(ydata),length(ydata)),...
                        axisYLim(2),'nearest');
                    newYdata = newYdata(1:end-(length(ydata)-newDatasetYmax));
                    newYindex = newYindex(1:end-(length(yindex)-newDatasetYmax));
                else
                    newDatasetYmax=interp1(...
                        linspace(axisYLim(1),axisYLim(2),length(ydata)),...
                        linspace(1,length(ydata),length(ydata)),...
                        ydata(end),'nearest');
                    newYdata = [newYdata ones(1,length(ydata)-newDatasetYmax)*ydata(end)];
                    newYindex = [newYindex ones(1,length(yindex)-newDatasetYmax)*yindex(end)];
                end
            end
            
            switch ad.control.axis.displayType
                case '2D plot'
                    % Get index of current point in dataset
                    indx=interp1(...
                        linspace(1,axisPosition(3),length(newXdata)),...
                        newXindex,...
                        pointerPositionInAxis(1),'nearest');
                    indy=interp1(...
                        linspace(1,axisPosition(4),length(newYdata)),...
                        newYindex,...
                        pointerPositionInAxis(2),'nearest');
                case '1D along x'
                    % Get index of current point in dataset
                    indx=interp1(...
                        linspace(1,axisPosition(3),length(newXdata)),...
                        newXindex,...
                        pointerPositionInAxis(1),'nearest');
                    indy=indx;
                case '1D along y'
                    % Get index of current point in dataset
                    indx=interp1(...
                        linspace(1,axisPosition(3),length(newXdata)),...
                        newXindex,...
                        pointerPositionInAxis(1),'nearest');
                    indy=indx;
                otherwise
                    % That shall never happen!
                    disp('trackPointer(): Unrecognised displayType');
                    disp(ad.control.axis.displayType);
                    set(mainWindow,'Pointer','arrow');
                    return;
            end
            
            % Get value (in units) of current point in dataset
            valx = xdata(indx);
            valy = ydata(indy);
            
            % Set display
            % Update display of first point
            set(gh.measure_x_index_edit,'String',num2str(indx));
            set(gh.measure_x_unit_edit,'String',num2str(valx));
            set(gh.measure_y_index_edit,'String',num2str(indy));
            set(gh.measure_y_unit_edit,'String',num2str(valy));
        else
            set(mainWindow,'Pointer','arrow');
        end
        
    catch exception
        try
            msgStr = ['An exception occurred. '...
                'The bug reporter should have been opened'];
            add2status(msgStr);
        catch exception2
            exception = addCause(exception2, exception);
            disp(msgStr);
        end
        try
            trEPRgui_bugreportwindow(exception);
        catch exception3
            % If even displaying the bug report window fails...
            exception = addCause(exception3, exception);
            throw(exception);
        end
    end
end

end